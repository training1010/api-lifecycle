<?xml version="1.0" encoding="UTF-8"?>
<exp:Export Version="3.0"
    xmlns:L7p="http://www.layer7tech.com/ws/policy"
    xmlns:exp="http://www.layer7tech.com/ws/policy/export" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <exp:References/>
    <wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
        <wsp:All wsp:Usage="Required">
            <L7p:HardcodedResponse>
                <L7p:Base64ResponseBody stringValue="LyohIGpRdWVyeSB2MS44LjMganF1ZXJ5LmNvbSB8IGpxdWVyeS5vcmcvbGljZW5zZSAqLwooZnVuY3Rpb24oZSwgdCkgewogICAgZnVuY3Rpb24gXyhlKSB7CiAgICAgICAgdmFyIHQgPSBNW2VdID0ge307CiAgICAgICAgcmV0dXJuIHYuZWFjaChlLnNwbGl0KHkpLCBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgIHRbbl0gPSAhMAogICAgICAgIH0pLCB0CiAgICB9CgogICAgZnVuY3Rpb24gSChlLCBuLCByKSB7CiAgICAgICAgaWYgKHIgPT09IHQgJiYgZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICB2YXIgaSA9ICJkYXRhLSIgKyBuLnJlcGxhY2UoUCwgIi0kMSIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHIgPSBlLmdldEF0dHJpYnV0ZShpKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHIgPSByID09PSAidHJ1ZSIgPyAhMCA6IHIgPT09ICJmYWxzZSIgPyAhMSA6IHIgPT09ICJudWxsIiA/IG51bGwgOiArciArICIiID09PSByID8gK3IgOiBELnRlc3QocikgPyB2LnBhcnNlSlNPTihyKSA6IHIKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHMpIHt9CiAgICAgICAgICAgICAgICB2LmRhdGEoZSwgbiwgcikKICAgICAgICAgICAgfSBlbHNlIHIgPSB0CiAgICAgICAgfQogICAgICAgIHJldHVybiByCiAgICB9CgogICAgZnVuY3Rpb24gQihlKSB7CiAgICAgICAgdmFyIHQ7CiAgICAgICAgZm9yICh0IGluIGUpIHsKICAgICAgICAgICAgaWYgKHQgPT09ICJkYXRhIiAmJiB2LmlzRW1wdHlPYmplY3QoZVt0XSkpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAodCAhPT0gInRvSlNPTiIpIHJldHVybiAhMQogICAgICAgIH0KICAgICAgICByZXR1cm4gITAKICAgIH0KCiAgICBmdW5jdGlvbiBldCgpIHsKICAgICAgICByZXR1cm4gITEKICAgIH0KCiAgICBmdW5jdGlvbiB0dCgpIHsKICAgICAgICByZXR1cm4gITAKICAgIH0KCiAgICBmdW5jdGlvbiB1dChlKSB7CiAgICAgICAgcmV0dXJuICFlIHx8ICFlLnBhcmVudE5vZGUgfHwgZS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMQogICAgfQoKICAgIGZ1bmN0aW9uIGF0KGUsIHQpIHsKICAgICAgICBkbyBlID0gZVt0XTsgd2hpbGUgKGUgJiYgZS5ub2RlVHlwZSAhPT0gMSk7CiAgICAgICAgcmV0dXJuIGUKICAgIH0KCiAgICBmdW5jdGlvbiBmdChlLCB0LCBuKSB7CiAgICAgICAgdCA9IHQgfHwgMDsKICAgICAgICBpZiAodi5pc0Z1bmN0aW9uKHQpKSByZXR1cm4gdi5ncmVwKGUsIGZ1bmN0aW9uKGUsIHIpIHsKICAgICAgICAgICAgdmFyIGkgPSAhIXQuY2FsbChlLCByLCBlKTsKICAgICAgICAgICAgcmV0dXJuIGkgPT09IG4KICAgICAgICB9KTsKICAgICAgICBpZiAodC5ub2RlVHlwZSkgcmV0dXJuIHYuZ3JlcChlLCBmdW5jdGlvbihlLCByKSB7CiAgICAgICAgICAgIHJldHVybiBlID09PSB0ID09PSBuCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHR5cGVvZiB0ID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHZhciByID0gdi5ncmVwKGUsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlLm5vZGVUeXBlID09PSAxCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoaXQudGVzdCh0KSkgcmV0dXJuIHYuZmlsdGVyKHQsIHIsICFuKTsKICAgICAgICAgICAgdCA9IHYuZmlsdGVyKHQsIHIpCiAgICAgICAgfQogICAgICAgIHJldHVybiB2LmdyZXAoZSwgZnVuY3Rpb24oZSwgcikgewogICAgICAgICAgICByZXR1cm4gdi5pbkFycmF5KGUsIHQpID49IDAgPT09IG4KICAgICAgICB9KQogICAgfQoKICAgIGZ1bmN0aW9uIGx0KGUpIHsKICAgICAgICB2YXIgdCA9IGN0LnNwbGl0KCJ8IiksCiAgICAgICAgICAgIG4gPSBlLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICBpZiAobi5jcmVhdGVFbGVtZW50KQogICAgICAgICAgICB3aGlsZSAodC5sZW5ndGgpIG4uY3JlYXRlRWxlbWVudCh0LnBvcCgpKTsKICAgICAgICByZXR1cm4gbgogICAgfQoKICAgIGZ1bmN0aW9uIEx0KGUsIHQpIHsKICAgICAgICByZXR1cm4gZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0KVswXSB8fCBlLmFwcGVuZENoaWxkKGUub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHQpKQogICAgfQoKICAgIGZ1bmN0aW9uIEF0KGUsIHQpIHsKICAgICAgICBpZiAodC5ub2RlVHlwZSAhPT0gMSB8fCAhdi5oYXNEYXRhKGUpKSByZXR1cm47CiAgICAgICAgdmFyIG4sIHIsIGksIHMgPSB2Ll9kYXRhKGUpLAogICAgICAgICAgICBvID0gdi5fZGF0YSh0LCBzKSwKICAgICAgICAgICAgdSA9IHMuZXZlbnRzOwogICAgICAgIGlmICh1KSB7CiAgICAgICAgICAgIGRlbGV0ZSBvLmhhbmRsZSwgby5ldmVudHMgPSB7fTsKICAgICAgICAgICAgZm9yIChuIGluIHUpCiAgICAgICAgICAgICAgICBmb3IgKHIgPSAwLCBpID0gdVtuXS5sZW5ndGg7IHIgPCBpOyByKyspIHYuZXZlbnQuYWRkKHQsIG4sIHVbbl1bcl0pCiAgICAgICAgfQogICAgICAgIG8uZGF0YSAmJiAoby5kYXRhID0gdi5leHRlbmQoe30sIG8uZGF0YSkpCiAgICB9CgogICAgZnVuY3Rpb24gT3QoZSwgdCkgewogICAgICAgIHZhciBuOwogICAgICAgIGlmICh0Lm5vZGVUeXBlICE9PSAxKSByZXR1cm47CiAgICAgICAgdC5jbGVhckF0dHJpYnV0ZXMgJiYgdC5jbGVhckF0dHJpYnV0ZXMoKSwgdC5tZXJnZUF0dHJpYnV0ZXMgJiYgdC5tZXJnZUF0dHJpYnV0ZXMoZSksIG4gPSB0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksIG4gPT09ICJvYmplY3QiID8gKHQucGFyZW50Tm9kZSAmJiAodC5vdXRlckhUTUwgPSBlLm91dGVySFRNTCksIHYuc3VwcG9ydC5odG1sNUNsb25lICYmIGUuaW5uZXJIVE1MICYmICF2LnRyaW0odC5pbm5lckhUTUwpICYmICh0LmlubmVySFRNTCA9IGUuaW5uZXJIVE1MKSkgOiBuID09PSAiaW5wdXQiICYmIEV0LnRlc3QoZS50eXBlKSA/ICh0LmRlZmF1bHRDaGVja2VkID0gdC5jaGVja2VkID0gZS5jaGVja2VkLCB0LnZhbHVlICE9PSBlLnZhbHVlICYmICh0LnZhbHVlID0gZS52YWx1ZSkpIDogbiA9PT0gIm9wdGlvbiIgPyB0LnNlbGVjdGVkID0gZS5kZWZhdWx0U2VsZWN0ZWQgOiBuID09PSAiaW5wdXQiIHx8IG4gPT09ICJ0ZXh0YXJlYSIgPyB0LmRlZmF1bHRWYWx1ZSA9IGUuZGVmYXVsdFZhbHVlIDogbiA9PT0gInNjcmlwdCIgJiYgdC50ZXh0ICE9PSBlLnRleHQgJiYgKHQudGV4dCA9IGUudGV4dCksIHQucmVtb3ZlQXR0cmlidXRlKHYuZXhwYW5kbykKICAgIH0KCiAgICBmdW5jdGlvbiBNdChlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBlLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9ICJ1bmRlZmluZWQiID8gZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIDogdHlwZW9mIGUucXVlcnlTZWxlY3RvckFsbCAhPSAidW5kZWZpbmVkIiA/IGUucXVlcnlTZWxlY3RvckFsbCgiKiIpIDogW10KICAgIH0KCiAgICBmdW5jdGlvbiBfdChlKSB7CiAgICAgICAgRXQudGVzdChlLnR5cGUpICYmIChlLmRlZmF1bHRDaGVja2VkID0gZS5jaGVja2VkKQogICAgfQoKICAgIGZ1bmN0aW9uIFF0KGUsIHQpIHsKICAgICAgICBpZiAodCBpbiBlKSByZXR1cm4gdDsKICAgICAgICB2YXIgbiA9IHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0LnNsaWNlKDEpLAogICAgICAgICAgICByID0gdCwKICAgICAgICAgICAgaSA9IEp0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIHQgPSBKdFtpXSArIG47CiAgICAgICAgICAgIGlmICh0IGluIGUpIHJldHVybiB0CiAgICAgICAgfQogICAgICAgIHJldHVybiByCiAgICB9CgogICAgZnVuY3Rpb24gR3QoZSwgdCkgewogICAgICAgIHJldHVybiBlID0gdCB8fCBlLCB2LmNzcyhlLCAiZGlzcGxheSIpID09PSAibm9uZSIgfHwgIXYuY29udGFpbnMoZS5vd25lckRvY3VtZW50LCBlKQogICAgfQoKICAgIGZ1bmN0aW9uIFl0KGUsIHQpIHsKICAgICAgICB2YXIgbiwgciwgaSA9IFtdLAogICAgICAgICAgICBzID0gMCwKICAgICAgICAgICAgbyA9IGUubGVuZ3RoOwogICAgICAgIGZvciAoOyBzIDwgbzsgcysrKSB7CiAgICAgICAgICAgIG4gPSBlW3NdOwogICAgICAgICAgICBpZiAoIW4uc3R5bGUpIGNvbnRpbnVlOwogICAgICAgICAgICBpW3NdID0gdi5fZGF0YShuLCAib2xkZGlzcGxheSIpLCB0ID8gKCFpW3NdICYmIG4uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiICYmIChuLnN0eWxlLmRpc3BsYXkgPSAiIiksIG4uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgR3QobikgJiYgKGlbc10gPSB2Ll9kYXRhKG4sICJvbGRkaXNwbGF5Iiwgbm4obi5ub2RlTmFtZSkpKSkgOiAociA9IER0KG4sICJkaXNwbGF5IiksICFpW3NdICYmIHIgIT09ICJub25lIiAmJiB2Ll9kYXRhKG4sICJvbGRkaXNwbGF5IiwgcikpCiAgICAgICAgfQogICAgICAgIGZvciAocyA9IDA7IHMgPCBvOyBzKyspIHsKICAgICAgICAgICAgbiA9IGVbc107CiAgICAgICAgICAgIGlmICghbi5zdHlsZSkgY29udGludWU7CiAgICAgICAgICAgIGlmICghdCB8fCBuLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fCBuLnN0eWxlLmRpc3BsYXkgPT09ICIiKSBuLnN0eWxlLmRpc3BsYXkgPSB0ID8gaVtzXSB8fCAiIiA6ICJub25lIgogICAgICAgIH0KICAgICAgICByZXR1cm4gZQogICAgfQoKICAgIGZ1bmN0aW9uIFp0KGUsIHQsIG4pIHsKICAgICAgICB2YXIgciA9IFJ0LmV4ZWModCk7CiAgICAgICAgcmV0dXJuIHIgPyBNYXRoLm1heCgwLCByWzFdIC0gKG4gfHwgMCkpICsgKHJbMl0gfHwgInB4IikgOiB0CiAgICB9CgogICAgZnVuY3Rpb24gZW4oZSwgdCwgbiwgcikgewogICAgICAgIHZhciBpID0gbiA9PT0gKHIgPyAiYm9yZGVyIiA6ICJjb250ZW50IikgPyA0IDogdCA9PT0gIndpZHRoIiA/IDEgOiAwLAogICAgICAgICAgICBzID0gMDsKICAgICAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMikgbiA9PT0gIm1hcmdpbiIgJiYgKHMgKz0gdi5jc3MoZSwgbiArICR0W2ldLCAhMCkpLCByID8gKG4gPT09ICJjb250ZW50IiAmJiAocyAtPSBwYXJzZUZsb2F0KER0KGUsICJwYWRkaW5nIiArICR0W2ldKSkgfHwgMCksIG4gIT09ICJtYXJnaW4iICYmIChzIC09IHBhcnNlRmxvYXQoRHQoZSwgImJvcmRlciIgKyAkdFtpXSArICJXaWR0aCIpKSB8fCAwKSkgOiAocyArPSBwYXJzZUZsb2F0KER0KGUsICJwYWRkaW5nIiArICR0W2ldKSkgfHwgMCwgbiAhPT0gInBhZGRpbmciICYmIChzICs9IHBhcnNlRmxvYXQoRHQoZSwgImJvcmRlciIgKyAkdFtpXSArICJXaWR0aCIpKSB8fCAwKSk7CiAgICAgICAgcmV0dXJuIHMKICAgIH0KCiAgICBmdW5jdGlvbiB0bihlLCB0LCBuKSB7CiAgICAgICAgdmFyIHIgPSB0ID09PSAid2lkdGgiID8gZS5vZmZzZXRXaWR0aCA6IGUub2Zmc2V0SGVpZ2h0LAogICAgICAgICAgICBpID0gITAsCiAgICAgICAgICAgIHMgPSB2LnN1cHBvcnQuYm94U2l6aW5nICYmIHYuY3NzKGUsICJib3hTaXppbmciKSA9PT0gImJvcmRlci1ib3giOwogICAgICAgIGlmIChyIDw9IDAgfHwgciA9PSBudWxsKSB7CiAgICAgICAgICAgIHIgPSBEdChlLCB0KTsKICAgICAgICAgICAgaWYgKHIgPCAwIHx8IHIgPT0gbnVsbCkgciA9IGUuc3R5bGVbdF07CiAgICAgICAgICAgIGlmIChVdC50ZXN0KHIpKSByZXR1cm4gcjsKICAgICAgICAgICAgaSA9IHMgJiYgKHYuc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSB8fCByID09PSBlLnN0eWxlW3RdKSwgciA9IHBhcnNlRmxvYXQocikgfHwgMAogICAgICAgIH0KICAgICAgICByZXR1cm4gciArIGVuKGUsIHQsIG4gfHwgKHMgPyAiYm9yZGVyIiA6ICJjb250ZW50IiksIGkpICsgInB4IgogICAgfQoKICAgIGZ1bmN0aW9uIG5uKGUpIHsKICAgICAgICBpZiAoV3RbZV0pIHJldHVybiBXdFtlXTsKICAgICAgICB2YXIgdCA9IHYoIjwiICsgZSArICI+IikuYXBwZW5kVG8oaS5ib2R5KSwKICAgICAgICAgICAgbiA9IHQuY3NzKCJkaXNwbGF5Iik7CiAgICAgICAgdC5yZW1vdmUoKTsKICAgICAgICBpZiAobiA9PT0gIm5vbmUiIHx8IG4gPT09ICIiKSB7CiAgICAgICAgICAgIFB0ID0gaS5ib2R5LmFwcGVuZENoaWxkKFB0IHx8IHYuZXh0ZW5kKGkuY3JlYXRlRWxlbWVudCgiaWZyYW1lIiksIHsKICAgICAgICAgICAgICAgIGZyYW1lQm9yZGVyOiAwLAogICAgICAgICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IDAKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBpZiAoIUh0IHx8ICFQdC5jcmVhdGVFbGVtZW50KSBIdCA9IChQdC5jb250ZW50V2luZG93IHx8IFB0LmNvbnRlbnREb2N1bWVudCkuZG9jdW1lbnQsIEh0LndyaXRlKCI8IWRvY3R5cGUgaHRtbD48aHRtbD48Ym9keT4iKSwgSHQuY2xvc2UoKTsKICAgICAgICAgICAgdCA9IEh0LmJvZHkuYXBwZW5kQ2hpbGQoSHQuY3JlYXRlRWxlbWVudChlKSksIG4gPSBEdCh0LCAiZGlzcGxheSIpLCBpLmJvZHkucmVtb3ZlQ2hpbGQoUHQpCiAgICAgICAgfQogICAgICAgIHJldHVybiBXdFtlXSA9IG4sIG4KICAgIH0KCiAgICBmdW5jdGlvbiBmbihlLCB0LCBuLCByKSB7CiAgICAgICAgdmFyIGk7CiAgICAgICAgaWYgKHYuaXNBcnJheSh0KSkgdi5lYWNoKHQsIGZ1bmN0aW9uKHQsIGkpIHsKICAgICAgICAgICAgbiB8fCBzbi50ZXN0KGUpID8gcihlLCBpKSA6IGZuKGUgKyAiWyIgKyAodHlwZW9mIGkgPT0gIm9iamVjdCIgPyB0IDogIiIpICsgIl0iLCBpLCBuLCByKQogICAgICAgIH0pOwogICAgICAgIGVsc2UgaWYgKCFuICYmIHYudHlwZSh0KSA9PT0gIm9iamVjdCIpCiAgICAgICAgICAgIGZvciAoaSBpbiB0KSBmbihlICsgIlsiICsgaSArICJdIiwgdFtpXSwgbiwgcik7CiAgICAgICAgZWxzZSByKGUsIHQpCiAgICB9CgogICAgZnVuY3Rpb24gQ24oZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbih0LCBuKSB7CiAgICAgICAgICAgIHR5cGVvZiB0ICE9ICJzdHJpbmciICYmIChuID0gdCwgdCA9ICIqIik7CiAgICAgICAgICAgIHZhciByLCBpLCBzLCBvID0gdC50b0xvd2VyQ2FzZSgpLnNwbGl0KHkpLAogICAgICAgICAgICAgICAgdSA9IDAsCiAgICAgICAgICAgICAgICBhID0gby5sZW5ndGg7CiAgICAgICAgICAgIGlmICh2LmlzRnVuY3Rpb24obikpCiAgICAgICAgICAgICAgICBmb3IgKDsgdSA8IGE7IHUrKykgciA9IG9bdV0sIHMgPSAvXlwrLy50ZXN0KHIpLCBzICYmIChyID0gci5zdWJzdHIoMSkgfHwgIioiKSwgaSA9IGVbcl0gPSBlW3JdIHx8IFtdLCBpW3MgPyAidW5zaGlmdCIgOiAicHVzaCJdKG4pCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGtuKGUsIG4sIHIsIGksIHMsIG8pIHsKICAgICAgICBzID0gcyB8fCBuLmRhdGFUeXBlc1swXSwgbyA9IG8gfHwge30sIG9bc10gPSAhMDsKICAgICAgICB2YXIgdSwgYSA9IGVbc10sCiAgICAgICAgICAgIGYgPSAwLAogICAgICAgICAgICBsID0gYSA/IGEubGVuZ3RoIDogMCwKICAgICAgICAgICAgYyA9IGUgPT09IFNuOwogICAgICAgIGZvciAoOyBmIDwgbCAmJiAoYyB8fCAhdSk7IGYrKykgdSA9IGFbZl0obiwgciwgaSksIHR5cGVvZiB1ID09ICJzdHJpbmciICYmICghYyB8fCBvW3VdID8gdSA9IHQgOiAobi5kYXRhVHlwZXMudW5zaGlmdCh1KSwgdSA9IGtuKGUsIG4sIHIsIGksIHUsIG8pKSk7CiAgICAgICAgcmV0dXJuIChjIHx8ICF1KSAmJiAhb1siKiJdICYmICh1ID0ga24oZSwgbiwgciwgaSwgIioiLCBvKSksIHUKICAgIH0KCiAgICBmdW5jdGlvbiBMbihlLCBuKSB7CiAgICAgICAgdmFyIHIsIGksIHMgPSB2LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKICAgICAgICBmb3IgKHIgaW4gbikgbltyXSAhPT0gdCAmJiAoKHNbcl0gPyBlIDogaSB8fCAoaSA9IHt9KSlbcl0gPSBuW3JdKTsKICAgICAgICBpICYmIHYuZXh0ZW5kKCEwLCBlLCBpKQogICAgfQoKICAgIGZ1bmN0aW9uIEFuKGUsIG4sIHIpIHsKICAgICAgICB2YXIgaSwgcywgbywgdSwgYSA9IGUuY29udGVudHMsCiAgICAgICAgICAgIGYgPSBlLmRhdGFUeXBlcywKICAgICAgICAgICAgbCA9IGUucmVzcG9uc2VGaWVsZHM7CiAgICAgICAgZm9yIChzIGluIGwpIHMgaW4gciAmJiAobltsW3NdXSA9IHJbc10pOwogICAgICAgIHdoaWxlIChmWzBdID09PSAiKiIpIGYuc2hpZnQoKSwgaSA9PT0gdCAmJiAoaSA9IGUubWltZVR5cGUgfHwgbi5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIikpOwogICAgICAgIGlmIChpKQogICAgICAgICAgICBmb3IgKHMgaW4gYSkKICAgICAgICAgICAgICAgIGlmIChhW3NdICYmIGFbc10udGVzdChpKSkgewogICAgICAgICAgICAgICAgICAgIGYudW5zaGlmdChzKTsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgfQogICAgICAgIGlmIChmWzBdIGluIHIpIG8gPSBmWzBdOwogICAgICAgIGVsc2UgewogICAgICAgICAgICBmb3IgKHMgaW4gcikgewogICAgICAgICAgICAgICAgaWYgKCFmWzBdIHx8IGUuY29udmVydGVyc1tzICsgIiAiICsgZlswXV0pIHsKICAgICAgICAgICAgICAgICAgICBvID0gczsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdSB8fCAodSA9IHMpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbyA9IG8gfHwgdQogICAgICAgIH0KICAgICAgICBpZiAobykgcmV0dXJuIG8gIT09IGZbMF0gJiYgZi51bnNoaWZ0KG8pLCByW29dCiAgICB9CgogICAgZnVuY3Rpb24gT24oZSwgdCkgewogICAgICAgIHZhciBuLCByLCBpLCBzLCBvID0gZS5kYXRhVHlwZXMuc2xpY2UoKSwKICAgICAgICAgICAgdSA9IG9bMF0sCiAgICAgICAgICAgIGEgPSB7fSwKICAgICAgICAgICAgZiA9IDA7CiAgICAgICAgZS5kYXRhRmlsdGVyICYmICh0ID0gZS5kYXRhRmlsdGVyKHQsIGUuZGF0YVR5cGUpKTsKICAgICAgICBpZiAob1sxXSkKICAgICAgICAgICAgZm9yIChuIGluIGUuY29udmVydGVycykgYVtuLnRvTG93ZXJDYXNlKCldID0gZS5jb252ZXJ0ZXJzW25dOwogICAgICAgIGZvciAoOyBpID0gb1srK2ZdOykKICAgICAgICAgICAgaWYgKGkgIT09ICIqIikgewogICAgICAgICAgICAgICAgaWYgKHUgIT09ICIqIiAmJiB1ICE9PSBpKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IGFbdSArICIgIiArIGldIHx8IGFbIiogIiArIGldOwogICAgICAgICAgICAgICAgICAgIGlmICghbikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyIGluIGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSByLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc1sxXSA9PT0gaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBhW3UgKyAiICIgKyBzWzBdXSB8fCBhWyIqICIgKyBzWzBdXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuID09PSAhMCA/IG4gPSBhW3JdIDogYVtyXSAhPT0gITAgJiYgKGkgPSBzWzBdLCBvLnNwbGljZShmLS0sIDAsIGkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobiAhPT0gITApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuICYmIGVbInRocm93cyJdKSB0ID0gbih0KTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdCA9IG4odCkKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAobCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZTogInBhcnNlcmVycm9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogbiA/IGwgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyB1ICsgIiB0byAiICsgaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1ID0gaQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc3RhdGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgZGF0YTogdAogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBGbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IGUuWE1MSHR0cFJlcXVlc3QKICAgICAgICB9IGNhdGNoICh0KSB7fQogICAgfQoKICAgIGZ1bmN0aW9uIEluKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgZS5BY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpCiAgICAgICAgfSBjYXRjaCAodCkge30KICAgIH0KCiAgICBmdW5jdGlvbiAkbigpIHsKICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcW4gPSB0CiAgICAgICAgfSwgMCksIHFuID0gdi5ub3coKQogICAgfQoKICAgIGZ1bmN0aW9uIEpuKGUsIHQpIHsKICAgICAgICB2LmVhY2godCwgZnVuY3Rpb24odCwgbikgewogICAgICAgICAgICB2YXIgciA9IChWblt0XSB8fCBbXSkuY29uY2F0KFZuWyIqIl0pLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBzID0gci5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgczsgaSsrKQogICAgICAgICAgICAgICAgaWYgKHJbaV0uY2FsbChlLCB0LCBuKSkgcmV0dXJuCiAgICAgICAgfSkKICAgIH0KCiAgICBmdW5jdGlvbiBLbihlLCB0LCBuKSB7CiAgICAgICAgdmFyIHIsIGkgPSAwLAogICAgICAgICAgICBzID0gMCwKICAgICAgICAgICAgbyA9IFhuLmxlbmd0aCwKICAgICAgICAgICAgdSA9IHYuRGVmZXJyZWQoKS5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgYS5lbGVtCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHFuIHx8ICRuKCksCiAgICAgICAgICAgICAgICAgICAgbiA9IE1hdGgubWF4KDAsIGYuc3RhcnRUaW1lICsgZi5kdXJhdGlvbiAtIHQpLAogICAgICAgICAgICAgICAgICAgIHIgPSBuIC8gZi5kdXJhdGlvbiB8fCAwLAogICAgICAgICAgICAgICAgICAgIGkgPSAxIC0gciwKICAgICAgICAgICAgICAgICAgICBzID0gMCwKICAgICAgICAgICAgICAgICAgICBvID0gZi50d2VlbnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yICg7IHMgPCBvOyBzKyspIGYudHdlZW5zW3NdLnJ1bihpKTsKICAgICAgICAgICAgICAgIHJldHVybiB1Lm5vdGlmeVdpdGgoZSwgW2YsIGksIG5dKSwgaSA8IDEgJiYgbyA/IG4gOiAodS5yZXNvbHZlV2l0aChlLCBbZl0pLCAhMSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZiA9IHUucHJvbWlzZSh7CiAgICAgICAgICAgICAgICBlbGVtOiBlLAogICAgICAgICAgICAgICAgcHJvcHM6IHYuZXh0ZW5kKHt9LCB0KSwKICAgICAgICAgICAgICAgIG9wdHM6IHYuZXh0ZW5kKCEwLCB7CiAgICAgICAgICAgICAgICAgICAgc3BlY2lhbEVhc2luZzoge30KICAgICAgICAgICAgICAgIH0sIG4pLAogICAgICAgICAgICAgICAgb3JpZ2luYWxQcm9wZXJ0aWVzOiB0LAogICAgICAgICAgICAgICAgb3JpZ2luYWxPcHRpb25zOiBuLAogICAgICAgICAgICAgICAgc3RhcnRUaW1lOiBxbiB8fCAkbigpLAogICAgICAgICAgICAgICAgZHVyYXRpb246IG4uZHVyYXRpb24sCiAgICAgICAgICAgICAgICB0d2VlbnM6IFtdLAogICAgICAgICAgICAgICAgY3JlYXRlVHdlZW46IGZ1bmN0aW9uKHQsIG4sIHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHYuVHdlZW4oZSwgZi5vcHRzLCB0LCBuLCBmLm9wdHMuc3BlY2lhbEVhc2luZ1t0XSB8fCBmLm9wdHMuZWFzaW5nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZi50d2VlbnMucHVzaChpKSwgaQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN0b3A6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSB0ID8gZi50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgbiA8IHI7IG4rKykgZi50d2VlbnNbbl0ucnVuKDEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ID8gdS5yZXNvbHZlV2l0aChlLCBbZiwgdF0pIDogdS5yZWplY3RXaXRoKGUsIFtmLCB0XSksIHRoaXMKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGwgPSBmLnByb3BzOwogICAgICAgIFFuKGwsIGYub3B0cy5zcGVjaWFsRWFzaW5nKTsKICAgICAgICBmb3IgKDsgaSA8IG87IGkrKykgewogICAgICAgICAgICByID0gWG5baV0uY2FsbChmLCBlLCBsLCBmLm9wdHMpOwogICAgICAgICAgICBpZiAocikgcmV0dXJuIHIKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEpuKGYsIGwpLCB2LmlzRnVuY3Rpb24oZi5vcHRzLnN0YXJ0KSAmJiBmLm9wdHMuc3RhcnQuY2FsbChlLCBmKSwgdi5meC50aW1lcih2LmV4dGVuZChhLCB7CiAgICAgICAgICAgIGFuaW06IGYsCiAgICAgICAgICAgIHF1ZXVlOiBmLm9wdHMucXVldWUsCiAgICAgICAgICAgIGVsZW06IGUKICAgICAgICB9KSksIGYucHJvZ3Jlc3MoZi5vcHRzLnByb2dyZXNzKS5kb25lKGYub3B0cy5kb25lLCBmLm9wdHMuY29tcGxldGUpLmZhaWwoZi5vcHRzLmZhaWwpLmFsd2F5cyhmLm9wdHMuYWx3YXlzKQogICAgfQoKICAgIGZ1bmN0aW9uIFFuKGUsIHQpIHsKICAgICAgICB2YXIgbiwgciwgaSwgcywgbzsKICAgICAgICBmb3IgKG4gaW4gZSkgewogICAgICAgICAgICByID0gdi5jYW1lbENhc2UobiksIGkgPSB0W3JdLCBzID0gZVtuXSwgdi5pc0FycmF5KHMpICYmIChpID0gc1sxXSwgcyA9IGVbbl0gPSBzWzBdKSwgbiAhPT0gciAmJiAoZVtyXSA9IHMsIGRlbGV0ZSBlW25dKSwgbyA9IHYuY3NzSG9va3Nbcl07CiAgICAgICAgICAgIGlmIChvICYmICJleHBhbmQiIGluIG8pIHsKICAgICAgICAgICAgICAgIHMgPSBvLmV4cGFuZChzKSwgZGVsZXRlIGVbcl07CiAgICAgICAgICAgICAgICBmb3IgKG4gaW4gcykgbiBpbiBlIHx8IChlW25dID0gc1tuXSwgdFtuXSA9IGkpCiAgICAgICAgICAgIH0gZWxzZSB0W3JdID0gaQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBHbihlLCB0LCBuKSB7CiAgICAgICAgdmFyIHIsIGksIHMsIG8sIHUsIGEsIGYsIGwsIGMsIGggPSB0aGlzLAogICAgICAgICAgICBwID0gZS5zdHlsZSwKICAgICAgICAgICAgZCA9IHt9LAogICAgICAgICAgICBtID0gW10sCiAgICAgICAgICAgIGcgPSBlLm5vZGVUeXBlICYmIEd0KGUpOwogICAgICAgIG4ucXVldWUgfHwgKGwgPSB2Ll9xdWV1ZUhvb2tzKGUsICJmeCIpLCBsLnVucXVldWVkID09IG51bGwgJiYgKGwudW5xdWV1ZWQgPSAwLCBjID0gbC5lbXB0eS5maXJlLCBsLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbC51bnF1ZXVlZCB8fCBjKCkKICAgICAgICB9KSwgbC51bnF1ZXVlZCsrLCBoLmFsd2F5cyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgaC5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBsLnVucXVldWVkLS0sIHYucXVldWUoZSwgImZ4IikubGVuZ3RoIHx8IGwuZW1wdHkuZmlyZSgpCiAgICAgICAgICAgIH0pCiAgICAgICAgfSkpLCBlLm5vZGVUeXBlID09PSAxICYmICgiaGVpZ2h0IiBpbiB0IHx8ICJ3aWR0aCIgaW4gdCkgJiYgKG4ub3ZlcmZsb3cgPSBbcC5vdmVyZmxvdywgcC5vdmVyZmxvd1gsIHAub3ZlcmZsb3dZXSwgdi5jc3MoZSwgImRpc3BsYXkiKSA9PT0gImlubGluZSIgJiYgdi5jc3MoZSwgImZsb2F0IikgPT09ICJub25lIiAmJiAoIXYuc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0IHx8IG5uKGUubm9kZU5hbWUpID09PSAiaW5saW5lIiA/IHAuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siIDogcC56b29tID0gMSkpLCBuLm92ZXJmbG93ICYmIChwLm92ZXJmbG93ID0gImhpZGRlbiIsIHYuc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzIHx8IGguZG9uZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgcC5vdmVyZmxvdyA9IG4ub3ZlcmZsb3dbMF0sIHAub3ZlcmZsb3dYID0gbi5vdmVyZmxvd1sxXSwgcC5vdmVyZmxvd1kgPSBuLm92ZXJmbG93WzJdCiAgICAgICAgfSkpOwogICAgICAgIGZvciAociBpbiB0KSB7CiAgICAgICAgICAgIHMgPSB0W3JdOwogICAgICAgICAgICBpZiAoVW4uZXhlYyhzKSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHRbcl0sIGEgPSBhIHx8IHMgPT09ICJ0b2dnbGUiOwogICAgICAgICAgICAgICAgaWYgKHMgPT09IChnID8gImhpZGUiIDogInNob3ciKSkgY29udGludWU7CiAgICAgICAgICAgICAgICBtLnB1c2gocikKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvID0gbS5sZW5ndGg7CiAgICAgICAgaWYgKG8pIHsKICAgICAgICAgICAgdSA9IHYuX2RhdGEoZSwgImZ4c2hvdyIpIHx8IHYuX2RhdGEoZSwgImZ4c2hvdyIsIHt9KSwgImhpZGRlbiIgaW4gdSAmJiAoZyA9IHUuaGlkZGVuKSwgYSAmJiAodS5oaWRkZW4gPSAhZyksIGcgPyB2KGUpLnNob3coKSA6IGguZG9uZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHYoZSkuaGlkZSgpCiAgICAgICAgICAgIH0pLCBoLmRvbmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdDsKICAgICAgICAgICAgICAgIHYucmVtb3ZlRGF0YShlLCAiZnhzaG93IiwgITApOwogICAgICAgICAgICAgICAgZm9yICh0IGluIGQpIHYuc3R5bGUoZSwgdCwgZFt0XSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGZvciAociA9IDA7IHIgPCBvOyByKyspIGkgPSBtW3JdLCBmID0gaC5jcmVhdGVUd2VlbihpLCBnID8gdVtpXSA6IDApLCBkW2ldID0gdVtpXSB8fCB2LnN0eWxlKGUsIGkpLCBpIGluIHUgfHwgKHVbaV0gPSBmLnN0YXJ0LCBnICYmIChmLmVuZCA9IGYuc3RhcnQsIGYuc3RhcnQgPSBpID09PSAid2lkdGgiIHx8IGkgPT09ICJoZWlnaHQiID8gMSA6IDApKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBZbihlLCB0LCBuLCByLCBpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBZbi5wcm90b3R5cGUuaW5pdChlLCB0LCBuLCByLCBpKQogICAgfQoKICAgIGZ1bmN0aW9uIFpuKGUsIHQpIHsKICAgICAgICB2YXIgbiwgciA9IHsKICAgICAgICAgICAgICAgIGhlaWdodDogZQogICAgICAgICAgICB9LAogICAgICAgICAgICBpID0gMDsKICAgICAgICB0ID0gdCA/IDEgOiAwOwogICAgICAgIGZvciAoOyBpIDwgNDsgaSArPSAyIC0gdCkgbiA9ICR0W2ldLCByWyJtYXJnaW4iICsgbl0gPSByWyJwYWRkaW5nIiArIG5dID0gZTsKICAgICAgICByZXR1cm4gdCAmJiAoci5vcGFjaXR5ID0gci53aWR0aCA9IGUpLCByCiAgICB9CgogICAgZnVuY3Rpb24gdHIoZSkgewogICAgICAgIHJldHVybiB2LmlzV2luZG93KGUpID8gZSA6IGUubm9kZVR5cGUgPT09IDkgPyBlLmRlZmF1bHRWaWV3IHx8IGUucGFyZW50V2luZG93IDogITEKICAgIH0KICAgIHZhciBuLCByLCBpID0gZS5kb2N1bWVudCwKICAgICAgICBzID0gZS5sb2NhdGlvbiwKICAgICAgICBvID0gZS5uYXZpZ2F0b3IsCiAgICAgICAgdSA9IGUualF1ZXJ5LAogICAgICAgIGEgPSBlLiQsCiAgICAgICAgZiA9IEFycmF5LnByb3RvdHlwZS5wdXNoLAogICAgICAgIGwgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgYyA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mLAogICAgICAgIGggPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgIHAgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGQgPSBTdHJpbmcucHJvdG90eXBlLnRyaW0sCiAgICAgICAgdiA9IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB2LmZuLmluaXQoZSwgdCwgbikKICAgICAgICB9LAogICAgICAgIG0gPSAvW1wtK10/KD86XGQqXC58KVxkKyg/OltlRV1bXC0rXT9cZCt8KS8uc291cmNlLAogICAgICAgIGcgPSAvXFMvLAogICAgICAgIHkgPSAvXHMrLywKICAgICAgICBiID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAogICAgICAgIHcgPSAvXig/OlteIzxdKig8W1x3XFddKz4pW14+XSokfCMoW1x3XC1dKikkKS8sCiAgICAgICAgRSA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC8sCiAgICAgICAgUyA9IC9eW1xdLDp7fVxzXSokLywKICAgICAgICB4ID0gLyg/Ol58OnwsKSg/OlxzKlxbKSsvZywKICAgICAgICBUID0gL1xcKD86WyJcXFwvYmZucnRdfHVbXGRhLWZBLUZdezR9KS9nLAogICAgICAgIE4gPSAvIlteIlxcXHJcbl0qInx0cnVlfGZhbHNlfG51bGx8LT8oPzpcZFxkKlwufClcZCsoPzpbZUVdW1wtK10/XGQrfCkvZywKICAgICAgICBDID0gL14tbXMtLywKICAgICAgICBrID0gLy0oW1xkYS16XSkvZ2ksCiAgICAgICAgTCA9IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuICh0ICsgIiIpLnRvVXBwZXJDYXNlKCkKICAgICAgICB9LAogICAgICAgIEEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaS5hZGRFdmVudExpc3RlbmVyID8gKGkucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIEEsICExKSwgdi5yZWFkeSgpKSA6IGkucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiAmJiAoaS5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgQSksIHYucmVhZHkoKSkKICAgICAgICB9LAogICAgICAgIE8gPSB7fTsKICAgIHYuZm4gPSB2LnByb3RvdHlwZSA9IHsKICAgICAgICBjb25zdHJ1Y3RvcjogdiwKICAgICAgICBpbml0OiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBzLCBvLCB1LCBhOwogICAgICAgICAgICBpZiAoIWUpIHJldHVybiB0aGlzOwogICAgICAgICAgICBpZiAoZS5ub2RlVHlwZSkgcmV0dXJuIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBlLCB0aGlzLmxlbmd0aCA9IDEsIHRoaXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgZS5jaGFyQXQoMCkgPT09ICI8IiAmJiBlLmNoYXJBdChlLmxlbmd0aCAtIDEpID09PSAiPiIgJiYgZS5sZW5ndGggPj0gMyA/IHMgPSBbbnVsbCwgZSwgbnVsbF0gOiBzID0gdy5leGVjKGUpOwogICAgICAgICAgICAgICAgaWYgKHMgJiYgKHNbMV0gfHwgIW4pKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNbMV0pIHJldHVybiBuID0gbiBpbnN0YW5jZW9mIHYgPyBuWzBdIDogbiwgYSA9IG4gJiYgbi5ub2RlVHlwZSA/IG4ub3duZXJEb2N1bWVudCB8fCBuIDogaSwgZSA9IHYucGFyc2VIVE1MKHNbMV0sIGEsICEwKSwgRS50ZXN0KHNbMV0pICYmIHYuaXNQbGFpbk9iamVjdChuKSAmJiB0aGlzLmF0dHIuY2FsbChlLCBuLCAhMCksIHYubWVyZ2UodGhpcywgZSk7CiAgICAgICAgICAgICAgICAgICAgbyA9IGkuZ2V0RWxlbWVudEJ5SWQoc1syXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG8gJiYgby5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLmlkICE9PSBzWzJdKSByZXR1cm4gci5maW5kKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDEsIHRoaXNbMF0gPSBvCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQgPSBpLCB0aGlzLnNlbGVjdG9yID0gZSwgdGhpcwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICFuIHx8IG4uanF1ZXJ5ID8gKG4gfHwgcikuZmluZChlKSA6IHRoaXMuY29uc3RydWN0b3IobikuZmluZChlKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2LmlzRnVuY3Rpb24oZSkgPyByLnJlYWR5KGUpIDogKGUuc2VsZWN0b3IgIT09IHQgJiYgKHRoaXMuc2VsZWN0b3IgPSBlLnNlbGVjdG9yLCB0aGlzLmNvbnRleHQgPSBlLmNvbnRleHQpLCB2Lm1ha2VBcnJheShlLCB0aGlzKSkKICAgICAgICB9LAogICAgICAgIHNlbGVjdG9yOiAiIiwKICAgICAgICBqcXVlcnk6ICIxLjguMyIsCiAgICAgICAgbGVuZ3RoOiAwLAogICAgICAgIHNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGgKICAgICAgICB9LAogICAgICAgIHRvQXJyYXk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbC5jYWxsKHRoaXMpCiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGUgPT0gbnVsbCA/IHRoaXMudG9BcnJheSgpIDogZSA8IDAgPyB0aGlzW3RoaXMubGVuZ3RoICsgZV0gOiB0aGlzW2VdCiAgICAgICAgfSwKICAgICAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgdmFyIHIgPSB2Lm1lcmdlKHRoaXMuY29uc3RydWN0b3IoKSwgZSk7CiAgICAgICAgICAgIHJldHVybiByLnByZXZPYmplY3QgPSB0aGlzLCByLmNvbnRleHQgPSB0aGlzLmNvbnRleHQsIHQgPT09ICJmaW5kIiA/IHIuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgKHRoaXMuc2VsZWN0b3IgPyAiICIgOiAiIikgKyBuIDogdCAmJiAoci5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgKyAiLiIgKyB0ICsgIigiICsgbiArICIpIiksIHIKICAgICAgICB9LAogICAgICAgIGVhY2g6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuIHYuZWFjaCh0aGlzLCBlLCB0KQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHYucmVhZHkucHJvbWlzZSgpLmRvbmUoZSksIHRoaXMKICAgICAgICB9LAogICAgICAgIGVxOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiBlID0gK2UsIGUgPT09IC0xID8gdGhpcy5zbGljZShlKSA6IHRoaXMuc2xpY2UoZSwgZSArIDEpCiAgICAgICAgfSwKICAgICAgICBmaXJzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVxKDApCiAgICAgICAgfSwKICAgICAgICBsYXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpCiAgICAgICAgfSwKICAgICAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksICJzbGljZSIsIGwuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSkKICAgICAgICB9LAogICAgICAgIG1hcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sodi5tYXAodGhpcywgZnVuY3Rpb24odCwgbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGUuY2FsbCh0LCBuLCB0KQogICAgICAgICAgICB9KSkKICAgICAgICB9LAogICAgICAgIGVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKQogICAgICAgIH0sCiAgICAgICAgcHVzaDogZiwKICAgICAgICBzb3J0OiBbXS5zb3J0LAogICAgICAgIHNwbGljZTogW10uc3BsaWNlCiAgICB9LCB2LmZuLmluaXQucHJvdG90eXBlID0gdi5mbiwgdi5leHRlbmQgPSB2LmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlLCBuLCByLCBpLCBzLCBvLCB1ID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICAgICAgICBhID0gMSwKICAgICAgICAgICAgZiA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICAgIGwgPSAhMTsKICAgICAgICB0eXBlb2YgdSA9PSAiYm9vbGVhbiIgJiYgKGwgPSB1LCB1ID0gYXJndW1lbnRzWzFdIHx8IHt9LCBhID0gMiksIHR5cGVvZiB1ICE9ICJvYmplY3QiICYmICF2LmlzRnVuY3Rpb24odSkgJiYgKHUgPSB7fSksIGYgPT09IGEgJiYgKHUgPSB0aGlzLCAtLWEpOwogICAgICAgIGZvciAoOyBhIDwgZjsgYSsrKQogICAgICAgICAgICBpZiAoKGUgPSBhcmd1bWVudHNbYV0pICE9IG51bGwpCiAgICAgICAgICAgICAgICBmb3IgKG4gaW4gZSkgewogICAgICAgICAgICAgICAgICAgIHIgPSB1W25dLCBpID0gZVtuXTsKICAgICAgICAgICAgICAgICAgICBpZiAodSA9PT0gaSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgbCAmJiBpICYmICh2LmlzUGxhaW5PYmplY3QoaSkgfHwgKHMgPSB2LmlzQXJyYXkoaSkpKSA/IChzID8gKHMgPSAhMSwgbyA9IHIgJiYgdi5pc0FycmF5KHIpID8gciA6IFtdKSA6IG8gPSByICYmIHYuaXNQbGFpbk9iamVjdChyKSA/IHIgOiB7fSwgdVtuXSA9IHYuZXh0ZW5kKGwsIG8sIGkpKSA6IGkgIT09IHQgJiYgKHVbbl0gPSBpKQogICAgICAgICAgICAgICAgfQogICAgICAgIHJldHVybiB1CiAgICB9LCB2LmV4dGVuZCh7CiAgICAgICAgbm9Db25mbGljdDogZnVuY3Rpb24odCkgewogICAgICAgICAgICByZXR1cm4gZS4kID09PSB2ICYmIChlLiQgPSBhKSwgdCAmJiBlLmpRdWVyeSA9PT0gdiAmJiAoZS5qUXVlcnkgPSB1KSwgdgogICAgICAgIH0sCiAgICAgICAgaXNSZWFkeTogITEsCiAgICAgICAgcmVhZHlXYWl0OiAxLAogICAgICAgIGhvbGRSZWFkeTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBlID8gdi5yZWFkeVdhaXQrKyA6IHYucmVhZHkoITApCiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZiAoZSA9PT0gITAgPyAtLXYucmVhZHlXYWl0IDogdi5pc1JlYWR5KSByZXR1cm47CiAgICAgICAgICAgIGlmICghaS5ib2R5KSByZXR1cm4gc2V0VGltZW91dCh2LnJlYWR5LCAxKTsKICAgICAgICAgICAgdi5pc1JlYWR5ID0gITA7CiAgICAgICAgICAgIGlmIChlICE9PSAhMCAmJiAtLXYucmVhZHlXYWl0ID4gMCkgcmV0dXJuOwogICAgICAgICAgICByLnJlc29sdmVXaXRoKGksIFt2XSksIHYuZm4udHJpZ2dlciAmJiB2KGkpLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpCiAgICAgICAgfSwKICAgICAgICBpc0Z1bmN0aW9uOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB2LnR5cGUoZSkgPT09ICJmdW5jdGlvbiIKICAgICAgICB9LAogICAgICAgIGlzQXJyYXk6IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdi50eXBlKGUpID09PSAiYXJyYXkiCiAgICAgICAgfSwKICAgICAgICBpc1dpbmRvdzogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZSAhPSBudWxsICYmIGUgPT0gZS53aW5kb3cKICAgICAgICB9LAogICAgICAgIGlzTnVtZXJpYzogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gIWlzTmFOKHBhcnNlRmxvYXQoZSkpICYmIGlzRmluaXRlKGUpCiAgICAgICAgfSwKICAgICAgICB0eXBlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiBlID09IG51bGwgPyBTdHJpbmcoZSkgOiBPW2guY2FsbChlKV0gfHwgIm9iamVjdCIKICAgICAgICB9LAogICAgICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKCFlIHx8IHYudHlwZShlKSAhPT0gIm9iamVjdCIgfHwgZS5ub2RlVHlwZSB8fCB2LmlzV2luZG93KGUpKSByZXR1cm4gITE7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAoZS5jb25zdHJ1Y3RvciAmJiAhcC5jYWxsKGUsICJjb25zdHJ1Y3RvciIpICYmICFwLmNhbGwoZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikpIHJldHVybiAhMQogICAgICAgICAgICB9IGNhdGNoIChuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gITEKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcjsKICAgICAgICAgICAgZm9yIChyIGluIGUpOwogICAgICAgICAgICByZXR1cm4gciA9PT0gdCB8fCBwLmNhbGwoZSwgcikKICAgICAgICB9LAogICAgICAgIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIHQ7CiAgICAgICAgICAgIGZvciAodCBpbiBlKSByZXR1cm4gITE7CiAgICAgICAgICAgIHJldHVybiAhMAogICAgICAgIH0sCiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGUpCiAgICAgICAgfSwKICAgICAgICBwYXJzZUhUTUw6IGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgdmFyIHI7CiAgICAgICAgICAgIHJldHVybiAhZSB8fCB0eXBlb2YgZSAhPSAic3RyaW5nIiA/IG51bGwgOiAodHlwZW9mIHQgPT0gImJvb2xlYW4iICYmIChuID0gdCwgdCA9IDApLCB0ID0gdCB8fCBpLCAociA9IEUuZXhlYyhlKSkgPyBbdC5jcmVhdGVFbGVtZW50KHJbMV0pXSA6IChyID0gdi5idWlsZEZyYWdtZW50KFtlXSwgdCwgbiA/IG51bGwgOiBbXSksIHYubWVyZ2UoW10sIChyLmNhY2hlYWJsZSA/IHYuY2xvbmUoci5mcmFnbWVudCkgOiByLmZyYWdtZW50KS5jaGlsZE5vZGVzKSkpCiAgICAgICAgfSwKICAgICAgICBwYXJzZUpTT046IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgaWYgKCF0IHx8IHR5cGVvZiB0ICE9ICJzdHJpbmciKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgdCA9IHYudHJpbSh0KTsKICAgICAgICAgICAgaWYgKGUuSlNPTiAmJiBlLkpTT04ucGFyc2UpIHJldHVybiBlLkpTT04ucGFyc2UodCk7CiAgICAgICAgICAgIGlmIChTLnRlc3QodC5yZXBsYWNlKFQsICJAIikucmVwbGFjZShOLCAiXSIpLnJlcGxhY2UoeCwgIiIpKSkgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAiICsgdCkpKCk7CiAgICAgICAgICAgIHYuZXJyb3IoIkludmFsaWQgSlNPTjogIiArIHQpCiAgICAgICAgfSwKICAgICAgICBwYXJzZVhNTDogZnVuY3Rpb24obikgewogICAgICAgICAgICB2YXIgciwgaTsKICAgICAgICAgICAgaWYgKCFuIHx8IHR5cGVvZiBuICE9ICJzdHJpbmciKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGUuRE9NUGFyc2VyID8gKGkgPSBuZXcgRE9NUGFyc2VyLCByID0gaS5wYXJzZUZyb21TdHJpbmcobiwgInRleHQveG1sIikpIDogKHIgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTERPTSIpLCByLmFzeW5jID0gImZhbHNlIiwgci5sb2FkWE1MKG4pKQogICAgICAgICAgICB9IGNhdGNoIChzKSB7CiAgICAgICAgICAgICAgICByID0gdAogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoIXIgfHwgIXIuZG9jdW1lbnRFbGVtZW50IHx8IHIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKSAmJiB2LmVycm9yKCJJbnZhbGlkIFhNTDogIiArIG4pLCByCiAgICAgICAgfSwKICAgICAgICBub29wOiBmdW5jdGlvbigpIHt9LAogICAgICAgIGdsb2JhbEV2YWw6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgdCAmJiBnLnRlc3QodCkgJiYgKGUuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICBlLmV2YWwuY2FsbChlLCB0KQogICAgICAgICAgICB9KSh0KQogICAgICAgIH0sCiAgICAgICAgY2FtZWxDYXNlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiBlLnJlcGxhY2UoQywgIm1zLSIpLnJlcGxhY2UoaywgTCkKICAgICAgICB9LAogICAgICAgIG5vZGVOYW1lOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHJldHVybiBlLm5vZGVOYW1lICYmIGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gdC50b0xvd2VyQ2FzZSgpCiAgICAgICAgfSwKICAgICAgICBlYWNoOiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBpLCBzID0gMCwKICAgICAgICAgICAgICAgIG8gPSBlLmxlbmd0aCwKICAgICAgICAgICAgICAgIHUgPSBvID09PSB0IHx8IHYuaXNGdW5jdGlvbihlKTsKICAgICAgICAgICAgaWYgKHIpIHsKICAgICAgICAgICAgICAgIGlmICh1KSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIGUpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuLmFwcGx5KGVbaV0sIHIpID09PSAhMSkgYnJlYWsKICAgICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgICAgIGZvciAoOyBzIDwgbzspCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuLmFwcGx5KGVbcysrXSwgcikgPT09ICExKSBicmVhawogICAgICAgICAgICB9IGVsc2UgaWYgKHUpIHsKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBlKQogICAgICAgICAgICAgICAgICAgIGlmIChuLmNhbGwoZVtpXSwgaSwgZVtpXSkgPT09ICExKSBicmVhawogICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIGZvciAoOyBzIDwgbzspCiAgICAgICAgICAgICAgICAgICAgaWYgKG4uY2FsbChlW3NdLCBzLCBlW3MrK10pID09PSAhMSkgYnJlYWs7CiAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgfSwKICAgICAgICB0cmltOiBkICYmICFkLmNhbGwoIlx1ZmVmZlx1MDBhMCIpID8gZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZSA9PSBudWxsID8gIiIgOiBkLmNhbGwoZSkKICAgICAgICB9IDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZSA9PSBudWxsID8gIiIgOiAoZSArICIiKS5yZXBsYWNlKGIsICIiKQogICAgICAgIH0sCiAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuLCByID0gdCB8fCBbXTsKICAgICAgICAgICAgcmV0dXJuIGUgIT0gbnVsbCAmJiAobiA9IHYudHlwZShlKSwgZS5sZW5ndGggPT0gbnVsbCB8fCBuID09PSAic3RyaW5nIiB8fCBuID09PSAiZnVuY3Rpb24iIHx8IG4gPT09ICJyZWdleHAiIHx8IHYuaXNXaW5kb3coZSkgPyBmLmNhbGwociwgZSkgOiB2Lm1lcmdlKHIsIGUpKSwgcgogICAgICAgIH0sCiAgICAgICAgaW5BcnJheTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICB2YXIgcjsKICAgICAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgICAgIGlmIChjKSByZXR1cm4gYy5jYWxsKHQsIGUsIG4pOwogICAgICAgICAgICAgICAgciA9IHQubGVuZ3RoLCBuID0gbiA/IG4gPCAwID8gTWF0aC5tYXgoMCwgciArIG4pIDogbiA6IDA7CiAgICAgICAgICAgICAgICBmb3IgKDsgbiA8IHI7IG4rKykKICAgICAgICAgICAgICAgICAgICBpZiAobiBpbiB0ICYmIHRbbl0gPT09IGUpIHJldHVybiBuCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xCiAgICAgICAgfSwKICAgICAgICBtZXJnZTogZnVuY3Rpb24oZSwgbikgewogICAgICAgICAgICB2YXIgciA9IG4ubGVuZ3RoLAogICAgICAgICAgICAgICAgaSA9IGUubGVuZ3RoLAogICAgICAgICAgICAgICAgcyA9IDA7CiAgICAgICAgICAgIGlmICh0eXBlb2YgciA9PSAibnVtYmVyIikKICAgICAgICAgICAgICAgIGZvciAoOyBzIDwgcjsgcysrKSBlW2krK10gPSBuW3NdOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB3aGlsZSAobltzXSAhPT0gdCkgZVtpKytdID0gbltzKytdOwogICAgICAgICAgICByZXR1cm4gZS5sZW5ndGggPSBpLCBlCiAgICAgICAgfSwKICAgICAgICBncmVwOiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIHZhciByLCBpID0gW10sCiAgICAgICAgICAgICAgICBzID0gMCwKICAgICAgICAgICAgICAgIG8gPSBlLmxlbmd0aDsKICAgICAgICAgICAgbiA9ICEhbjsKICAgICAgICAgICAgZm9yICg7IHMgPCBvOyBzKyspIHIgPSAhIXQoZVtzXSwgcyksIG4gIT09IHIgJiYgaS5wdXNoKGVbc10pOwogICAgICAgICAgICByZXR1cm4gaQogICAgICAgIH0sCiAgICAgICAgbWFwOiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBpLCBzLCBvID0gW10sCiAgICAgICAgICAgICAgICB1ID0gMCwKICAgICAgICAgICAgICAgIGEgPSBlLmxlbmd0aCwKICAgICAgICAgICAgICAgIGYgPSBlIGluc3RhbmNlb2YgdiB8fCBhICE9PSB0ICYmIHR5cGVvZiBhID09ICJudW1iZXIiICYmIChhID4gMCAmJiBlWzBdICYmIGVbYSAtIDFdIHx8IGEgPT09IDAgfHwgdi5pc0FycmF5KGUpKTsKICAgICAgICAgICAgaWYgKGYpCiAgICAgICAgICAgICAgICBmb3IgKDsgdSA8IGE7IHUrKykgaSA9IG4oZVt1XSwgdSwgciksIGkgIT0gbnVsbCAmJiAob1tvLmxlbmd0aF0gPSBpKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgZm9yIChzIGluIGUpIGkgPSBuKGVbc10sIHMsIHIpLCBpICE9IG51bGwgJiYgKG9bby5sZW5ndGhdID0gaSk7CiAgICAgICAgICAgIHJldHVybiBvLmNvbmNhdC5hcHBseShbXSwgbykKICAgICAgICB9LAogICAgICAgIGd1aWQ6IDEsCiAgICAgICAgcHJveHk6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgdmFyIHIsIGksIHM7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgbiA9PSAic3RyaW5nIiAmJiAociA9IGVbbl0sIG4gPSBlLCBlID0gciksIHYuaXNGdW5jdGlvbihlKSA/IChpID0gbC5jYWxsKGFyZ3VtZW50cywgMiksIHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlLmFwcGx5KG4sIGkuY29uY2F0KGwuY2FsbChhcmd1bWVudHMpKSkKICAgICAgICAgICAgfSwgcy5ndWlkID0gZS5ndWlkID0gZS5ndWlkIHx8IHYuZ3VpZCsrLCBzKSA6IHQKICAgICAgICB9LAogICAgICAgIGFjY2VzczogZnVuY3Rpb24oZSwgbiwgciwgaSwgcywgbywgdSkgewogICAgICAgICAgICB2YXIgYSwgZiA9IHIgPT0gbnVsbCwKICAgICAgICAgICAgICAgIGwgPSAwLAogICAgICAgICAgICAgICAgYyA9IGUubGVuZ3RoOwogICAgICAgICAgICBpZiAociAmJiB0eXBlb2YgciA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgZm9yIChsIGluIHIpIHYuYWNjZXNzKGUsIG4sIGwsIHJbbF0sIDEsIG8sIGkpOwogICAgICAgICAgICAgICAgcyA9IDEKICAgICAgICAgICAgfSBlbHNlIGlmIChpICE9PSB0KSB7CiAgICAgICAgICAgICAgICBhID0gdSA9PT0gdCAmJiB2LmlzRnVuY3Rpb24oaSksIGYgJiYgKGEgPyAoYSA9IG4sIG4gPSBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuY2FsbCh2KGUpLCBuKQogICAgICAgICAgICAgICAgfSkgOiAobi5jYWxsKGUsIGkpLCBuID0gbnVsbCkpOwogICAgICAgICAgICAgICAgaWYgKG4pCiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGwgPCBjOyBsKyspIG4oZVtsXSwgciwgYSA/IGkuY2FsbChlW2xdLCBsLCBuKGVbbF0sIHIpKSA6IGksIHUpOwogICAgICAgICAgICAgICAgcyA9IDEKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcyA/IGUgOiBmID8gbi5jYWxsKGUpIDogYyA/IG4oZVswXSwgcikgOiBvCiAgICAgICAgfSwKICAgICAgICBub3c6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG5ldyBEYXRlKS5nZXRUaW1lKCkKICAgICAgICB9CiAgICB9KSwgdi5yZWFkeS5wcm9taXNlID0gZnVuY3Rpb24odCkgewogICAgICAgIGlmICghcikgewogICAgICAgICAgICByID0gdi5EZWZlcnJlZCgpOwogICAgICAgICAgICBpZiAoaS5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSBzZXRUaW1lb3V0KHYucmVhZHksIDEpOwogICAgICAgICAgICBlbHNlIGlmIChpLmFkZEV2ZW50TGlzdGVuZXIpIGkuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIEEsICExKSwgZS5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgdi5yZWFkeSwgITEpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGkuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIEEpLCBlLmF0dGFjaEV2ZW50KCJvbmxvYWQiLCB2LnJlYWR5KTsKICAgICAgICAgICAgICAgIHZhciBuID0gITE7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG4gPSBlLmZyYW1lRWxlbWVudCA9PSBudWxsICYmIGkuZG9jdW1lbnRFbGVtZW50CiAgICAgICAgICAgICAgICB9IGNhdGNoIChzKSB7fQogICAgICAgICAgICAgICAgbiAmJiBuLmRvU2Nyb2xsICYmIGZ1bmN0aW9uIG8oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2LmlzUmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4uZG9TY3JvbGwoImxlZnQiKQogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChvLCA1MCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2LnJlYWR5KCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KCkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gci5wcm9taXNlKHQpCiAgICB9LCB2LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICBPWyJbb2JqZWN0ICIgKyB0ICsgIl0iXSA9IHQudG9Mb3dlckNhc2UoKQogICAgfSksIG4gPSB2KGkpOwogICAgdmFyIE0gPSB7fTsKICAgIHYuQ2FsbGJhY2tzID0gZnVuY3Rpb24oZSkgewogICAgICAgIGUgPSB0eXBlb2YgZSA9PSAic3RyaW5nIiA/IE1bZV0gfHwgXyhlKSA6IHYuZXh0ZW5kKHt9LCBlKTsKICAgICAgICB2YXIgbiwgciwgaSwgcywgbywgdSwgYSA9IFtdLAogICAgICAgICAgICBmID0gIWUub25jZSAmJiBbXSwKICAgICAgICAgICAgbCA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgIG4gPSBlLm1lbW9yeSAmJiB0LCByID0gITAsIHUgPSBzIHx8IDAsIHMgPSAwLCBvID0gYS5sZW5ndGgsIGkgPSAhMDsKICAgICAgICAgICAgICAgIGZvciAoOyBhICYmIHUgPCBvOyB1KyspCiAgICAgICAgICAgICAgICAgICAgaWYgKGFbdV0uYXBwbHkodFswXSwgdFsxXSkgPT09ICExICYmIGUuc3RvcE9uRmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbiA9ICExOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGkgPSAhMSwgYSAmJiAoZiA/IGYubGVuZ3RoICYmIGwoZi5zaGlmdCgpKSA6IG4gPyBhID0gW10gOiBjLmRpc2FibGUoKSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYyA9IHsKICAgICAgICAgICAgICAgIGFkZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uIHIodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdi5lYWNoKHQsIGZ1bmN0aW9uKHQsIG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHYudHlwZShuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID09PSAiZnVuY3Rpb24iID8gKCFlLnVuaXF1ZSB8fCAhYy5oYXMobikpICYmIGEucHVzaChuKSA6IG4gJiYgbi5sZW5ndGggJiYgaSAhPT0gInN0cmluZyIgJiYgcihuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgfSkoYXJndW1lbnRzKSwgaSA/IG8gPSBhLmxlbmd0aCA6IG4gJiYgKHMgPSB0LCBsKG4pKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgdi5lYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbjsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChuID0gdi5pbkFycmF5KHQsIGEsIG4pKSA+IC0xKSBhLnNwbGljZShuLCAxKSwgaSAmJiAobiA8PSBvICYmIG8tLSwgbiA8PSB1ICYmIHUtLSkKICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGhhczogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2LmluQXJyYXkoZSwgYSkgPiAtMQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9IFtdLCB0aGlzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPSBmID0gbiA9IHQsIHRoaXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFhCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYgPSB0LCBuIHx8IGMuZGlzYWJsZSgpLCB0aGlzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbG9ja2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWYKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ID0gdCB8fCBbXSwgdCA9IFtlLCB0LnNsaWNlID8gdC5zbGljZSgpIDogdF0sIGEgJiYgKCFyIHx8IGYpICYmIChpID8gZi5wdXNoKHQpIDogbCh0KSksIHRoaXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmaXJlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYy5maXJlV2l0aCh0aGlzLCBhcmd1bWVudHMpLCB0aGlzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZmlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICByZXR1cm4gYwogICAgfSwgdi5leHRlbmQoewogICAgICAgIERlZmVycmVkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0ID0gWwogICAgICAgICAgICAgICAgICAgIFsicmVzb2x2ZSIsICJkb25lIiwgdi5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCJdLAogICAgICAgICAgICAgICAgICAgIFsicmVqZWN0IiwgImZhaWwiLCB2LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlamVjdGVkIl0sCiAgICAgICAgICAgICAgICAgICAgWyJub3RpZnkiLCAicHJvZ3Jlc3MiLCB2LkNhbGxiYWNrcygibWVtb3J5IildCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgbiA9ICJwZW5kaW5nIiwKICAgICAgICAgICAgICAgIHIgPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgYWx3YXlzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKSwgdGhpcwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdi5EZWZlcnJlZChmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2LmVhY2godCwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzID0gclswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbyA9IGVbdF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaVtyWzFdXSh2LmlzRnVuY3Rpb24obykgPyBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSBvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgJiYgdi5pc0Z1bmN0aW9uKGUucHJvbWlzZSkgPyBlLnByb21pc2UoKS5kb25lKG4ucmVzb2x2ZSkuZmFpbChuLnJlamVjdCkucHJvZ3Jlc3Mobi5ub3RpZnkpIDogbltzICsgIldpdGgiXSh0aGlzID09PSBpID8gbiA6IHRoaXMsIFtlXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IDogbltzXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBlID0gbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KS5wcm9taXNlKCkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUgIT0gbnVsbCA/IHYuZXh0ZW5kKGUsIHIpIDogcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpID0ge307CiAgICAgICAgICAgIHJldHVybiByLnBpcGUgPSByLnRoZW4sIHYuZWFjaCh0LCBmdW5jdGlvbihlLCBzKSB7CiAgICAgICAgICAgICAgICB2YXIgbyA9IHNbMl0sCiAgICAgICAgICAgICAgICAgICAgdSA9IHNbM107CiAgICAgICAgICAgICAgICByW3NbMV1dID0gby5hZGQsIHUgJiYgby5hZGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IHUKICAgICAgICAgICAgICAgIH0sIHRbZSBeIDFdWzJdLmRpc2FibGUsIHRbMl1bMl0ubG9jayksIGlbc1swXV0gPSBvLmZpcmUsIGlbc1swXSArICJXaXRoIl0gPSBvLmZpcmVXaXRoCiAgICAgICAgICAgIH0pLCByLnByb21pc2UoaSksIGUgJiYgZS5jYWxsKGksIGkpLCBpCiAgICAgICAgfSwKICAgICAgICB3aGVuOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0ID0gMCwKICAgICAgICAgICAgICAgIG4gPSBsLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgIHIgPSBuLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSByICE9PSAxIHx8IGUgJiYgdi5pc0Z1bmN0aW9uKGUucHJvbWlzZSkgPyByIDogMCwKICAgICAgICAgICAgICAgIHMgPSBpID09PSAxID8gZSA6IHYuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICAgIG8gPSBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdFtlXSA9IHRoaXMsIG5bZV0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGwuY2FsbChhcmd1bWVudHMpIDogciwgbiA9PT0gdSA/IHMubm90aWZ5V2l0aCh0LCBuKSA6IC0taSB8fCBzLnJlc29sdmVXaXRoKHQsIG4pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHUsIGEsIGY7CiAgICAgICAgICAgIGlmIChyID4gMSkgewogICAgICAgICAgICAgICAgdSA9IG5ldyBBcnJheShyKSwgYSA9IG5ldyBBcnJheShyKSwgZiA9IG5ldyBBcnJheShyKTsKICAgICAgICAgICAgICAgIGZvciAoOyB0IDwgcjsgdCsrKSBuW3RdICYmIHYuaXNGdW5jdGlvbihuW3RdLnByb21pc2UpID8gblt0XS5wcm9taXNlKCkuZG9uZShvKHQsIGYsIG4pKS5mYWlsKHMucmVqZWN0KS5wcm9ncmVzcyhvKHQsIGEsIHUpKSA6IC0taQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpIHx8IHMucmVzb2x2ZVdpdGgoZiwgbiksIHMucHJvbWlzZSgpCiAgICAgICAgfQogICAgfSksIHYuc3VwcG9ydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0LCBuLCByLCBzLCBvLCB1LCBhLCBmLCBsLCBjLCBoLCBwID0gaS5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBwLnNldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIiwgInQiKSwgcC5pbm5lckhUTUwgPSAiICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IiwgbiA9IHAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSwgciA9IHAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImEiKVswXTsKICAgICAgICBpZiAoIW4gfHwgIXIgfHwgIW4ubGVuZ3RoKSByZXR1cm4ge307CiAgICAgICAgcyA9IGkuY3JlYXRlRWxlbWVudCgic2VsZWN0IiksIG8gPSBzLmFwcGVuZENoaWxkKGkuY3JlYXRlRWxlbWVudCgib3B0aW9uIikpLCB1ID0gcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVswXSwgci5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHg7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IiwgdCA9IHsKICAgICAgICAgICAgbGVhZGluZ1doaXRlc3BhY2U6IHAuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMywKICAgICAgICAgICAgdGJvZHk6ICFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpLmxlbmd0aCwKICAgICAgICAgICAgaHRtbFNlcmlhbGl6ZTogISFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaW5rIikubGVuZ3RoLAogICAgICAgICAgICBzdHlsZTogL3RvcC8udGVzdChyLmdldEF0dHJpYnV0ZSgic3R5bGUiKSksCiAgICAgICAgICAgIGhyZWZOb3JtYWxpemVkOiByLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiL2EiLAogICAgICAgICAgICBvcGFjaXR5OiAvXjAuNS8udGVzdChyLnN0eWxlLm9wYWNpdHkpLAogICAgICAgICAgICBjc3NGbG9hdDogISFyLnN0eWxlLmNzc0Zsb2F0LAogICAgICAgICAgICBjaGVja09uOiB1LnZhbHVlID09PSAib24iLAogICAgICAgICAgICBvcHRTZWxlY3RlZDogby5zZWxlY3RlZCwKICAgICAgICAgICAgZ2V0U2V0QXR0cmlidXRlOiBwLmNsYXNzTmFtZSAhPT0gInQiLAogICAgICAgICAgICBlbmN0eXBlOiAhIWkuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGUsCiAgICAgICAgICAgIGh0bWw1Q2xvbmU6IGkuY3JlYXRlRWxlbWVudCgibmF2IikuY2xvbmVOb2RlKCEwKS5vdXRlckhUTUwgIT09ICI8Om5hdj48LzpuYXY+IiwKICAgICAgICAgICAgYm94TW9kZWw6IGkuY29tcGF0TW9kZSA9PT0gIkNTUzFDb21wYXQiLAogICAgICAgICAgICBzdWJtaXRCdWJibGVzOiAhMCwKICAgICAgICAgICAgY2hhbmdlQnViYmxlczogITAsCiAgICAgICAgICAgIGZvY3VzaW5CdWJibGVzOiAhMSwKICAgICAgICAgICAgZGVsZXRlRXhwYW5kbzogITAsCiAgICAgICAgICAgIG5vQ2xvbmVFdmVudDogITAsCiAgICAgICAgICAgIGlubGluZUJsb2NrTmVlZHNMYXlvdXQ6ICExLAogICAgICAgICAgICBzaHJpbmtXcmFwQmxvY2tzOiAhMSwKICAgICAgICAgICAgcmVsaWFibGVNYXJnaW5SaWdodDogITAsCiAgICAgICAgICAgIGJveFNpemluZ1JlbGlhYmxlOiAhMCwKICAgICAgICAgICAgcGl4ZWxQb3NpdGlvbjogITEKICAgICAgICB9LCB1LmNoZWNrZWQgPSAhMCwgdC5ub0Nsb25lQ2hlY2tlZCA9IHUuY2xvbmVOb2RlKCEwKS5jaGVja2VkLCBzLmRpc2FibGVkID0gITAsIHQub3B0RGlzYWJsZWQgPSAhby5kaXNhYmxlZDsKICAgICAgICB0cnkgewogICAgICAgICAgICBkZWxldGUgcC50ZXN0CiAgICAgICAgfSBjYXRjaCAoZCkgewogICAgICAgICAgICB0LmRlbGV0ZUV4cGFuZG8gPSAhMQogICAgICAgIH0hcC5hZGRFdmVudExpc3RlbmVyICYmIHAuYXR0YWNoRXZlbnQgJiYgcC5maXJlRXZlbnQgJiYgKHAuYXR0YWNoRXZlbnQoIm9uY2xpY2siLCBoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHQubm9DbG9uZUV2ZW50ID0gITEKICAgICAgICB9KSwgcC5jbG9uZU5vZGUoITApLmZpcmVFdmVudCgib25jbGljayIpLCBwLmRldGFjaEV2ZW50KCJvbmNsaWNrIiwgaCkpLCB1ID0gaS5jcmVhdGVFbGVtZW50KCJpbnB1dCIpLCB1LnZhbHVlID0gInQiLCB1LnNldEF0dHJpYnV0ZSgidHlwZSIsICJyYWRpbyIpLCB0LnJhZGlvVmFsdWUgPSB1LnZhbHVlID09PSAidCIsIHUuc2V0QXR0cmlidXRlKCJjaGVja2VkIiwgImNoZWNrZWQiKSwgdS5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAidCIpLCBwLmFwcGVuZENoaWxkKHUpLCBhID0gaS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIGEuYXBwZW5kQ2hpbGQocC5sYXN0Q2hpbGQpLCB0LmNoZWNrQ2xvbmUgPSBhLmNsb25lTm9kZSghMCkuY2xvbmVOb2RlKCEwKS5sYXN0Q2hpbGQuY2hlY2tlZCwgdC5hcHBlbmRDaGVja2VkID0gdS5jaGVja2VkLCBhLnJlbW92ZUNoaWxkKHUpLCBhLmFwcGVuZENoaWxkKHApOwogICAgICAgIGlmIChwLmF0dGFjaEV2ZW50KQogICAgICAgICAgICBmb3IgKGwgaW4gewogICAgICAgICAgICAgICAgICAgIHN1Ym1pdDogITAsCiAgICAgICAgICAgICAgICAgICAgY2hhbmdlOiAhMCwKICAgICAgICAgICAgICAgICAgICBmb2N1c2luOiAhMAogICAgICAgICAgICAgICAgfSkgZiA9ICJvbiIgKyBsLCBjID0gZiBpbiBwLCBjIHx8IChwLnNldEF0dHJpYnV0ZShmLCAicmV0dXJuOyIpLCBjID0gdHlwZW9mIHBbZl0gPT0gImZ1bmN0aW9uIiksIHRbbCArICJCdWJibGVzIl0gPSBjOwogICAgICAgIHJldHVybiB2KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbiwgciwgcywgbywgdSA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpibG9jaztvdmVyZmxvdzpoaWRkZW47IiwKICAgICAgICAgICAgICAgIGEgPSBpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CiAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICBuID0gaS5jcmVhdGVFbGVtZW50KCJkaXYiKSwgbi5zdHlsZS5jc3NUZXh0ID0gInZpc2liaWxpdHk6aGlkZGVuO2JvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246c3RhdGljO3RvcDowO21hcmdpbi10b3A6MXB4IiwgYS5pbnNlcnRCZWZvcmUobiwgYS5maXJzdENoaWxkKSwgciA9IGkuY3JlYXRlRWxlbWVudCgiZGl2IiksIG4uYXBwZW5kQ2hpbGQociksIHIuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkPjwvdGQ+PHRkPnQ8L3RkPjwvdHI+PC90YWJsZT4iLCBzID0gci5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGQiKSwgc1swXS5zdHlsZS5jc3NUZXh0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5Om5vbmUiLCBjID0gc1swXS5vZmZzZXRIZWlnaHQgPT09IDAsIHNbMF0uc3R5bGUuZGlzcGxheSA9ICIiLCBzWzFdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gYyAmJiBzWzBdLm9mZnNldEhlaWdodCA9PT0gMCwgci5pbm5lckhUTUwgPSAiIiwgci5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDstd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElOyIsIHQuYm94U2l6aW5nID0gci5vZmZzZXRXaWR0aCA9PT0gNCwgdC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCA9IGEub2Zmc2V0VG9wICE9PSAxLCBlLmdldENvbXB1dGVkU3R5bGUgJiYgKHQucGl4ZWxQb3NpdGlvbiA9IChlLmdldENvbXB1dGVkU3R5bGUociwgbnVsbCkgfHwge30pLnRvcCAhPT0gIjElIiwgdC5ib3hTaXppbmdSZWxpYWJsZSA9IChlLmdldENvbXB1dGVkU3R5bGUociwgbnVsbCkgfHwgewogICAgICAgICAgICAgICAgd2lkdGg6ICI0cHgiCiAgICAgICAgICAgIH0pLndpZHRoID09PSAiNHB4IiwgbyA9IGkuY3JlYXRlRWxlbWVudCgiZGl2IiksIG8uc3R5bGUuY3NzVGV4dCA9IHIuc3R5bGUuY3NzVGV4dCA9IHUsIG8uc3R5bGUubWFyZ2luUmlnaHQgPSBvLnN0eWxlLndpZHRoID0gIjAiLCByLnN0eWxlLndpZHRoID0gIjFweCIsIHIuYXBwZW5kQ2hpbGQobyksIHQucmVsaWFibGVNYXJnaW5SaWdodCA9ICFwYXJzZUZsb2F0KChlLmdldENvbXB1dGVkU3R5bGUobywgbnVsbCkgfHwge30pLm1hcmdpblJpZ2h0KSksIHR5cGVvZiByLnN0eWxlLnpvb20gIT0gInVuZGVmaW5lZCIgJiYgKHIuaW5uZXJIVE1MID0gIiIsIHIuc3R5bGUuY3NzVGV4dCA9IHUgKyAid2lkdGg6MXB4O3BhZGRpbmc6MXB4O2Rpc3BsYXk6aW5saW5lO3pvb206MSIsIHQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9IHIub2Zmc2V0V2lkdGggPT09IDMsIHIuc3R5bGUuZGlzcGxheSA9ICJibG9jayIsIHIuc3R5bGUub3ZlcmZsb3cgPSAidmlzaWJsZSIsIHIuaW5uZXJIVE1MID0gIjxkaXY+PC9kaXY+Iiwgci5maXJzdENoaWxkLnN0eWxlLndpZHRoID0gIjVweCIsIHQuc2hyaW5rV3JhcEJsb2NrcyA9IHIub2Zmc2V0V2lkdGggIT09IDMsIG4uc3R5bGUuem9vbSA9IDEpLCBhLnJlbW92ZUNoaWxkKG4pLCBuID0gciA9IHMgPSBvID0gbnVsbAogICAgICAgIH0pLCBhLnJlbW92ZUNoaWxkKHApLCBuID0gciA9IHMgPSBvID0gdSA9IGEgPSBwID0gbnVsbCwgdAogICAgfSgpOwogICAgdmFyIEQgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sCiAgICAgICAgUCA9IC8oW0EtWl0pL2c7CiAgICB2LmV4dGVuZCh7CiAgICAgICAgY2FjaGU6IHt9LAogICAgICAgIGRlbGV0ZWRJZHM6IFtdLAogICAgICAgIHV1aWQ6IDAsCiAgICAgICAgZXhwYW5kbzogImpRdWVyeSIgKyAodi5mbi5qcXVlcnkgKyBNYXRoLnJhbmRvbSgpKS5yZXBsYWNlKC9cRC9nLCAiIiksCiAgICAgICAgbm9EYXRhOiB7CiAgICAgICAgICAgIGVtYmVkOiAhMCwKICAgICAgICAgICAgb2JqZWN0OiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiwKICAgICAgICAgICAgYXBwbGV0OiAhMAogICAgICAgIH0sCiAgICAgICAgaGFzRGF0YTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZSA9IGUubm9kZVR5cGUgPyB2LmNhY2hlW2Vbdi5leHBhbmRvXV0gOiBlW3YuZXhwYW5kb10sICEhZSAmJiAhQihlKQogICAgICAgIH0sCiAgICAgICAgZGF0YTogZnVuY3Rpb24oZSwgbiwgciwgaSkgewogICAgICAgICAgICBpZiAoIXYuYWNjZXB0RGF0YShlKSkgcmV0dXJuOwogICAgICAgICAgICB2YXIgcywgbywgdSA9IHYuZXhwYW5kbywKICAgICAgICAgICAgICAgIGEgPSB0eXBlb2YgbiA9PSAic3RyaW5nIiwKICAgICAgICAgICAgICAgIGYgPSBlLm5vZGVUeXBlLAogICAgICAgICAgICAgICAgbCA9IGYgPyB2LmNhY2hlIDogZSwKICAgICAgICAgICAgICAgIGMgPSBmID8gZVt1XSA6IGVbdV0gJiYgdTsKICAgICAgICAgICAgaWYgKCghYyB8fCAhbFtjXSB8fCAhaSAmJiAhbFtjXS5kYXRhKSAmJiBhICYmIHIgPT09IHQpIHJldHVybjsKICAgICAgICAgICAgYyB8fCAoZiA/IGVbdV0gPSBjID0gdi5kZWxldGVkSWRzLnBvcCgpIHx8IHYuZ3VpZCsrIDogYyA9IHUpLCBsW2NdIHx8IChsW2NdID0ge30sIGYgfHwgKGxbY10udG9KU09OID0gdi5ub29wKSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbiA9PSAib2JqZWN0IiB8fCB0eXBlb2YgbiA9PSAiZnVuY3Rpb24iKSBpID8gbFtjXSA9IHYuZXh0ZW5kKGxbY10sIG4pIDogbFtjXS5kYXRhID0gdi5leHRlbmQobFtjXS5kYXRhLCBuKTsKICAgICAgICAgICAgcmV0dXJuIHMgPSBsW2NdLCBpIHx8IChzLmRhdGEgfHwgKHMuZGF0YSA9IHt9KSwgcyA9IHMuZGF0YSksIHIgIT09IHQgJiYgKHNbdi5jYW1lbENhc2UobildID0gciksIGEgPyAobyA9IHNbbl0sIG8gPT0gbnVsbCAmJiAobyA9IHNbdi5jYW1lbENhc2UobildKSkgOiBvID0gcywgbwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICBpZiAoIXYuYWNjZXB0RGF0YShlKSkgcmV0dXJuOwogICAgICAgICAgICB2YXIgciwgaSwgcywgbyA9IGUubm9kZVR5cGUsCiAgICAgICAgICAgICAgICB1ID0gbyA/IHYuY2FjaGUgOiBlLAogICAgICAgICAgICAgICAgYSA9IG8gPyBlW3YuZXhwYW5kb10gOiB2LmV4cGFuZG87CiAgICAgICAgICAgIGlmICghdVthXSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodCkgewogICAgICAgICAgICAgICAgciA9IG4gPyB1W2FdIDogdVthXS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKHIpIHsKICAgICAgICAgICAgICAgICAgICB2LmlzQXJyYXkodCkgfHwgKHQgaW4gciA/IHQgPSBbdF0gOiAodCA9IHYuY2FtZWxDYXNlKHQpLCB0IGluIHIgPyB0ID0gW3RdIDogdCA9IHQuc3BsaXQoIiAiKSkpOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIHMgPSB0Lmxlbmd0aDsgaSA8IHM7IGkrKykgZGVsZXRlIHJbdFtpXV07CiAgICAgICAgICAgICAgICAgICAgaWYgKCEobiA/IEIgOiB2LmlzRW1wdHlPYmplY3QpKHIpKSByZXR1cm4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW4pIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1W2FdLmRhdGE7CiAgICAgICAgICAgICAgICBpZiAoIUIodVthXSkpIHJldHVybgogICAgICAgICAgICB9CiAgICAgICAgICAgIG8gPyB2LmNsZWFuRGF0YShbZV0sICEwKSA6IHYuc3VwcG9ydC5kZWxldGVFeHBhbmRvIHx8IHUgIT0gdS53aW5kb3cgPyBkZWxldGUgdVthXSA6IHVbYV0gPSBudWxsCiAgICAgICAgfSwKICAgICAgICBfZGF0YTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICByZXR1cm4gdi5kYXRhKGUsIHQsIG4sICEwKQogICAgICAgIH0sCiAgICAgICAgYWNjZXB0RGF0YTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgdCA9IGUubm9kZU5hbWUgJiYgdi5ub0RhdGFbZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgICAgcmV0dXJuICF0IHx8IHQgIT09ICEwICYmIGUuZ2V0QXR0cmlidXRlKCJjbGFzc2lkIikgPT09IHQKICAgICAgICB9CiAgICB9KSwgdi5mbi5leHRlbmQoewogICAgICAgIGRhdGE6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgdmFyIHIsIGksIHMsIG8sIHUsIGEgPSB0aGlzWzBdLAogICAgICAgICAgICAgICAgZiA9IDAsCiAgICAgICAgICAgICAgICBsID0gbnVsbDsKICAgICAgICAgICAgaWYgKGUgPT09IHQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGwgPSB2LmRhdGEoYSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEubm9kZVR5cGUgPT09IDEgJiYgIXYuX2RhdGEoYSwgInBhcnNlZEF0dHJzIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcyA9IGEuYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh1ID0gcy5sZW5ndGg7IGYgPCB1OyBmKyspIG8gPSBzW2ZdLm5hbWUsIG8uaW5kZXhPZigiZGF0YS0iKSB8fCAobyA9IHYuY2FtZWxDYXNlKG8uc3Vic3RyaW5nKDUpKSwgSChhLCBvLCBsW29dKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHYuX2RhdGEoYSwgInBhcnNlZEF0dHJzIiwgITApCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGwKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGUgPT0gIm9iamVjdCIgPyB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2LmRhdGEodGhpcywgZSkKICAgICAgICAgICAgfSkgOiAociA9IGUuc3BsaXQoIi4iLCAyKSwgclsxXSA9IHJbMV0gPyAiLiIgKyByWzFdIDogIiIsIGkgPSByWzFdICsgIiEiLCB2LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICBpZiAobiA9PT0gdCkgcmV0dXJuIGwgPSB0aGlzLnRyaWdnZXJIYW5kbGVyKCJnZXREYXRhIiArIGksIFtyWzBdXSksIGwgPT09IHQgJiYgYSAmJiAobCA9IHYuZGF0YShhLCBlKSwgbCA9IEgoYSwgZSwgbCkpLCBsID09PSB0ICYmIHJbMV0gPyB0aGlzLmRhdGEoclswXSkgOiBsOwogICAgICAgICAgICAgICAgclsxXSA9IG4sIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHYodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgdC50cmlnZ2VySGFuZGxlcigic2V0RGF0YSIgKyBpLCByKSwgdi5kYXRhKHRoaXMsIGUsIG4pLCB0LnRyaWdnZXJIYW5kbGVyKCJjaGFuZ2VEYXRhIiArIGksIHIpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LCBudWxsLCBuLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgITEpKQogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdi5yZW1vdmVEYXRhKHRoaXMsIGUpCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfSksIHYuZXh0ZW5kKHsKICAgICAgICBxdWV1ZTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICB2YXIgcjsKICAgICAgICAgICAgaWYgKGUpIHJldHVybiB0ID0gKHQgfHwgImZ4IikgKyAicXVldWUiLCByID0gdi5fZGF0YShlLCB0KSwgbiAmJiAoIXIgfHwgdi5pc0FycmF5KG4pID8gciA9IHYuX2RhdGEoZSwgdCwgdi5tYWtlQXJyYXkobikpIDogci5wdXNoKG4pKSwgciB8fCBbXQogICAgICAgIH0sCiAgICAgICAgZGVxdWV1ZTogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB0ID0gdCB8fCAiZngiOwogICAgICAgICAgICB2YXIgbiA9IHYucXVldWUoZSwgdCksCiAgICAgICAgICAgICAgICByID0gbi5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbi5zaGlmdCgpLAogICAgICAgICAgICAgICAgcyA9IHYuX3F1ZXVlSG9va3MoZSwgdCksCiAgICAgICAgICAgICAgICBvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdi5kZXF1ZXVlKGUsIHQpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBpID09PSAiaW5wcm9ncmVzcyIgJiYgKGkgPSBuLnNoaWZ0KCksIHItLSksIGkgJiYgKHQgPT09ICJmeCIgJiYgbi51bnNoaWZ0KCJpbnByb2dyZXNzIiksIGRlbGV0ZSBzLnN0b3AsIGkuY2FsbChlLCBvLCBzKSksICFyICYmIHMgJiYgcy5lbXB0eS5maXJlKCkKICAgICAgICB9LAogICAgICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuID0gdCArICJxdWV1ZUhvb2tzIjsKICAgICAgICAgICAgcmV0dXJuIHYuX2RhdGEoZSwgbikgfHwgdi5fZGF0YShlLCBuLCB7CiAgICAgICAgICAgICAgICBlbXB0eTogdi5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IikuYWRkKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHYucmVtb3ZlRGF0YShlLCB0ICsgInF1ZXVlIiwgITApLCB2LnJlbW92ZURhdGEoZSwgbiwgITApCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0pLCB2LmZuLmV4dGVuZCh7CiAgICAgICAgcXVldWU6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgdmFyIHIgPSAyOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGUgIT0gInN0cmluZyIgJiYgKG4gPSBlLCBlID0gImZ4Iiwgci0tKSwgYXJndW1lbnRzLmxlbmd0aCA8IHIgPyB2LnF1ZXVlKHRoaXNbMF0sIGUpIDogbiA9PT0gdCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHYucXVldWUodGhpcywgZSwgbik7CiAgICAgICAgICAgICAgICB2Ll9xdWV1ZUhvb2tzKHRoaXMsIGUpLCBlID09PSAiZngiICYmIHRbMF0gIT09ICJpbnByb2dyZXNzIiAmJiB2LmRlcXVldWUodGhpcywgZSkKICAgICAgICAgICAgfSkKICAgICAgICB9LAogICAgICAgIGRlcXVldWU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHYuZGVxdWV1ZSh0aGlzLCBlKQogICAgICAgICAgICB9KQogICAgICAgIH0sCiAgICAgICAgZGVsYXk6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuIGUgPSB2LmZ4ID8gdi5meC5zcGVlZHNbZV0gfHwgZSA6IGUsIHQgPSB0IHx8ICJmeCIsIHRoaXMucXVldWUodCwgZnVuY3Rpb24odCwgbikgewogICAgICAgICAgICAgICAgdmFyIHIgPSBzZXRUaW1lb3V0KHQsIGUpOwogICAgICAgICAgICAgICAgbi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKICAgICAgICBjbGVhclF1ZXVlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXVlKGUgfHwgImZ4IiwgW10pCiAgICAgICAgfSwKICAgICAgICBwcm9taXNlOiBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgIHZhciByLCBpID0gMSwKICAgICAgICAgICAgICAgIHMgPSB2LkRlZmVycmVkKCksCiAgICAgICAgICAgICAgICBvID0gdGhpcywKICAgICAgICAgICAgICAgIHUgPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAtLWkgfHwgcy5yZXNvbHZlV2l0aChvLCBbb10pCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB0eXBlb2YgZSAhPSAic3RyaW5nIiAmJiAobiA9IGUsIGUgPSB0KSwgZSA9IGUgfHwgImZ4IjsKICAgICAgICAgICAgd2hpbGUgKHUtLSkgciA9IHYuX2RhdGEob1t1XSwgZSArICJxdWV1ZUhvb2tzIiksIHIgJiYgci5lbXB0eSAmJiAoaSsrLCByLmVtcHR5LmFkZChhKSk7CiAgICAgICAgICAgIHJldHVybiBhKCksIHMucHJvbWlzZShuKQogICAgICAgIH0KICAgIH0pOwogICAgdmFyIGosIEYsIEksIHEgPSAvW1x0XHJcbl0vZywKICAgICAgICBSID0gL1xyL2csCiAgICAgICAgVSA9IC9eKD86YnV0dG9ufGlucHV0KSQvaSwKICAgICAgICB6ID0gL14oPzpidXR0b258aW5wdXR8b2JqZWN0fHNlbGVjdHx0ZXh0YXJlYSkkL2ksCiAgICAgICAgVyA9IC9eYSg/OnJlYXwpJC9pLAogICAgICAgIFggPSAvXig/OmF1dG9mb2N1c3xhdXRvcGxheXxhc3luY3xjaGVja2VkfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkfHNlbGVjdGVkKSQvaSwKICAgICAgICBWID0gdi5zdXBwb3J0LmdldFNldEF0dHJpYnV0ZTsKICAgIHYuZm4uZXh0ZW5kKHsKICAgICAgICBhdHRyOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHJldHVybiB2LmFjY2Vzcyh0aGlzLCB2LmF0dHIsIGUsIHQsIGFyZ3VtZW50cy5sZW5ndGggPiAxKQogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdi5yZW1vdmVBdHRyKHRoaXMsIGUpCiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKICAgICAgICBwcm9wOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHJldHVybiB2LmFjY2Vzcyh0aGlzLCB2LnByb3AsIGUsIHQsIGFyZ3VtZW50cy5sZW5ndGggPiAxKQogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZSA9IHYucHJvcEZpeFtlXSB8fCBlLCB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHRoaXNbZV0gPSB0LCBkZWxldGUgdGhpc1tlXQogICAgICAgICAgICAgICAgfSBjYXRjaCAobikge30KICAgICAgICAgICAgfSkKICAgICAgICB9LAogICAgICAgIGFkZENsYXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0LCBuLCByLCBpLCBzLCBvLCB1OwogICAgICAgICAgICBpZiAodi5pc0Z1bmN0aW9uKGUpKSByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgIHYodGhpcykuYWRkQ2xhc3MoZS5jYWxsKHRoaXMsIHQsIHRoaXMuY2xhc3NOYW1lKSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChlICYmIHR5cGVvZiBlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB0ID0gZS5zcGxpdCh5KTsKICAgICAgICAgICAgICAgIGZvciAobiA9IDAsIHIgPSB0aGlzLmxlbmd0aDsgbiA8IHI7IG4rKykgewogICAgICAgICAgICAgICAgICAgIGkgPSB0aGlzW25dOwogICAgICAgICAgICAgICAgICAgIGlmIChpLm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWkuY2xhc3NOYW1lICYmIHQubGVuZ3RoID09PSAxKSBpLmNsYXNzTmFtZSA9IGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9ICIgIiArIGkuY2xhc3NOYW1lICsgIiAiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChvID0gMCwgdSA9IHQubGVuZ3RoOyBvIDwgdTsgbysrKSBzLmluZGV4T2YoIiAiICsgdFtvXSArICIgIikgPCAwICYmIChzICs9IHRbb10gKyAiICIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaS5jbGFzc05hbWUgPSB2LnRyaW0ocykKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzCiAgICAgICAgfSwKICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgbiwgciwgaSwgcywgbywgdSwgYTsKICAgICAgICAgICAgaWYgKHYuaXNGdW5jdGlvbihlKSkgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICB2KHRoaXMpLnJlbW92ZUNsYXNzKGUuY2FsbCh0aGlzLCB0LCB0aGlzLmNsYXNzTmFtZSkpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoZSAmJiB0eXBlb2YgZSA9PSAic3RyaW5nIiB8fCBlID09PSB0KSB7CiAgICAgICAgICAgICAgICBuID0gKGUgfHwgIiIpLnNwbGl0KHkpOwogICAgICAgICAgICAgICAgZm9yICh1ID0gMCwgYSA9IHRoaXMubGVuZ3RoOyB1IDwgYTsgdSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHRoaXNbdV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGkubm9kZVR5cGUgPT09IDEgJiYgaS5jbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9ICgiICIgKyBpLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShxLCAiICIpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHMgPSAwLCBvID0gbi5sZW5ndGg7IHMgPCBvOyBzKyspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoci5pbmRleE9mKCIgIiArIG5bc10gKyAiICIpID49IDApIHIgPSByLnJlcGxhY2UoIiAiICsgbltzXSArICIgIiwgIiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaS5jbGFzc05hbWUgPSBlID8gdi50cmltKHIpIDogIiIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgICB9LAogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuID0gdHlwZW9mIGUsCiAgICAgICAgICAgICAgICByID0gdHlwZW9mIHQgPT0gImJvb2xlYW4iOwogICAgICAgICAgICByZXR1cm4gdi5pc0Z1bmN0aW9uKGUpID8gdGhpcy5lYWNoKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHYodGhpcykudG9nZ2xlQ2xhc3MoZS5jYWxsKHRoaXMsIG4sIHRoaXMuY2xhc3NOYW1lLCB0KSwgdCkKICAgICAgICAgICAgfSkgOiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAobiA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwgcyA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIG8gPSB2KHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICB1ID0gdCwKICAgICAgICAgICAgICAgICAgICAgICAgYSA9IGUuc3BsaXQoeSk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGkgPSBhW3MrK10pIHUgPSByID8gdSA6ICFvLmhhc0NsYXNzKGkpLCBvW3UgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0oaSkKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gInVuZGVmaW5lZCIgfHwgbiA9PT0gImJvb2xlYW4iKSB0aGlzLmNsYXNzTmFtZSAmJiB2Ll9kYXRhKHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUpLCB0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IGUgPT09ICExID8gIiIgOiB2Ll9kYXRhKHRoaXMsICJfX2NsYXNzTmFtZV9fIikgfHwgIiIKICAgICAgICAgICAgfSkKICAgICAgICB9LAogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0ID0gIiAiICsgZSArICIgIiwKICAgICAgICAgICAgICAgIG4gPSAwLAogICAgICAgICAgICAgICAgciA9IHRoaXMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKDsgbiA8IHI7IG4rKykKICAgICAgICAgICAgICAgIGlmICh0aGlzW25dLm5vZGVUeXBlID09PSAxICYmICgiICIgKyB0aGlzW25dLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShxLCAiICIpLmluZGV4T2YodCkgPj0gMCkgcmV0dXJuICEwOwogICAgICAgICAgICByZXR1cm4gITEKICAgICAgICB9LAogICAgICAgIHZhbDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgbiwgciwgaSwgcyA9IHRoaXNbMF07CiAgICAgICAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKHMpIHJldHVybiBuID0gdi52YWxIb29rc1tzLnR5cGVdIHx8IHYudmFsSG9va3Nbcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSwgbiAmJiAiZ2V0IiBpbiBuICYmIChyID0gbi5nZXQocywgInZhbHVlIikpICE9PSB0ID8gciA6IChyID0gcy52YWx1ZSwgdHlwZW9mIHIgPT0gInN0cmluZyIgPyByLnJlcGxhY2UoUiwgIiIpIDogciA9PSBudWxsID8gIiIgOiByKTsKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpID0gdi5pc0Z1bmN0aW9uKGUpLCB0aGlzLmVhY2goZnVuY3Rpb24ocikgewogICAgICAgICAgICAgICAgdmFyIHMsIG8gPSB2KHRoaXMpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgIT09IDEpIHJldHVybjsKICAgICAgICAgICAgICAgIGkgPyBzID0gZS5jYWxsKHRoaXMsIHIsIG8udmFsKCkpIDogcyA9IGUsIHMgPT0gbnVsbCA/IHMgPSAiIiA6IHR5cGVvZiBzID09ICJudW1iZXIiID8gcyArPSAiIiA6IHYuaXNBcnJheShzKSAmJiAocyA9IHYubWFwKHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSA9PSBudWxsID8gIiIgOiBlICsgIiIKICAgICAgICAgICAgICAgIH0pKSwgbiA9IHYudmFsSG9va3NbdGhpcy50eXBlXSB8fCB2LnZhbEhvb2tzW3RoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICAgICAgICBpZiAoIW4gfHwgISgic2V0IiBpbiBuKSB8fCBuLnNldCh0aGlzLCBzLCAidmFsdWUiKSA9PT0gdCkgdGhpcy52YWx1ZSA9IHMKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9KSwgdi5leHRlbmQoewogICAgICAgIHZhbEhvb2tzOiB7CiAgICAgICAgICAgIG9wdGlvbjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBlLmF0dHJpYnV0ZXMudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICF0IHx8IHQuc3BlY2lmaWVkID8gZS52YWx1ZSA6IGUudGV4dAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWxlY3Q6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0LCBuLCByID0gZS5vcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gZS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICBzID0gZS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaSA8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBzID8gbnVsbCA6IFtdLAogICAgICAgICAgICAgICAgICAgICAgICB1ID0gcyA/IGkgKyAxIDogci5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGEgPSBpIDwgMCA/IHUgOiBzID8gaSA6IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGEgPCB1OyBhKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IHJbYV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobi5zZWxlY3RlZCB8fCBhID09PSBpKSAmJiAodi5zdXBwb3J0Lm9wdERpc2FibGVkID8gIW4uZGlzYWJsZWQgOiBuLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PT0gbnVsbCkgJiYgKCFuLnBhcmVudE5vZGUuZGlzYWJsZWQgfHwgIXYubm9kZU5hbWUobi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQgPSB2KG4pLnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMpIHJldHVybiB0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby5wdXNoKHQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG8KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IHYubWFrZUFycmF5KHQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2KGUpLmZpbmQoIm9wdGlvbiIpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB2LmluQXJyYXkodih0aGlzKS52YWwoKSwgbikgPj0gMAogICAgICAgICAgICAgICAgICAgIH0pLCBuLmxlbmd0aCB8fCAoZS5zZWxlY3RlZEluZGV4ID0gLTEpLCBuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGF0dHJGbjoge30sCiAgICAgICAgYXR0cjogZnVuY3Rpb24oZSwgbiwgciwgaSkgewogICAgICAgICAgICB2YXIgcywgbywgdSwgYSA9IGUubm9kZVR5cGU7CiAgICAgICAgICAgIGlmICghZSB8fCBhID09PSAzIHx8IGEgPT09IDggfHwgYSA9PT0gMikgcmV0dXJuOwogICAgICAgICAgICBpZiAoaSAmJiB2LmlzRnVuY3Rpb24odi5mbltuXSkpIHJldHVybiB2KGUpW25dKHIpOwogICAgICAgICAgICBpZiAodHlwZW9mIGUuZ2V0QXR0cmlidXRlID09ICJ1bmRlZmluZWQiKSByZXR1cm4gdi5wcm9wKGUsIG4sIHIpOwogICAgICAgICAgICB1ID0gYSAhPT0gMSB8fCAhdi5pc1hNTERvYyhlKSwgdSAmJiAobiA9IG4udG9Mb3dlckNhc2UoKSwgbyA9IHYuYXR0ckhvb2tzW25dIHx8IChYLnRlc3QobikgPyBGIDogaikpOwogICAgICAgICAgICBpZiAociAhPT0gdCkgewogICAgICAgICAgICAgICAgaWYgKHIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2LnJlbW92ZUF0dHIoZSwgbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbyAmJiAic2V0IiBpbiBvICYmIHUgJiYgKHMgPSBvLnNldChlLCByLCBuKSkgIT09IHQgPyBzIDogKGUuc2V0QXR0cmlidXRlKG4sIHIgKyAiIiksIHIpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG8gJiYgImdldCIgaW4gbyAmJiB1ICYmIChzID0gby5nZXQoZSwgbikpICE9PSBudWxsID8gcyA6IChzID0gZS5nZXRBdHRyaWJ1dGUobiksIHMgPT09IG51bGwgPyB0IDogcykKICAgICAgICB9LAogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgdmFyIG4sIHIsIGksIHMsIG8gPSAwOwogICAgICAgICAgICBpZiAodCAmJiBlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICByID0gdC5zcGxpdCh5KTsKICAgICAgICAgICAgICAgIGZvciAoOyBvIDwgci5sZW5ndGg7IG8rKykgaSA9IHJbb10sIGkgJiYgKG4gPSB2LnByb3BGaXhbaV0gfHwgaSwgcyA9IFgudGVzdChpKSwgcyB8fCB2LmF0dHIoZSwgaSwgIiIpLCBlLnJlbW92ZUF0dHJpYnV0ZShWID8gaSA6IG4pLCBzICYmIG4gaW4gZSAmJiAoZVtuXSA9ICExKSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXR0ckhvb2tzOiB7CiAgICAgICAgICAgIHR5cGU6IHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChVLnRlc3QoZS5ub2RlTmFtZSkgJiYgZS5wYXJlbnROb2RlKSB2LmVycm9yKCJ0eXBlIHByb3BlcnR5IGNhbid0IGJlIGNoYW5nZWQiKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICghdi5zdXBwb3J0LnJhZGlvVmFsdWUgJiYgdCA9PT0gInJhZGlvIiAmJiB2Lm5vZGVOYW1lKGUsICJpbnB1dCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gZS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuc2V0QXR0cmlidXRlKCJ0eXBlIiwgdCksIG4gJiYgKGUudmFsdWUgPSBuKSwgdAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdmFsdWU6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBqICYmIHYubm9kZU5hbWUoZSwgImJ1dHRvbiIpID8gai5nZXQoZSwgdCkgOiB0IGluIGUgPyBlLnZhbHVlIDogbnVsbAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgICAgIGlmIChqICYmIHYubm9kZU5hbWUoZSwgImJ1dHRvbiIpKSByZXR1cm4gai5zZXQoZSwgdCwgbik7CiAgICAgICAgICAgICAgICAgICAgZS52YWx1ZSA9IHQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvcEZpeDogewogICAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICAgICJmb3IiOiAiaHRtbEZvciIsCiAgICAgICAgICAgICJjbGFzcyI6ICJjbGFzc05hbWUiLAogICAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgICAgY29sc3BhbjogImNvbFNwYW4iLAogICAgICAgICAgICB1c2VtYXA6ICJ1c2VNYXAiLAogICAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgICAgY29udGVudGVkaXRhYmxlOiAiY29udGVudEVkaXRhYmxlIgogICAgICAgIH0sCiAgICAgICAgcHJvcDogZnVuY3Rpb24oZSwgbiwgcikgewogICAgICAgICAgICB2YXIgaSwgcywgbywgdSA9IGUubm9kZVR5cGU7CiAgICAgICAgICAgIGlmICghZSB8fCB1ID09PSAzIHx8IHUgPT09IDggfHwgdSA9PT0gMikgcmV0dXJuOwogICAgICAgICAgICByZXR1cm4gbyA9IHUgIT09IDEgfHwgIXYuaXNYTUxEb2MoZSksIG8gJiYgKG4gPSB2LnByb3BGaXhbbl0gfHwgbiwgcyA9IHYucHJvcEhvb2tzW25dKSwgciAhPT0gdCA/IHMgJiYgInNldCIgaW4gcyAmJiAoaSA9IHMuc2V0KGUsIHIsIG4pKSAhPT0gdCA/IGkgOiBlW25dID0gciA6IHMgJiYgImdldCIgaW4gcyAmJiAoaSA9IHMuZ2V0KGUsIG4pKSAhPT0gbnVsbCA/IGkgOiBlW25dCiAgICAgICAgfSwKICAgICAgICBwcm9wSG9va3M6IHsKICAgICAgICAgICAgdGFiSW5kZXg6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gZS5nZXRBdHRyaWJ1dGVOb2RlKCJ0YWJpbmRleCIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuICYmIG4uc3BlY2lmaWVkID8gcGFyc2VJbnQobi52YWx1ZSwgMTApIDogei50ZXN0KGUubm9kZU5hbWUpIHx8IFcudGVzdChlLm5vZGVOYW1lKSAmJiBlLmhyZWYgPyAwIDogdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksIEYgPSB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgIHZhciByLCBpID0gdi5wcm9wKGUsIG4pOwogICAgICAgICAgICByZXR1cm4gaSA9PT0gITAgfHwgdHlwZW9mIGkgIT0gImJvb2xlYW4iICYmIChyID0gZS5nZXRBdHRyaWJ1dGVOb2RlKG4pKSAmJiByLm5vZGVWYWx1ZSAhPT0gITEgPyBuLnRvTG93ZXJDYXNlKCkgOiB0CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgdmFyIHI7CiAgICAgICAgICAgIHJldHVybiB0ID09PSAhMSA/IHYucmVtb3ZlQXR0cihlLCBuKSA6IChyID0gdi5wcm9wRml4W25dIHx8IG4sIHIgaW4gZSAmJiAoZVtyXSA9ICEwKSwgZS5zZXRBdHRyaWJ1dGUobiwgbi50b0xvd2VyQ2FzZSgpKSksIG4KICAgICAgICB9CiAgICB9LCBWIHx8IChJID0gewogICAgICAgIG5hbWU6ICEwLAogICAgICAgIGlkOiAhMCwKICAgICAgICBjb29yZHM6ICEwCiAgICB9LCBqID0gdi52YWxIb29rcy5idXR0b24gPSB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgIHZhciByOwogICAgICAgICAgICByZXR1cm4gciA9IGUuZ2V0QXR0cmlidXRlTm9kZShuKSwgciAmJiAoSVtuXSA/IHIudmFsdWUgIT09ICIiIDogci5zcGVjaWZpZWQpID8gci52YWx1ZSA6IHQKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICB2YXIgciA9IGUuZ2V0QXR0cmlidXRlTm9kZShuKTsKICAgICAgICAgICAgcmV0dXJuIHIgfHwgKHIgPSBpLmNyZWF0ZUF0dHJpYnV0ZShuKSwgZS5zZXRBdHRyaWJ1dGVOb2RlKHIpKSwgci52YWx1ZSA9IHQgKyAiIgogICAgICAgIH0KICAgIH0sIHYuZWFjaChbIndpZHRoIiwgImhlaWdodCJdLCBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgdi5hdHRySG9va3NbdF0gPSB2LmV4dGVuZCh2LmF0dHJIb29rc1t0XSwgewogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgICAgIGlmIChuID09PSAiIikgcmV0dXJuIGUuc2V0QXR0cmlidXRlKHQsICJhdXRvIiksIG4KICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICB9KSwgdi5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewogICAgICAgIGdldDogai5nZXQsCiAgICAgICAgc2V0OiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIHQgPT09ICIiICYmICh0ID0gImZhbHNlIiksIGouc2V0KGUsIHQsIG4pCiAgICAgICAgfQogICAgfSksIHYuc3VwcG9ydC5ocmVmTm9ybWFsaXplZCB8fCB2LmVhY2goWyJocmVmIiwgInNyYyIsICJ3aWR0aCIsICJoZWlnaHQiXSwgZnVuY3Rpb24oZSwgbikgewogICAgICAgIHYuYXR0ckhvb2tzW25dID0gdi5leHRlbmQodi5hdHRySG9va3Nbbl0sIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IGUuZ2V0QXR0cmlidXRlKG4sIDIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHIgPT09IG51bGwgPyB0IDogcgogICAgICAgICAgICB9CiAgICAgICAgfSkKICAgIH0pLCB2LnN1cHBvcnQuc3R5bGUgfHwgKHYuYXR0ckhvb2tzLnN0eWxlID0gewogICAgICAgIGdldDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gZS5zdHlsZS5jc3NUZXh0LnRvTG93ZXJDYXNlKCkgfHwgdAogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHJldHVybiBlLnN0eWxlLmNzc1RleHQgPSB0ICsgIiIKICAgICAgICB9CiAgICB9KSwgdi5zdXBwb3J0Lm9wdFNlbGVjdGVkIHx8ICh2LnByb3BIb29rcy5zZWxlY3RlZCA9IHYuZXh0ZW5kKHYucHJvcEhvb2tzLnNlbGVjdGVkLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0ID0gZS5wYXJlbnROb2RlOwogICAgICAgICAgICByZXR1cm4gdCAmJiAodC5zZWxlY3RlZEluZGV4LCB0LnBhcmVudE5vZGUgJiYgdC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXgpLCBudWxsCiAgICAgICAgfQogICAgfSkpLCB2LnN1cHBvcnQuZW5jdHlwZSB8fCAodi5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciKSwgdi5zdXBwb3J0LmNoZWNrT24gfHwgdi5lYWNoKFsicmFkaW8iLCAiY2hlY2tib3giXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgdi52YWxIb29rc1t0aGlzXSA9IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZS52YWx1ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksIHYuZWFjaChbInJhZGlvIiwgImNoZWNrYm94Il0sIGZ1bmN0aW9uKCkgewogICAgICAgIHYudmFsSG9va3NbdGhpc10gPSB2LmV4dGVuZCh2LnZhbEhvb2tzW3RoaXNdLCB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgaWYgKHYuaXNBcnJheSh0KSkgcmV0dXJuIGUuY2hlY2tlZCA9IHYuaW5BcnJheSh2KGUpLnZhbCgpLCB0KSA+PSAwCiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgfSk7CiAgICB2YXIgJCA9IC9eKD86dGV4dGFyZWF8aW5wdXR8c2VsZWN0KSQvaSwKICAgICAgICBKID0gL14oW15cLl0qfCkoPzpcLiguKyl8KSQvLAogICAgICAgIEsgPSAvKD86Xnxccylob3ZlcihcLlxTK3wpXGIvLAogICAgICAgIFEgPSAvXmtleS8sCiAgICAgICAgRyA9IC9eKD86bW91c2V8Y29udGV4dG1lbnUpfGNsaWNrLywKICAgICAgICBZID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLAogICAgICAgIFogPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB2LmV2ZW50LnNwZWNpYWwuaG92ZXIgPyBlIDogZS5yZXBsYWNlKEssICJtb3VzZWVudGVyJDEgbW91c2VsZWF2ZSQxIikKICAgICAgICB9OwogICAgdi5ldmVudCA9IHsKICAgICAgICAgICAgYWRkOiBmdW5jdGlvbihlLCBuLCByLCBpLCBzKSB7CiAgICAgICAgICAgICAgICB2YXIgbywgdSwgYSwgZiwgbCwgYywgaCwgcCwgZCwgbSwgZzsKICAgICAgICAgICAgICAgIGlmIChlLm5vZGVUeXBlID09PSAzIHx8IGUubm9kZVR5cGUgPT09IDggfHwgIW4gfHwgIXIgfHwgIShvID0gdi5fZGF0YShlKSkpIHJldHVybjsKICAgICAgICAgICAgICAgIHIuaGFuZGxlciAmJiAoZCA9IHIsIHIgPSBkLmhhbmRsZXIsIHMgPSBkLnNlbGVjdG9yKSwgci5ndWlkIHx8IChyLmd1aWQgPSB2Lmd1aWQrKyksIGEgPSBvLmV2ZW50cywgYSB8fCAoby5ldmVudHMgPSBhID0ge30pLCB1ID0gby5oYW5kbGUsIHUgfHwgKG8uaGFuZGxlID0gdSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHYgPT0gInVuZGVmaW5lZCIgfHwgISFlICYmIHYuZXZlbnQudHJpZ2dlcmVkID09PSBlLnR5cGUgPyB0IDogdi5ldmVudC5kaXNwYXRjaC5hcHBseSh1LmVsZW0sIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgIH0sIHUuZWxlbSA9IGUpLCBuID0gdi50cmltKFoobikpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICBmb3IgKGYgPSAwOyBmIDwgbi5sZW5ndGg7IGYrKykgewogICAgICAgICAgICAgICAgICAgIGwgPSBKLmV4ZWMobltmXSkgfHwgW10sIGMgPSBsWzFdLCBoID0gKGxbMl0gfHwgIiIpLnNwbGl0KCIuIikuc29ydCgpLCBnID0gdi5ldmVudC5zcGVjaWFsW2NdIHx8IHt9LCBjID0gKHMgPyBnLmRlbGVnYXRlVHlwZSA6IGcuYmluZFR5cGUpIHx8IGMsIGcgPSB2LmV2ZW50LnNwZWNpYWxbY10gfHwge30sIHAgPSB2LmV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGMsCiAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdUeXBlOiBsWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBpLAogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyOiByLAogICAgICAgICAgICAgICAgICAgICAgICBndWlkOiByLmd1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yOiBzLAogICAgICAgICAgICAgICAgICAgICAgICBuZWVkc0NvbnRleHQ6IHMgJiYgdi5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KHMpLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IGguam9pbigiLiIpCiAgICAgICAgICAgICAgICAgICAgfSwgZCksIG0gPSBhW2NdOwogICAgICAgICAgICAgICAgICAgIGlmICghbSkgewogICAgICAgICAgICAgICAgICAgICAgICBtID0gYVtjXSA9IFtdLCBtLmRlbGVnYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWcuc2V0dXAgfHwgZy5zZXR1cC5jYWxsKGUsIGksIGgsIHUpID09PSAhMSkgZS5hZGRFdmVudExpc3RlbmVyID8gZS5hZGRFdmVudExpc3RlbmVyKGMsIHUsICExKSA6IGUuYXR0YWNoRXZlbnQgJiYgZS5hdHRhY2hFdmVudCgib24iICsgYywgdSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZy5hZGQgJiYgKGcuYWRkLmNhbGwoZSwgcCksIHAuaGFuZGxlci5ndWlkIHx8IChwLmhhbmRsZXIuZ3VpZCA9IHIuZ3VpZCkpLCBzID8gbS5zcGxpY2UobS5kZWxlZ2F0ZUNvdW50KyssIDAsIHApIDogbS5wdXNoKHApLCB2LmV2ZW50Lmdsb2JhbFtjXSA9ICEwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlID0gbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnbG9iYWw6IHt9LAogICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGUsIHQsIG4sIHIsIGkpIHsKICAgICAgICAgICAgICAgIHZhciBzLCBvLCB1LCBhLCBmLCBsLCBjLCBoLCBwLCBkLCBtLCBnID0gdi5oYXNEYXRhKGUpICYmIHYuX2RhdGEoZSk7CiAgICAgICAgICAgICAgICBpZiAoIWcgfHwgIShoID0gZy5ldmVudHMpKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ID0gdi50cmltKFoodCB8fCAiIikpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICBmb3IgKHMgPSAwOyBzIDwgdC5sZW5ndGg7IHMrKykgewogICAgICAgICAgICAgICAgICAgIG8gPSBKLmV4ZWModFtzXSkgfHwgW10sIHUgPSBhID0gb1sxXSwgZiA9IG9bMl07CiAgICAgICAgICAgICAgICAgICAgaWYgKCF1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodSBpbiBoKSB2LmV2ZW50LnJlbW92ZShlLCB1ICsgdFtzXSwgbiwgciwgITApOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwID0gdi5ldmVudC5zcGVjaWFsW3VdIHx8IHt9LCB1ID0gKHIgPyBwLmRlbGVnYXRlVHlwZSA6IHAuYmluZFR5cGUpIHx8IHUsIGQgPSBoW3VdIHx8IFtdLCBsID0gZC5sZW5ndGgsIGYgPSBmID8gbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBmLnNwbGl0KCIuIikuc29ydCgpLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIikgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIGZvciAoYyA9IDA7IGMgPCBkLmxlbmd0aDsgYysrKSBtID0gZFtjXSwgKGkgfHwgYSA9PT0gbS5vcmlnVHlwZSkgJiYgKCFuIHx8IG4uZ3VpZCA9PT0gbS5ndWlkKSAmJiAoIWYgfHwgZi50ZXN0KG0ubmFtZXNwYWNlKSkgJiYgKCFyIHx8IHIgPT09IG0uc2VsZWN0b3IgfHwgciA9PT0gIioqIiAmJiBtLnNlbGVjdG9yKSAmJiAoZC5zcGxpY2UoYy0tLCAxKSwgbS5zZWxlY3RvciAmJiBkLmRlbGVnYXRlQ291bnQtLSwgcC5yZW1vdmUgJiYgcC5yZW1vdmUuY2FsbChlLCBtKSk7CiAgICAgICAgICAgICAgICAgICAgZC5sZW5ndGggPT09IDAgJiYgbCAhPT0gZC5sZW5ndGggJiYgKCghcC50ZWFyZG93biB8fCBwLnRlYXJkb3duLmNhbGwoZSwgZiwgZy5oYW5kbGUpID09PSAhMSkgJiYgdi5yZW1vdmVFdmVudChlLCB1LCBnLmhhbmRsZSksIGRlbGV0ZSBoW3VdKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdi5pc0VtcHR5T2JqZWN0KGgpICYmIChkZWxldGUgZy5oYW5kbGUsIHYucmVtb3ZlRGF0YShlLCAiZXZlbnRzIiwgITApKQogICAgICAgICAgICB9LAogICAgICAgICAgICBjdXN0b21FdmVudDogewogICAgICAgICAgICAgICAgZ2V0RGF0YTogITAsCiAgICAgICAgICAgICAgICBzZXREYXRhOiAhMCwKICAgICAgICAgICAgICAgIGNoYW5nZURhdGE6ICEwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uKG4sIHIsIHMsIG8pIHsKICAgICAgICAgICAgICAgIGlmICghcyB8fCBzLm5vZGVUeXBlICE9PSAzICYmIHMubm9kZVR5cGUgIT09IDgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdSwgYSwgZiwgbCwgYywgaCwgcCwgZCwgbSwgZywgeSA9IG4udHlwZSB8fCBuLAogICAgICAgICAgICAgICAgICAgICAgICBiID0gW107CiAgICAgICAgICAgICAgICAgICAgaWYgKFkudGVzdCh5ICsgdi5ldmVudC50cmlnZ2VyZWQpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgeS5pbmRleE9mKCIhIikgPj0gMCAmJiAoeSA9IHkuc2xpY2UoMCwgLTEpLCBhID0gITApLCB5LmluZGV4T2YoIi4iKSA+PSAwICYmIChiID0geS5zcGxpdCgiLiIpLCB5ID0gYi5zaGlmdCgpLCBiLnNvcnQoKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCghcyB8fCB2LmV2ZW50LmN1c3RvbUV2ZW50W3ldKSAmJiAhdi5ldmVudC5nbG9iYWxbeV0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBuID0gdHlwZW9mIG4gPT0gIm9iamVjdCIgPyBuW3YuZXhwYW5kb10gPyBuIDogbmV3IHYuRXZlbnQoeSwgbikgOiBuZXcgdi5FdmVudCh5KSwgbi50eXBlID0geSwgbi5pc1RyaWdnZXIgPSAhMCwgbi5leGNsdXNpdmUgPSBhLCBuLm5hbWVzcGFjZSA9IGIuam9pbigiLiIpLCBuLm5hbWVzcGFjZV9yZSA9IG4ubmFtZXNwYWNlID8gbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBiLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIikgOiBudWxsLCBoID0geS5pbmRleE9mKCI6IikgPCAwID8gIm9uIiArIHkgOiAiIjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdSA9IHYuY2FjaGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZiBpbiB1KSB1W2ZdLmV2ZW50cyAmJiB1W2ZdLmV2ZW50c1t5XSAmJiB2LmV2ZW50LnRyaWdnZXIobiwgciwgdVtmXS5oYW5kbGUuZWxlbSwgITApOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbi5yZXN1bHQgPSB0LCBuLnRhcmdldCB8fCAobi50YXJnZXQgPSBzKSwgciA9IHIgIT0gbnVsbCA/IHYubWFrZUFycmF5KHIpIDogW10sIHIudW5zaGlmdChuKSwgcCA9IHYuZXZlbnQuc3BlY2lhbFt5XSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAocC50cmlnZ2VyICYmIHAudHJpZ2dlci5hcHBseShzLCByKSA9PT0gITEpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBtID0gWwogICAgICAgICAgICAgICAgICAgICAgICBbcywgcC5iaW5kVHlwZSB8fCB5XQogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvICYmICFwLm5vQnViYmxlICYmICF2LmlzV2luZG93KHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGcgPSBwLmRlbGVnYXRlVHlwZSB8fCB5LCBsID0gWS50ZXN0KGcgKyB5KSA/IHMgOiBzLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoYyA9IHM7IGw7IGwgPSBsLnBhcmVudE5vZGUpIG0ucHVzaChbbCwgZ10pLCBjID0gbDsKICAgICAgICAgICAgICAgICAgICAgICAgYyA9PT0gKHMub3duZXJEb2N1bWVudCB8fCBpKSAmJiBtLnB1c2goW2MuZGVmYXVsdFZpZXcgfHwgYy5wYXJlbnRXaW5kb3cgfHwgZSwgZ10pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoZiA9IDA7IGYgPCBtLmxlbmd0aCAmJiAhbi5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyBmKyspIGwgPSBtW2ZdWzBdLCBuLnR5cGUgPSBtW2ZdWzFdLCBkID0gKHYuX2RhdGEobCwgImV2ZW50cyIpIHx8IHt9KVtuLnR5cGVdICYmIHYuX2RhdGEobCwgImhhbmRsZSIpLCBkICYmIGQuYXBwbHkobCwgciksIGQgPSBoICYmIGxbaF0sIGQgJiYgdi5hY2NlcHREYXRhKGwpICYmIGQuYXBwbHkgJiYgZC5hcHBseShsLCByKSA9PT0gITEgJiYgbi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuLnR5cGUgPSB5LCAhbyAmJiAhbi5pc0RlZmF1bHRQcmV2ZW50ZWQoKSAmJiAoIXAuX2RlZmF1bHQgfHwgcC5fZGVmYXVsdC5hcHBseShzLm93bmVyRG9jdW1lbnQsIHIpID09PSAhMSkgJiYgKHkgIT09ICJjbGljayIgfHwgIXYubm9kZU5hbWUocywgImEiKSkgJiYgdi5hY2NlcHREYXRhKHMpICYmIGggJiYgc1t5XSAmJiAoeSAhPT0gImZvY3VzIiAmJiB5ICE9PSAiYmx1ciIgfHwgbi50YXJnZXQub2Zmc2V0V2lkdGggIT09IDApICYmICF2LmlzV2luZG93KHMpICYmIChjID0gc1toXSwgYyAmJiAoc1toXSA9IG51bGwpLCB2LmV2ZW50LnRyaWdnZXJlZCA9IHksIHNbeV0oKSwgdi5ldmVudC50cmlnZ2VyZWQgPSB0LCBjICYmIChzW2hdID0gYykpLCBuLnJlc3VsdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRpc3BhdGNoOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICBuID0gdi5ldmVudC5maXgobiB8fCBlLmV2ZW50KTsKICAgICAgICAgICAgICAgIHZhciByLCBpLCBzLCBvLCB1LCBhLCBmLCBjLCBoLCBwLCBkID0gKHYuX2RhdGEodGhpcywgImV2ZW50cyIpIHx8IHt9KVtuLnR5cGVdIHx8IFtdLAogICAgICAgICAgICAgICAgICAgIG0gPSBkLmRlbGVnYXRlQ291bnQsCiAgICAgICAgICAgICAgICAgICAgZyA9IGwuY2FsbChhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICAgIHkgPSAhbi5leGNsdXNpdmUgJiYgIW4ubmFtZXNwYWNlLAogICAgICAgICAgICAgICAgICAgIGIgPSB2LmV2ZW50LnNwZWNpYWxbbi50eXBlXSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICB3ID0gW107CiAgICAgICAgICAgICAgICBnWzBdID0gbiwgbi5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZiAoYi5wcmVEaXNwYXRjaCAmJiBiLnByZURpc3BhdGNoLmNhbGwodGhpcywgbikgPT09ICExKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAobSAmJiAoIW4uYnV0dG9uIHx8IG4udHlwZSAhPT0gImNsaWNrIikpCiAgICAgICAgICAgICAgICAgICAgZm9yIChzID0gbi50YXJnZXQ7IHMgIT0gdGhpczsgcyA9IHMucGFyZW50Tm9kZSB8fCB0aGlzKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5kaXNhYmxlZCAhPT0gITAgfHwgbi50eXBlICE9PSAiY2xpY2siKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1ID0ge30sIGYgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAociA9IDA7IHIgPCBtOyByKyspIGMgPSBkW3JdLCBoID0gYy5zZWxlY3RvciwgdVtoXSA9PT0gdCAmJiAodVtoXSA9IGMubmVlZHNDb250ZXh0ID8gdihoLCB0aGlzKS5pbmRleChzKSA+PSAwIDogdi5maW5kKGgsIHRoaXMsIG51bGwsIFtzXSkubGVuZ3RoKSwgdVtoXSAmJiBmLnB1c2goYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmLmxlbmd0aCAmJiB3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW06IHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlczogZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZC5sZW5ndGggPiBtICYmIHcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgZWxlbTogdGhpcywKICAgICAgICAgICAgICAgICAgICBtYXRjaGVzOiBkLnNsaWNlKG0pCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvciAociA9IDA7IHIgPCB3Lmxlbmd0aCAmJiAhbi5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyByKyspIHsKICAgICAgICAgICAgICAgICAgICBhID0gd1tyXSwgbi5jdXJyZW50VGFyZ2V0ID0gYS5lbGVtOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhLm1hdGNoZXMubGVuZ3RoICYmICFuLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjID0gYS5tYXRjaGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeSB8fCAhbi5uYW1lc3BhY2UgJiYgIWMubmFtZXNwYWNlIHx8IG4ubmFtZXNwYWNlX3JlICYmIG4ubmFtZXNwYWNlX3JlLnRlc3QoYy5uYW1lc3BhY2UpKSBuLmRhdGEgPSBjLmRhdGEsIG4uaGFuZGxlT2JqID0gYywgbyA9ICgodi5ldmVudC5zcGVjaWFsW2Mub3JpZ1R5cGVdIHx8IHt9KS5oYW5kbGUgfHwgYy5oYW5kbGVyKS5hcHBseShhLmVsZW0sIGcpLCBvICE9PSB0ICYmIChuLnJlc3VsdCA9IG8sIG8gPT09ICExICYmIChuLnByZXZlbnREZWZhdWx0KCksIG4uc3RvcFByb3BhZ2F0aW9uKCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBiLnBvc3REaXNwYXRjaCAmJiBiLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIG4pLCBuLnJlc3VsdAogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm9wczogImF0dHJDaGFuZ2UgYXR0ck5hbWUgcmVsYXRlZE5vZGUgc3JjRWxlbWVudCBhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCiAgICAgICAgICAgIGZpeEhvb2tzOiB7fSwKICAgICAgICAgICAga2V5SG9va3M6IHsKICAgICAgICAgICAgICAgIHByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlLndoaWNoID09IG51bGwgJiYgKGUud2hpY2ggPSB0LmNoYXJDb2RlICE9IG51bGwgPyB0LmNoYXJDb2RlIDogdC5rZXlDb2RlKSwgZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBtb3VzZUhvb2tzOiB7CiAgICAgICAgICAgICAgICBwcm9wczogImJ1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBmcm9tRWxlbWVudCBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCIuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24oZSwgbikgewogICAgICAgICAgICAgICAgICAgIHZhciByLCBzLCBvLCB1ID0gbi5idXR0b24sCiAgICAgICAgICAgICAgICAgICAgICAgIGEgPSBuLmZyb21FbGVtZW50OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBlLnBhZ2VYID09IG51bGwgJiYgbi5jbGllbnRYICE9IG51bGwgJiYgKHIgPSBlLnRhcmdldC5vd25lckRvY3VtZW50IHx8IGksIHMgPSByLmRvY3VtZW50RWxlbWVudCwgbyA9IHIuYm9keSwgZS5wYWdlWCA9IG4uY2xpZW50WCArIChzICYmIHMuc2Nyb2xsTGVmdCB8fCBvICYmIG8uc2Nyb2xsTGVmdCB8fCAwKSAtIChzICYmIHMuY2xpZW50TGVmdCB8fCBvICYmIG8uY2xpZW50TGVmdCB8fCAwKSwgZS5wYWdlWSA9IG4uY2xpZW50WSArIChzICYmIHMuc2Nyb2xsVG9wIHx8IG8gJiYgby5zY3JvbGxUb3AgfHwgMCkgLSAocyAmJiBzLmNsaWVudFRvcCB8fCBvICYmIG8uY2xpZW50VG9wIHx8IDApKSwgIWUucmVsYXRlZFRhcmdldCAmJiBhICYmIChlLnJlbGF0ZWRUYXJnZXQgPSBhID09PSBlLnRhcmdldCA/IG4udG9FbGVtZW50IDogYSksICFlLndoaWNoICYmIHUgIT09IHQgJiYgKGUud2hpY2ggPSB1ICYgMSA/IDEgOiB1ICYgMiA/IDMgOiB1ICYgNCA/IDIgOiAwKSwgZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmaXg6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmIChlW3YuZXhwYW5kb10pIHJldHVybiBlOwogICAgICAgICAgICAgICAgdmFyIHQsIG4sIHIgPSBlLAogICAgICAgICAgICAgICAgICAgIHMgPSB2LmV2ZW50LmZpeEhvb2tzW2UudHlwZV0gfHwge30sCiAgICAgICAgICAgICAgICAgICAgbyA9IHMucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdChzLnByb3BzKSA6IHRoaXMucHJvcHM7CiAgICAgICAgICAgICAgICBlID0gdi5FdmVudChyKTsKICAgICAgICAgICAgICAgIGZvciAodCA9IG8ubGVuZ3RoOyB0OykgbiA9IG9bLS10XSwgZVtuXSA9IHJbbl07CiAgICAgICAgICAgICAgICByZXR1cm4gZS50YXJnZXQgfHwgKGUudGFyZ2V0ID0gci5zcmNFbGVtZW50IHx8IGkpLCBlLnRhcmdldC5ub2RlVHlwZSA9PT0gMyAmJiAoZS50YXJnZXQgPSBlLnRhcmdldC5wYXJlbnROb2RlKSwgZS5tZXRhS2V5ID0gISFlLm1ldGFLZXksIHMuZmlsdGVyID8gcy5maWx0ZXIoZSwgcikgOiBlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNwZWNpYWw6IHsKICAgICAgICAgICAgICAgIGxvYWQ6IHsKICAgICAgICAgICAgICAgICAgICBub0J1YmJsZTogITAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb2N1czogewogICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlVHlwZTogImZvY3VzaW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYmx1cjogewogICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlVHlwZTogImZvY3Vzb3V0IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGJlZm9yZXVubG9hZDogewogICAgICAgICAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYuaXNXaW5kb3codGhpcykgJiYgKHRoaXMub25iZWZvcmV1bmxvYWQgPSBuKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbmJlZm9yZXVubG9hZCA9PT0gdCAmJiAodGhpcy5vbmJlZm9yZXVubG9hZCA9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzaW11bGF0ZTogZnVuY3Rpb24oZSwgdCwgbiwgcikgewogICAgICAgICAgICAgICAgdmFyIGkgPSB2LmV4dGVuZChuZXcgdi5FdmVudCwgbiwgewogICAgICAgICAgICAgICAgICAgIHR5cGU6IGUsCiAgICAgICAgICAgICAgICAgICAgaXNTaW11bGF0ZWQ6ICEwLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQ6IHt9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHIgPyB2LmV2ZW50LnRyaWdnZXIoaSwgbnVsbCwgdCkgOiB2LmV2ZW50LmRpc3BhdGNoLmNhbGwodCwgaSksIGkuaXNEZWZhdWx0UHJldmVudGVkKCkgJiYgbi5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgIH0KICAgICAgICB9LCB2LmV2ZW50LmhhbmRsZSA9IHYuZXZlbnQuZGlzcGF0Y2gsIHYucmVtb3ZlRXZlbnQgPSBpLnJlbW92ZUV2ZW50TGlzdGVuZXIgPyBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIGUucmVtb3ZlRXZlbnRMaXN0ZW5lciAmJiBlLnJlbW92ZUV2ZW50TGlzdGVuZXIodCwgbiwgITEpCiAgICAgICAgfSA6IGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgdmFyIHIgPSAib24iICsgdDsKICAgICAgICAgICAgZS5kZXRhY2hFdmVudCAmJiAodHlwZW9mIGVbcl0gPT0gInVuZGVmaW5lZCIgJiYgKGVbcl0gPSBudWxsKSwgZS5kZXRhY2hFdmVudChyLCBuKSkKICAgICAgICB9LCB2LkV2ZW50ID0gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2Ygdi5FdmVudCkpIHJldHVybiBuZXcgdi5FdmVudChlLCB0KTsKICAgICAgICAgICAgZSAmJiBlLnR5cGUgPyAodGhpcy5vcmlnaW5hbEV2ZW50ID0gZSwgdGhpcy50eXBlID0gZS50eXBlLCB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGUuZGVmYXVsdFByZXZlbnRlZCB8fCBlLnJldHVyblZhbHVlID09PSAhMSB8fCBlLmdldFByZXZlbnREZWZhdWx0ICYmIGUuZ2V0UHJldmVudERlZmF1bHQoKSA/IHR0IDogZXQpIDogdGhpcy50eXBlID0gZSwgdCAmJiB2LmV4dGVuZCh0aGlzLCB0KSwgdGhpcy50aW1lU3RhbXAgPSBlICYmIGUudGltZVN0YW1wIHx8IHYubm93KCksIHRoaXNbdi5leHBhbmRvXSA9ICEwCiAgICAgICAgfSwgdi5FdmVudC5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gdHQ7CiAgICAgICAgICAgICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgICAgICAgICAgIGlmICghZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCA/IGUucHJldmVudERlZmF1bHQoKSA6IGUucmV0dXJuVmFsdWUgPSAhMQogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHR0OwogICAgICAgICAgICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIWUpIHJldHVybjsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uICYmIGUuc3RvcFByb3BhZ2F0aW9uKCksIGUuY2FuY2VsQnViYmxlID0gITAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSB0dCwgdGhpcy5zdG9wUHJvcGFnYXRpb24oKQogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0RlZmF1bHRQcmV2ZW50ZWQ6IGV0LAogICAgICAgICAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogZXQsCiAgICAgICAgICAgIGlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiBldAogICAgICAgIH0sIHYuZWFjaCh7CiAgICAgICAgICAgIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAogICAgICAgICAgICBtb3VzZWxlYXZlOiAibW91c2VvdXQiCiAgICAgICAgfSwgZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB2LmV2ZW50LnNwZWNpYWxbZV0gPSB7CiAgICAgICAgICAgICAgICBkZWxlZ2F0ZVR5cGU6IHQsCiAgICAgICAgICAgICAgICBiaW5kVHlwZTogdCwKICAgICAgICAgICAgICAgIGhhbmRsZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuLCByID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGUucmVsYXRlZFRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgcyA9IGUuaGFuZGxlT2JqLAogICAgICAgICAgICAgICAgICAgICAgICBvID0gcy5zZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIWkgfHwgaSAhPT0gciAmJiAhdi5jb250YWlucyhyLCBpKSkgZS50eXBlID0gcy5vcmlnVHlwZSwgbiA9IHMuaGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCBlLnR5cGUgPSB0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KSwgdi5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgfHwgKHYuZXZlbnQuc3BlY2lhbC5zdWJtaXQgPSB7CiAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh2Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikpIHJldHVybiAhMTsKICAgICAgICAgICAgICAgIHYuZXZlbnQuYWRkKHRoaXMsICJjbGljay5fc3VibWl0IGtleXByZXNzLl9zdWJtaXQiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBlLnRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgciA9IHYubm9kZU5hbWUobiwgImlucHV0IikgfHwgdi5ub2RlTmFtZShuLCAiYnV0dG9uIikgPyBuLmZvcm0gOiB0OwogICAgICAgICAgICAgICAgICAgIHIgJiYgIXYuX2RhdGEociwgIl9zdWJtaXRfYXR0YWNoZWQiKSAmJiAodi5ldmVudC5hZGQociwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLl9zdWJtaXRfYnViYmxlID0gITAKICAgICAgICAgICAgICAgICAgICB9KSwgdi5fZGF0YShyLCAiX3N1Ym1pdF9hdHRhY2hlZCIsICEwKSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgZS5fc3VibWl0X2J1YmJsZSAmJiAoZGVsZXRlIGUuX3N1Ym1pdF9idWJibGUsIHRoaXMucGFyZW50Tm9kZSAmJiAhZS5pc1RyaWdnZXIgJiYgdi5ldmVudC5zaW11bGF0ZSgic3VibWl0IiwgdGhpcy5wYXJlbnROb2RlLCBlLCAhMCkpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh2Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikpIHJldHVybiAhMTsKICAgICAgICAgICAgICAgIHYuZXZlbnQucmVtb3ZlKHRoaXMsICIuX3N1Ym1pdCIpCiAgICAgICAgICAgIH0KICAgICAgICB9KSwgdi5zdXBwb3J0LmNoYW5nZUJ1YmJsZXMgfHwgKHYuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CiAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICgkLnRlc3QodGhpcy5ub2RlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIikgdi5ldmVudC5hZGQodGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiAmJiAodGhpcy5fanVzdF9jaGFuZ2VkID0gITApCiAgICAgICAgICAgICAgICAgICAgfSksIHYuZXZlbnQuYWRkKHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9qdXN0X2NoYW5nZWQgJiYgIWUuaXNUcmlnZ2VyICYmICh0aGlzLl9qdXN0X2NoYW5nZWQgPSAhMSksIHYuZXZlbnQuc2ltdWxhdGUoImNoYW5nZSIsIHRoaXMsIGUsICEwKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAhMQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdi5ldmVudC5hZGQodGhpcywgImJlZm9yZWFjdGl2YXRlLl9jaGFuZ2UiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBlLnRhcmdldDsKICAgICAgICAgICAgICAgICAgICAkLnRlc3QodC5ub2RlTmFtZSkgJiYgIXYuX2RhdGEodCwgIl9jaGFuZ2VfYXR0YWNoZWQiKSAmJiAodi5ldmVudC5hZGQodCwgImNoYW5nZS5fY2hhbmdlIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUgJiYgIWUuaXNTaW11bGF0ZWQgJiYgIWUuaXNUcmlnZ2VyICYmIHYuZXZlbnQuc2ltdWxhdGUoImNoYW5nZSIsIHRoaXMucGFyZW50Tm9kZSwgZSwgITApCiAgICAgICAgICAgICAgICAgICAgfSksIHYuX2RhdGEodCwgIl9jaGFuZ2VfYXR0YWNoZWQiLCAhMCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBoYW5kbGU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcyAhPT0gdCB8fCBlLmlzU2ltdWxhdGVkIHx8IGUuaXNUcmlnZ2VyIHx8IHQudHlwZSAhPT0gInJhZGlvIiAmJiB0LnR5cGUgIT09ICJjaGVja2JveCIpIHJldHVybiBlLmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHYuZXZlbnQucmVtb3ZlKHRoaXMsICIuX2NoYW5nZSIpLCAhJC50ZXN0KHRoaXMubm9kZU5hbWUpCiAgICAgICAgICAgIH0KICAgICAgICB9KSwgdi5zdXBwb3J0LmZvY3VzaW5CdWJibGVzIHx8IHYuZWFjaCh7CiAgICAgICAgICAgIGZvY3VzOiAiZm9jdXNpbiIsCiAgICAgICAgICAgIGJsdXI6ICJmb2N1c291dCIKICAgICAgICB9LCBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuID0gMCwKICAgICAgICAgICAgICAgIHIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgdi5ldmVudC5zaW11bGF0ZSh0LCBlLnRhcmdldCwgdi5ldmVudC5maXgoZSksICEwKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgdi5ldmVudC5zcGVjaWFsW3RdID0gewogICAgICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIG4rKyA9PT0gMCAmJiBpLmFkZEV2ZW50TGlzdGVuZXIoZSwgciwgITApCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIC0tbiA9PT0gMCAmJiBpLnJlbW92ZUV2ZW50TGlzdGVuZXIoZSwgciwgITApCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KSwgdi5mbi5leHRlbmQoewogICAgICAgICAgICBvbjogZnVuY3Rpb24oZSwgbiwgciwgaSwgcykgewogICAgICAgICAgICAgICAgdmFyIG8sIHU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlb2YgbiAhPSAic3RyaW5nIiAmJiAociA9IHIgfHwgbiwgbiA9IHQpOwogICAgICAgICAgICAgICAgICAgIGZvciAodSBpbiBlKSB0aGlzLm9uKHUsIG4sIHIsIGVbdV0sIHMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByID09IG51bGwgJiYgaSA9PSBudWxsID8gKGkgPSBuLCByID0gbiA9IHQpIDogaSA9PSBudWxsICYmICh0eXBlb2YgbiA9PSAic3RyaW5nIiA/IChpID0gciwgciA9IHQpIDogKGkgPSByLCByID0gbiwgbiA9IHQpKTsKICAgICAgICAgICAgICAgIGlmIChpID09PSAhMSkgaSA9IGV0OwogICAgICAgICAgICAgICAgZWxzZSBpZiAoIWkpIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgcmV0dXJuIHMgPT09IDEgJiYgKG8gPSBpLCBpID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2KCkub2ZmKGUpLCBvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgIH0sIGkuZ3VpZCA9IG8uZ3VpZCB8fCAoby5ndWlkID0gdi5ndWlkKyspKSwgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHYuZXZlbnQuYWRkKHRoaXMsIGUsIGksIHIsIG4pCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBvbmU6IGZ1bmN0aW9uKGUsIHQsIG4sIHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKGUsIHQsIG4sIHIsIDEpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9mZjogZnVuY3Rpb24oZSwgbiwgcikgewogICAgICAgICAgICAgICAgdmFyIGksIHM7CiAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLnByZXZlbnREZWZhdWx0ICYmIGUuaGFuZGxlT2JqKSByZXR1cm4gaSA9IGUuaGFuZGxlT2JqLCB2KGUuZGVsZWdhdGVUYXJnZXQpLm9mZihpLm5hbWVzcGFjZSA/IGkub3JpZ1R5cGUgKyAiLiIgKyBpLm5hbWVzcGFjZSA6IGkub3JpZ1R5cGUsIGkuc2VsZWN0b3IsIGkuaGFuZGxlciksIHRoaXM7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHMgaW4gZSkgdGhpcy5vZmYocywgbiwgZVtzXSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChuID09PSAhMSB8fCB0eXBlb2YgbiA9PSAiZnVuY3Rpb24iKSByID0gbiwgbiA9IHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gciA9PT0gITEgJiYgKHIgPSBldCksIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2LmV2ZW50LnJlbW92ZSh0aGlzLCBlLCByLCBuKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYmluZDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub24oZSwgbnVsbCwgdCwgbikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5iaW5kOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vZmYoZSwgbnVsbCwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbGl2ZTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgcmV0dXJuIHYodGhpcy5jb250ZXh0KS5vbihlLCB0aGlzLnNlbGVjdG9yLCB0LCBuKSwgdGhpcwogICAgICAgICAgICB9LAogICAgICAgICAgICBkaWU6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2KHRoaXMuY29udGV4dCkub2ZmKGUsIHRoaXMuc2VsZWN0b3IgfHwgIioqIiwgdCksIHRoaXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVsZWdhdGU6IGZ1bmN0aW9uKGUsIHQsIG4sIHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKHQsIGUsIG4sIHIpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gdGhpcy5vZmYoZSwgIioqIikgOiB0aGlzLm9mZih0LCBlIHx8ICIqKiIsIG4pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdi5ldmVudC50cmlnZ2VyKGUsIHQsIHRoaXMpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHJldHVybiB2LmV2ZW50LnRyaWdnZXIoZSwgdCwgdGhpc1swXSwgITApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvZ2dsZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBhcmd1bWVudHMsCiAgICAgICAgICAgICAgICAgICAgbiA9IGUuZ3VpZCB8fCB2Lmd1aWQrKywKICAgICAgICAgICAgICAgICAgICByID0gMCwKICAgICAgICAgICAgICAgICAgICBpID0gZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9ICh2Ll9kYXRhKHRoaXMsICJsYXN0VG9nZ2xlIiArIGUuZ3VpZCkgfHwgMCkgJSByOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdi5fZGF0YSh0aGlzLCAibGFzdFRvZ2dsZSIgKyBlLmd1aWQsIGkgKyAxKSwgbi5wcmV2ZW50RGVmYXVsdCgpLCB0W2ldLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgITEKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaS5ndWlkID0gbjsKICAgICAgICAgICAgICAgIHdoaWxlIChyIDwgdC5sZW5ndGgpIHRbcisrXS5ndWlkID0gbjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsaWNrKGkpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhvdmVyOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGUpLm1vdXNlbGVhdmUodCB8fCBlKQogICAgICAgICAgICB9CiAgICAgICAgfSksIHYuZWFjaCgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudSIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB2LmZuW3RdID0gZnVuY3Rpb24oZSwgbikgewogICAgICAgICAgICAgICAgcmV0dXJuIG4gPT0gbnVsbCAmJiAobiA9IGUsIGUgPSBudWxsKSwgYXJndW1lbnRzLmxlbmd0aCA+IDAgPyB0aGlzLm9uKHQsIG51bGwsIGUsIG4pIDogdGhpcy50cmlnZ2VyKHQpCiAgICAgICAgICAgIH0sIFEudGVzdCh0KSAmJiAodi5ldmVudC5maXhIb29rc1t0XSA9IHYuZXZlbnQua2V5SG9va3MpLCBHLnRlc3QodCkgJiYgKHYuZXZlbnQuZml4SG9va3NbdF0gPSB2LmV2ZW50Lm1vdXNlSG9va3MpCiAgICAgICAgfSksCiAgICAgICAgZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICBmdW5jdGlvbiBudChlLCB0LCBuLCByKSB7CiAgICAgICAgICAgICAgICBuID0gbiB8fCBbXSwgdCA9IHQgfHwgZzsKICAgICAgICAgICAgICAgIHZhciBpLCBzLCBhLCBmLCBsID0gdC5ub2RlVHlwZTsKICAgICAgICAgICAgICAgIGlmICghZSB8fCB0eXBlb2YgZSAhPSAic3RyaW5nIikgcmV0dXJuIG47CiAgICAgICAgICAgICAgICBpZiAobCAhPT0gMSAmJiBsICE9PSA5KSByZXR1cm4gW107CiAgICAgICAgICAgICAgICBhID0gbyh0KTsKICAgICAgICAgICAgICAgIGlmICghYSAmJiAhcikKICAgICAgICAgICAgICAgICAgICBpZiAoaSA9IFIuZXhlYyhlKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYgPSBpWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobCA9PT0gOSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSB0LmdldEVsZW1lbnRCeUlkKGYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcyB8fCAhcy5wYXJlbnROb2RlKSByZXR1cm4gbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5pZCA9PT0gZikgcmV0dXJuIG4ucHVzaChzKSwgbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0Lm93bmVyRG9jdW1lbnQgJiYgKHMgPSB0Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZikpICYmIHUodCwgcykgJiYgcy5pZCA9PT0gZikgcmV0dXJuIG4ucHVzaChzKSwgbgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlbMl0pIHJldHVybiBTLmFwcGx5KG4sIHguY2FsbCh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKGUpLCAwKSksIG47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGYgPSBpWzNdKSAmJiBaICYmIHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgcmV0dXJuIFMuYXBwbHkobiwgeC5jYWxsKHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShmKSwgMCkpLCBuCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2dChlLnJlcGxhY2UoaiwgIiQxIiksIHQsIG4sIHIsIGEpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJ0KGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSB0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4gPT09ICJpbnB1dCIgJiYgdC50eXBlID09PSBlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGl0KGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSB0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuID09PSAiaW5wdXQiIHx8IG4gPT09ICJidXR0b24iKSAmJiB0LnR5cGUgPT09IGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc3QoZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIE4oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ID0gK3QsIE4oZnVuY3Rpb24obiwgcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSwgcyA9IGUoW10sIG4ubGVuZ3RoLCB0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG8tLSkgbltpID0gc1tvXV0gJiYgKG5baV0gPSAhKHJbaV0gPSBuW2ldKSkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gb3QoZSwgdCwgbikgewogICAgICAgICAgICAgICAgaWYgKGUgPT09IHQpIHJldHVybiBuOwogICAgICAgICAgICAgICAgdmFyIHIgPSBlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgd2hpbGUgKHIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAociA9PT0gdCkgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgICAgIHIgPSByLm5leHRTaWJsaW5nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiB1dChlLCB0KSB7CiAgICAgICAgICAgICAgICB2YXIgbiwgciwgcywgbywgdSwgYSwgZiwgbCA9IExbZF1bZSArICIgIl07CiAgICAgICAgICAgICAgICBpZiAobCkgcmV0dXJuIHQgPyAwIDogbC5zbGljZSgwKTsKICAgICAgICAgICAgICAgIHUgPSBlLCBhID0gW10sIGYgPSBpLnByZUZpbHRlcjsKICAgICAgICAgICAgICAgIHdoaWxlICh1KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFuIHx8IChyID0gRi5leGVjKHUpKSkgciAmJiAodSA9IHUuc2xpY2UoclswXS5sZW5ndGgpIHx8IHUpLCBhLnB1c2gocyA9IFtdKTsKICAgICAgICAgICAgICAgICAgICBuID0gITE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHIgPSBJLmV4ZWModSkpIHMucHVzaChuID0gbmV3IG0oci5zaGlmdCgpKSksIHUgPSB1LnNsaWNlKG4ubGVuZ3RoKSwgbi50eXBlID0gclswXS5yZXBsYWNlKGosICIgIik7CiAgICAgICAgICAgICAgICAgICAgZm9yIChvIGluIGkuZmlsdGVyKShyID0gSltvXS5leGVjKHUpKSAmJiAoIWZbb10gfHwgKHIgPSBmW29dKHIpKSkgJiYgKHMucHVzaChuID0gbmV3IG0oci5zaGlmdCgpKSksIHUgPSB1LnNsaWNlKG4ubGVuZ3RoKSwgbi50eXBlID0gbywgbi5tYXRjaGVzID0gcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFuKSBicmVhawogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHQgPyB1Lmxlbmd0aCA6IHUgPyBudC5lcnJvcihlKSA6IEwoZSwgYSkuc2xpY2UoMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gYXQoZSwgdCwgcikgewogICAgICAgICAgICAgICAgdmFyIGkgPSB0LmRpciwKICAgICAgICAgICAgICAgICAgICBzID0gciAmJiB0LmRpciA9PT0gInBhcmVudE5vZGUiLAogICAgICAgICAgICAgICAgICAgIG8gPSB3Kys7CiAgICAgICAgICAgICAgICByZXR1cm4gdC5maXJzdCA/IGZ1bmN0aW9uKHQsIG4sIHIpIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAodCA9IHRbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzIHx8IHQubm9kZVR5cGUgPT09IDEpIHJldHVybiBlKHQsIG4sIHIpCiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24odCwgciwgdSkgewogICAgICAgICAgICAgICAgICAgIGlmICghdSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYSwgZiA9IGIgKyAiICIgKyBvICsgIiAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbCA9IGYgKyBuOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAodCA9IHRbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocyB8fCB0Lm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChhID0gdFtkXSkgPT09IGwpIHJldHVybiB0LnNpenNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGEgPT0gInN0cmluZyIgJiYgYS5pbmRleE9mKGYpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnNpenNldCkgcmV0dXJuIHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0W2RdID0gbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUodCwgciwgdSkpIHJldHVybiB0LnNpenNldCA9ICEwLCB0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNpenNldCA9ICExCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAodCA9IHRbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocyB8fCB0Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKHQsIHIsIHUpKSByZXR1cm4gdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBmdChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZS5sZW5ndGggPiAxID8gZnVuY3Rpb24odCwgbiwgcikgewogICAgICAgICAgICAgICAgICAgIHZhciBpID0gZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlW2ldKHQsIG4sIHIpKSByZXR1cm4gITE7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEwCiAgICAgICAgICAgICAgICB9IDogZVswXQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBsdChlLCB0LCBuLCByLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgcywgbyA9IFtdLAogICAgICAgICAgICAgICAgICAgIHUgPSAwLAogICAgICAgICAgICAgICAgICAgIGEgPSBlLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBmID0gdCAhPSBudWxsOwogICAgICAgICAgICAgICAgZm9yICg7IHUgPCBhOyB1KyspCiAgICAgICAgICAgICAgICAgICAgaWYgKHMgPSBlW3VdKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW4gfHwgbihzLCByLCBpKSkgby5wdXNoKHMpLCBmICYmIHQucHVzaCh1KTsKICAgICAgICAgICAgICAgIHJldHVybiBvCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGN0KGUsIHQsIG4sIHIsIGksIHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiByICYmICFyW2RdICYmIChyID0gY3QocikpLCBpICYmICFpW2RdICYmIChpID0gY3QoaSwgcykpLCBOKGZ1bmN0aW9uKHMsIG8sIHUsIGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZiwgbCwgYywgaCA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBwID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGQgPSBvLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHMgfHwgZHQodCB8fCAiKiIsIHUubm9kZVR5cGUgPyBbdV0gOiB1LCBbXSksCiAgICAgICAgICAgICAgICAgICAgICAgIG0gPSBlICYmIChzIHx8ICF0KSA/IGx0KHYsIGgsIGUsIHUsIGEpIDogdiwKICAgICAgICAgICAgICAgICAgICAgICAgZyA9IG4gPyBpIHx8IChzID8gZSA6IGQgfHwgcikgPyBbXSA6IG8gOiBtOwogICAgICAgICAgICAgICAgICAgIG4gJiYgbihtLCBnLCB1LCBhKTsKICAgICAgICAgICAgICAgICAgICBpZiAocikgewogICAgICAgICAgICAgICAgICAgICAgICBmID0gbHQoZywgcCksIHIoZiwgW10sIHUsIGEpLCBsID0gZi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsLS0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA9IGZbbF0pIGdbcFtsXV0gPSAhKG1bcFtsXV0gPSBjKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAocykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSB8fCBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBbXSwgbCA9IGcubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsLS0pKGMgPSBnW2xdKSAmJiBmLnB1c2gobVtsXSA9IGMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkobnVsbCwgZyA9IFtdLCBmLCBhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbCA9IGcubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGwtLSkoYyA9IGdbbF0pICYmIChmID0gaSA/IFQuY2FsbChzLCBjKSA6IGhbbF0pID4gLTEgJiYgKHNbZl0gPSAhKG9bZl0gPSBjKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBnID0gbHQoZyA9PT0gbyA/IGcuc3BsaWNlKGQsIGcubGVuZ3RoKSA6IGcpLCBpID8gaShudWxsLCBvLCBnLCBhKSA6IFMuYXBwbHkobywgZykKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGh0KGUpIHsKICAgICAgICAgICAgICAgIHZhciB0LCBuLCByLCBzID0gZS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgbyA9IGkucmVsYXRpdmVbZVswXS50eXBlXSwKICAgICAgICAgICAgICAgICAgICB1ID0gbyB8fCBpLnJlbGF0aXZlWyIgIl0sCiAgICAgICAgICAgICAgICAgICAgYSA9IG8gPyAxIDogMCwKICAgICAgICAgICAgICAgICAgICBmID0gYXQoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSA9PT0gdAogICAgICAgICAgICAgICAgICAgIH0sIHUsICEwKSwKICAgICAgICAgICAgICAgICAgICBsID0gYXQoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVC5jYWxsKHQsIGUpID4gLTEKICAgICAgICAgICAgICAgICAgICB9LCB1LCAhMCksCiAgICAgICAgICAgICAgICAgICAgaCA9IFtmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhbyAmJiAociB8fCBuICE9PSBjKSB8fCAoKHQgPSBuKS5ub2RlVHlwZSA/IGYoZSwgbiwgcikgOiBsKGUsIG4sIHIpKQogICAgICAgICAgICAgICAgICAgIH1dOwogICAgICAgICAgICAgICAgZm9yICg7IGEgPCBzOyBhKyspCiAgICAgICAgICAgICAgICAgICAgaWYgKG4gPSBpLnJlbGF0aXZlW2VbYV0udHlwZV0pIGggPSBbYXQoZnQoaCksIG4pXTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IGkuZmlsdGVyW2VbYV0udHlwZV0uYXBwbHkobnVsbCwgZVthXS5tYXRjaGVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5bZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIgPSArK2E7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgciA8IHM7IHIrKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaS5yZWxhdGl2ZVtlW3JdLnR5cGVdKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdChhID4gMSAmJiBmdChoKSwgYSA+IDEgJiYgZS5zbGljZSgwLCBhIC0gMSkuam9pbigiIikucmVwbGFjZShqLCAiJDEiKSwgbiwgYSA8IHIgJiYgaHQoZS5zbGljZShhLCByKSksIHIgPCBzICYmIGh0KGUgPSBlLnNsaWNlKHIpKSwgciA8IHMgJiYgZS5qb2luKCIiKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoLnB1c2gobikKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZnQoaCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gcHQoZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIHIgPSB0Lmxlbmd0aCA+IDAsCiAgICAgICAgICAgICAgICAgICAgcyA9IGUubGVuZ3RoID4gMCwKICAgICAgICAgICAgICAgICAgICBvID0gZnVuY3Rpb24odSwgYSwgZiwgbCwgaCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcCwgZCwgdiwgbSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3ID0gIjAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IHUgJiYgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUID0gaCAhPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTiA9IGMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDID0gdSB8fCBzICYmIGkuZmluZC5UQUcoIioiLCBoICYmIGEucGFyZW50Tm9kZSB8fCBhKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgPSBiICs9IE4gPT0gbnVsbCA/IDEgOiBNYXRoLkU7CiAgICAgICAgICAgICAgICAgICAgICAgIFQgJiYgKGMgPSBhICE9PSBnICYmIGEsIG4gPSBvLmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAocCA9IENbd10pICE9IG51bGw7IHcrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMgJiYgcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZCA9IDA7IHYgPSBlW2RdOyBkKyspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KHAsIGEsIGYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsLnB1c2gocCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVCAmJiAoYiA9IGssIG4gPSArK28uZWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByICYmICgocCA9ICF2ICYmIHApICYmIHktLSwgdSAmJiB4LnB1c2gocCkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgeSArPSB3OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAociAmJiB3ICE9PSB5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGQgPSAwOyB2ID0gdFtkXTsgZCsrKSB2KHgsIG0sIGEsIGYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeSA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh3LS0pICF4W3ddICYmICFtW3ddICYmIChtW3ddID0gRS5jYWxsKGwpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtID0gbHQobSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFMuYXBwbHkobCwgbSksIFQgJiYgIXUgJiYgbS5sZW5ndGggPiAwICYmIHkgKyB0Lmxlbmd0aCA+IDEgJiYgbnQudW5pcXVlU29ydChsKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUICYmIChiID0gaywgYyA9IE4pLCB4CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBvLmVsID0gMCwgciA/IE4obykgOiBvCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGR0KGUsIHQsIG4pIHsKICAgICAgICAgICAgICAgIHZhciByID0gMCwKICAgICAgICAgICAgICAgICAgICBpID0gdC5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKDsgciA8IGk7IHIrKykgbnQoZSwgdFtyXSwgbik7CiAgICAgICAgICAgICAgICByZXR1cm4gbgogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiB2dChlLCB0LCBuLCByLCBzKSB7CiAgICAgICAgICAgICAgICB2YXIgbywgdSwgZiwgbCwgYywgaCA9IHV0KGUpLAogICAgICAgICAgICAgICAgICAgIHAgPSBoLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICghciAmJiBoLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIHUgPSBoWzBdID0gaFswXS5zbGljZSgwKTsKICAgICAgICAgICAgICAgICAgICBpZiAodS5sZW5ndGggPiAyICYmIChmID0gdVswXSkudHlwZSA9PT0gIklEIiAmJiB0Lm5vZGVUeXBlID09PSA5ICYmICFzICYmIGkucmVsYXRpdmVbdVsxXS50eXBlXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0ID0gaS5maW5kLklEKGYubWF0Y2hlc1swXS5yZXBsYWNlKCQsICIiKSwgdCwgcylbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuIG47CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBlLnNsaWNlKHUuc2hpZnQoKS5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAobyA9IEouUE9TLnRlc3QoZSkgPyAtMSA6IHUubGVuZ3RoIC0gMTsgbyA+PSAwOyBvLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZiA9IHVbb107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpLnJlbGF0aXZlW2wgPSBmLnR5cGVdKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPSBpLmZpbmRbbF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAociA9IGMoZi5tYXRjaGVzWzBdLnJlcGxhY2UoJCwgIiIpLCB6LnRlc3QodVswXS50eXBlKSAmJiB0LnBhcmVudE5vZGUgfHwgdCwgcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1LnNwbGljZShvLCAxKSwgZSA9IHIubGVuZ3RoICYmIHUuam9pbigiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlKSByZXR1cm4gUy5hcHBseShuLCB4LmNhbGwociwgMCkpLCBuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGEoZSwgaCkociwgdCwgcywgbiwgei50ZXN0KGUpKSwgbgogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBtdCgpIHt9CiAgICAgICAgICAgIHZhciBuLCByLCBpLCBzLCBvLCB1LCBhLCBmLCBsLCBjLCBoID0gITAsCiAgICAgICAgICAgICAgICBwID0gInVuZGVmaW5lZCIsCiAgICAgICAgICAgICAgICBkID0gKCJzaXpjYWNoZSIgKyBNYXRoLnJhbmRvbSgpKS5yZXBsYWNlKCIuIiwgIiIpLAogICAgICAgICAgICAgICAgbSA9IFN0cmluZywKICAgICAgICAgICAgICAgIGcgPSBlLmRvY3VtZW50LAogICAgICAgICAgICAgICAgeSA9IGcuZG9jdW1lbnRFbGVtZW50LAogICAgICAgICAgICAgICAgYiA9IDAsCiAgICAgICAgICAgICAgICB3ID0gMCwKICAgICAgICAgICAgICAgIEUgPSBbXS5wb3AsCiAgICAgICAgICAgICAgICBTID0gW10ucHVzaCwKICAgICAgICAgICAgICAgIHggPSBbXS5zbGljZSwKICAgICAgICAgICAgICAgIFQgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgdCA8IG47IHQrKykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbdF0gPT09IGUpIHJldHVybiB0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiAtMQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIE4gPSBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbZF0gPSB0ID09IG51bGwgfHwgdCwgZQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICB0ID0gW107CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE4oZnVuY3Rpb24obiwgcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5wdXNoKG4pID4gaS5jYWNoZUxlbmd0aCAmJiBkZWxldGUgZVt0LnNoaWZ0KCldLCBlW24gKyAiICJdID0gcgogICAgICAgICAgICAgICAgICAgIH0sIGUpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgayA9IEMoKSwKICAgICAgICAgICAgICAgIEwgPSBDKCksCiAgICAgICAgICAgICAgICBBID0gQygpLAogICAgICAgICAgICAgICAgTyA9ICJbXFx4MjBcXHRcXHJcXG5cXGZdIiwKICAgICAgICAgICAgICAgIE0gPSAiKD86XFxcXC58Wy1cXHddfFteXFx4MDAtXFx4YTBdKSsiLAogICAgICAgICAgICAgICAgXyA9IE0ucmVwbGFjZSgidyIsICJ3IyIpLAogICAgICAgICAgICAgICAgRCA9ICIoWypeJHwhfl0/PSkiLAogICAgICAgICAgICAgICAgUCA9ICJcXFsiICsgTyArICIqKCIgKyBNICsgIikiICsgTyArICIqKD86IiArIEQgKyBPICsgIiooPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgiICsgXyArICIpfCl8KSIgKyBPICsgIipcXF0iLAogICAgICAgICAgICAgICAgSCA9ICI6KCIgKyBNICsgIikoPzpcXCgoPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwyfChbXigpW1xcXV0qfCg/Oig/OiIgKyBQICsgIil8W146XXxcXFxcLikqfC4qKSlcXCl8KSIsCiAgICAgICAgICAgICAgICBCID0gIjooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArIE8gKyAiKigoPzotXFxkKT9cXGQqKSIgKyBPICsgIipcXCl8KSg/PVteLV18JCkiLAogICAgICAgICAgICAgICAgaiA9IG5ldyBSZWdFeHAoIl4iICsgTyArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgTyArICIrJCIsICJnIiksCiAgICAgICAgICAgICAgICBGID0gbmV3IFJlZ0V4cCgiXiIgKyBPICsgIiosIiArIE8gKyAiKiIpLAogICAgICAgICAgICAgICAgSSA9IG5ldyBSZWdFeHAoIl4iICsgTyArICIqKFtcXHgyMFxcdFxcclxcblxcZj4rfl0pIiArIE8gKyAiKiIpLAogICAgICAgICAgICAgICAgcSA9IG5ldyBSZWdFeHAoSCksCiAgICAgICAgICAgICAgICBSID0gL14oPzojKFtcd1wtXSspfChcdyspfFwuKFtcd1wtXSspKSQvLAogICAgICAgICAgICAgICAgVSA9IC9eOm5vdC8sCiAgICAgICAgICAgICAgICB6ID0gL1tceDIwXHRcclxuXGZdKlsrfl0vLAogICAgICAgICAgICAgICAgVyA9IC86bm90XCgkLywKICAgICAgICAgICAgICAgIFggPSAvaFxkL2ksCiAgICAgICAgICAgICAgICBWID0gL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaSwKICAgICAgICAgICAgICAgICQgPSAvXFwoPyFcXCkvZywKICAgICAgICAgICAgICAgIEogPSB7CiAgICAgICAgICAgICAgICAgICAgSUQ6IG5ldyBSZWdFeHAoIl4jKCIgKyBNICsgIikiKSwKICAgICAgICAgICAgICAgICAgICBDTEFTUzogbmV3IFJlZ0V4cCgiXlxcLigiICsgTSArICIpIiksCiAgICAgICAgICAgICAgICAgICAgTkFNRTogbmV3IFJlZ0V4cCgiXlxcW25hbWU9WydcIl0/KCIgKyBNICsgIilbJ1wiXT9cXF0iKSwKICAgICAgICAgICAgICAgICAgICBUQUc6IG5ldyBSZWdFeHAoIl4oIiArIE0ucmVwbGFjZSgidyIsICJ3KiIpICsgIikiKSwKICAgICAgICAgICAgICAgICAgICBBVFRSOiBuZXcgUmVnRXhwKCJeIiArIFApLAogICAgICAgICAgICAgICAgICAgIFBTRVVETzogbmV3IFJlZ0V4cCgiXiIgKyBIKSwKICAgICAgICAgICAgICAgICAgICBQT1M6IG5ldyBSZWdFeHAoQiwgImkiKSwKICAgICAgICAgICAgICAgICAgICBDSElMRDogbmV3IFJlZ0V4cCgiXjoob25seXxudGh8Zmlyc3R8bGFzdCktY2hpbGQoPzpcXCgiICsgTyArICIqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpIiArIE8gKyAiKig/OihbKy1dfCkiICsgTyArICIqKFxcZCspfCkpIiArIE8gKyAiKlxcKXwpIiwgImkiKSwKICAgICAgICAgICAgICAgICAgICBuZWVkc0NvbnRleHQ6IG5ldyBSZWdFeHAoIl4iICsgTyArICIqWz4rfl18IiArIEIsICJpIikKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBLID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gZy5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSh0KQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICExCiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdCA9IG51bGwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUSA9IEsoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlLmFwcGVuZENoaWxkKGcuY3JlYXRlQ29tbWVudCgiIikpLCAhZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBHID0gSyhmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iLCBlLmZpcnN0Q2hpbGQgJiYgdHlwZW9mIGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUgIT09IHAgJiYgZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiIyIKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgWSA9IEsoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGUuaW5uZXJIVE1MID0gIjxzZWxlY3Q+PC9zZWxlY3Q+IjsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHR5cGVvZiBlLmxhc3RDaGlsZC5nZXRBdHRyaWJ1dGUoIm11bHRpcGxlIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQgIT09ICJib29sZWFuIiAmJiB0ICE9PSAic3RyaW5nIgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBaID0gSyhmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J2hpZGRlbiBlJz48L2Rpdj48ZGl2IGNsYXNzPSdoaWRkZW4nPjwvZGl2PiIsICFlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgIWUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA/ICExIDogKGUubGFzdENoaWxkLmNsYXNzTmFtZSA9ICJlIiwgZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAyKQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBldCA9IEsoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGUuaWQgPSBkICsgMCwgZS5pbm5lckhUTUwgPSAiPGEgbmFtZT0nIiArIGQgKyAiJz48L2E+PGRpdiBuYW1lPSciICsgZCArICInPjwvZGl2PiIsIHkuaW5zZXJ0QmVmb3JlKGUsIHkuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBnLmdldEVsZW1lbnRzQnlOYW1lICYmIGcuZ2V0RWxlbWVudHNCeU5hbWUoZCkubGVuZ3RoID09PSAyICsgZy5nZXRFbGVtZW50c0J5TmFtZShkICsgMCkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByID0gIWcuZ2V0RWxlbWVudEJ5SWQoZCksIHkucmVtb3ZlQ2hpbGQoZSksIHQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgeC5jYWxsKHkuY2hpbGROb2RlcywgMClbMF0ubm9kZVR5cGUKICAgICAgICAgICAgfSBjYXRjaCAodHQpIHsKICAgICAgICAgICAgICAgIHggPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQsIG4gPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgdCA9IHRoaXNbZV07IGUrKykgbi5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnQubWF0Y2hlcyA9IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudChlLCBudWxsLCBudWxsLCB0KQogICAgICAgICAgICB9LCBudC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnQodCwgbnVsbCwgbnVsbCwgW2VdKS5sZW5ndGggPiAwCiAgICAgICAgICAgIH0sIHMgPSBudC5nZXRUZXh0ID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHQsIG4gPSAiIiwKICAgICAgICAgICAgICAgICAgICByID0gMCwKICAgICAgICAgICAgICAgICAgICBpID0gZS5ub2RlVHlwZTsKICAgICAgICAgICAgICAgIGlmIChpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT09IDEgfHwgaSA9PT0gOSB8fCBpID09PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUudGV4dENvbnRlbnQgPT0gInN0cmluZyIpIHJldHVybiBlLnRleHRDb250ZW50OwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGUgPSBlLmZpcnN0Q2hpbGQ7IGU7IGUgPSBlLm5leHRTaWJsaW5nKSBuICs9IHMoZSkKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDMgfHwgaSA9PT0gNCkgcmV0dXJuIGUubm9kZVZhbHVlCiAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgdCA9IGVbcl07IHIrKykgbiArPSBzKHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG4KICAgICAgICAgICAgfSwgbyA9IG50LmlzWE1MID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBlICYmIChlLm93bmVyRG9jdW1lbnQgfHwgZSkuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIHQgPyB0Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiAhMQogICAgICAgICAgICB9LCB1ID0gbnQuY29udGFpbnMgPSB5LmNvbnRhaW5zID8gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIG4gPSBlLm5vZGVUeXBlID09PSA5ID8gZS5kb2N1bWVudEVsZW1lbnQgOiBlLAogICAgICAgICAgICAgICAgICAgIHIgPSB0ICYmIHQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIHJldHVybiBlID09PSByIHx8ICEhKHIgJiYgci5ub2RlVHlwZSA9PT0gMSAmJiBuLmNvbnRhaW5zICYmIG4uY29udGFpbnMocikpCiAgICAgICAgICAgIH0gOiB5LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHQgJiYgISEoZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbih0KSAmIDE2KQogICAgICAgICAgICB9IDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgd2hpbGUgKHQgPSB0LnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQgPT09IGUpIHJldHVybiAhMDsKICAgICAgICAgICAgICAgIHJldHVybiAhMQogICAgICAgICAgICB9LCBudC5hdHRyID0gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIG4sIHIgPSBvKGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHIgfHwgKHQgPSB0LnRvTG93ZXJDYXNlKCkpLCAobiA9IGkuYXR0ckhhbmRsZVt0XSkgPyBuKGUpIDogciB8fCBZID8gZS5nZXRBdHRyaWJ1dGUodCkgOiAobiA9IGUuZ2V0QXR0cmlidXRlTm9kZSh0KSwgbiA/IHR5cGVvZiBlW3RdID09ICJib29sZWFuIiA/IGVbdF0gPyB0IDogbnVsbCA6IG4uc3BlY2lmaWVkID8gbi52YWx1ZSA6IG51bGwgOiBudWxsKQogICAgICAgICAgICB9LCBpID0gbnQuc2VsZWN0b3JzID0gewogICAgICAgICAgICAgICAgY2FjaGVMZW5ndGg6IDUwLAogICAgICAgICAgICAgICAgY3JlYXRlUHNldWRvOiBOLAogICAgICAgICAgICAgICAgbWF0Y2g6IEosCiAgICAgICAgICAgICAgICBhdHRySGFuZGxlOiBHID8ge30gOiB7CiAgICAgICAgICAgICAgICAgICAgaHJlZjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5nZXRBdHRyaWJ1dGUoImhyZWYiLCAyKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdHlwZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5nZXRBdHRyaWJ1dGUoInR5cGUiKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmaW5kOiB7CiAgICAgICAgICAgICAgICAgICAgSUQ6IHIgPyBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdC5nZXRFbGVtZW50QnlJZCAhPT0gcCAmJiAhbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHIgPSB0LmdldEVsZW1lbnRCeUlkKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHIgJiYgci5wYXJlbnROb2RlID8gW3JdIDogW10KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygbi5nZXRFbGVtZW50QnlJZCAhPT0gcCAmJiAhcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBuLmdldEVsZW1lbnRCeUlkKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkgPyBpLmlkID09PSBlIHx8IHR5cGVvZiBpLmdldEF0dHJpYnV0ZU5vZGUgIT09IHAgJiYgaS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpLnZhbHVlID09PSBlID8gW2ldIDogdCA6IFtdCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIFRBRzogUSA/IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBwKSByZXR1cm4gdC5nZXRFbGVtZW50c0J5VGFnTmFtZShlKQogICAgICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gdC5nZXRFbGVtZW50c0J5VGFnTmFtZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUgPT09ICIqIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHIsIGkgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyByID0gbltzXTsgcysrKSByLm5vZGVUeXBlID09PSAxICYmIGkucHVzaChyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIE5BTUU6IGV0ICYmIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0LmdldEVsZW1lbnRzQnlOYW1lICE9PSBwKSByZXR1cm4gdC5nZXRFbGVtZW50c0J5TmFtZShuYW1lKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgQ0xBU1M6IFogJiYgZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gcCAmJiAhbikgcmV0dXJuIHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShlKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZWxhdGl2ZTogewogICAgICAgICAgICAgICAgICAgICI+IjogewogICAgICAgICAgICAgICAgICAgICAgICBkaXI6ICJwYXJlbnROb2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3Q6ICEwCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiICI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyOiAicGFyZW50Tm9kZSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICIrIjogewogICAgICAgICAgICAgICAgICAgICAgICBkaXI6ICJwcmV2aW91c1NpYmxpbmciLAogICAgICAgICAgICAgICAgICAgICAgICBmaXJzdDogITAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ+IjogewogICAgICAgICAgICAgICAgICAgICAgICBkaXI6ICJwcmV2aW91c1NpYmxpbmciCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByZUZpbHRlcjogewogICAgICAgICAgICAgICAgICAgIEFUVFI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbMV0gPSBlWzFdLnJlcGxhY2UoJCwgIiIpLCBlWzNdID0gKGVbNF0gfHwgZVs1XSB8fCAiIikucmVwbGFjZSgkLCAiIiksIGVbMl0gPT09ICJ+PSIgJiYgKGVbM10gPSAiICIgKyBlWzNdICsgIiAiKSwgZS5zbGljZSgwLCA0KQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgQ0hJTEQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbMV0gPSBlWzFdLnRvTG93ZXJDYXNlKCksIGVbMV0gPT09ICJudGgiID8gKGVbMl0gfHwgbnQuZXJyb3IoZVswXSksIGVbM10gPSArKGVbM10gPyBlWzRdICsgKGVbNV0gfHwgMSkgOiAyICogKGVbMl0gPT09ICJldmVuIiB8fCBlWzJdID09PSAib2RkIikpLCBlWzRdID0gKyhlWzZdICsgZVs3XSB8fCBlWzJdID09PSAib2RkIikpIDogZVsyXSAmJiBudC5lcnJvcihlWzBdKSwgZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgUFNFVURPOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0LCBuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoSi5DSElMRC50ZXN0KGVbMF0pKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVbM10pIGVbMl0gPSBlWzNdOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID0gZVs0XSkgcS50ZXN0KHQpICYmIChuID0gdXQodCwgITApKSAmJiAobiA9IHQuaW5kZXhPZigiKSIsIHQubGVuZ3RoIC0gbikgLSB0Lmxlbmd0aCkgJiYgKHQgPSB0LnNsaWNlKDAsIG4pLCBlWzBdID0gZVswXS5zbGljZSgwLCBuKSksIGVbMl0gPSB0OwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5zbGljZSgwLCAzKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmaWx0ZXI6IHsKICAgICAgICAgICAgICAgICAgICBJRDogciA/IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUgPSBlLnJlcGxhY2UoJCwgIiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0LmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlID0gZS5yZXBsYWNlKCQsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IHR5cGVvZiB0LmdldEF0dHJpYnV0ZU5vZGUgIT09IHAgJiYgdC5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuICYmIG4udmFsdWUgPT09IGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIFRBRzogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSA9PT0gIioiID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gITAKICAgICAgICAgICAgICAgICAgICAgICAgfSA6IChlID0gZS5yZXBsYWNlKCQsICIiKS50b0xvd2VyQ2FzZSgpLCBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5ub2RlTmFtZSAmJiB0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGUKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIENMQVNTOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ID0ga1tkXVtlICsgIiAiXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQgfHwgKHQgPSBuZXcgUmVnRXhwKCIoXnwiICsgTyArICIpIiArIGUgKyAiKCIgKyBPICsgInwkKSIpKSAmJiBrKGUsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0LnRlc3QoZS5jbGFzc05hbWUgfHwgdHlwZW9mIGUuZ2V0QXR0cmlidXRlICE9PSBwICYmIGUuZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgQVRUUjogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ociwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSBudC5hdHRyKHIsIGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHMgPT0gbnVsbCA/IHQgPT09ICIhPSIgOiB0ID8gKHMgKz0gIiIsIHQgPT09ICI9IiA/IHMgPT09IG4gOiB0ID09PSAiIT0iID8gcyAhPT0gbiA6IHQgPT09ICJePSIgPyBuICYmIHMuaW5kZXhPZihuKSA9PT0gMCA6IHQgPT09ICIqPSIgPyBuICYmIHMuaW5kZXhPZihuKSA+IC0xIDogdCA9PT0gIiQ9IiA/IG4gJiYgcy5zdWJzdHIocy5sZW5ndGggLSBuLmxlbmd0aCkgPT09IG4gOiB0ID09PSAifj0iID8gKCIgIiArIHMgKyAiICIpLmluZGV4T2YobikgPiAtMSA6IHQgPT09ICJ8PSIgPyBzID09PSBuIHx8IHMuc3Vic3RyKDAsIG4ubGVuZ3RoICsgMSkgPT09IG4gKyAiLSIgOiAhMSkgOiAhMAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBDSElMRDogZnVuY3Rpb24oZSwgdCwgbiwgcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSA9PT0gIm50aCIgPyBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCwgaSwgcyA9IGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuID09PSAxICYmIHIgPT09IDApIHJldHVybiAhMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh0ID0gcy5maXJzdENoaWxkOyB0OyB0ID0gdC5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlID09PSB0KSBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSAtPSByLCBpID09PSBuIHx8IGkgJSBuID09PSAwICYmIGkgLyBuID49IDAKICAgICAgICAgICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm9ubHkiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImZpcnN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG4gPSBuLnByZXZpb3VzU2libGluZykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuLm5vZGVUeXBlID09PSAxKSByZXR1cm4gITE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlID09PSAiZmlyc3QiKSByZXR1cm4gITA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSB0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImxhc3QiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobiA9IG4ubmV4dFNpYmxpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobi5ub2RlVHlwZSA9PT0gMSkgcmV0dXJuICExOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gITAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgUFNFVURPOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuLCByID0gaS5wc2V1ZG9zW2VdIHx8IGkuc2V0RmlsdGVyc1tlLnRvTG93ZXJDYXNlKCldIHx8IG50LmVycm9yKCJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJbZF0gPyByKHQpIDogci5sZW5ndGggPiAxID8gKG4gPSBbZSwgZSwgIiIsIHRdLCBpLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkoZS50b0xvd2VyQ2FzZSgpKSA/IE4oZnVuY3Rpb24oZSwgbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGksIHMgPSByKGUsIHQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvLS0pIGkgPSBULmNhbGwoZSwgc1tvXSksIGVbaV0gPSAhKG5baV0gPSBzW29dKQogICAgICAgICAgICAgICAgICAgICAgICB9KSA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByKGUsIDAsIG4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwc2V1ZG9zOiB7CiAgICAgICAgICAgICAgICAgICAgbm90OiBOKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBhKGUucmVwbGFjZShqLCAiJDEiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByW2RdID8gTihmdW5jdGlvbihlLCB0LCBuLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcywgbyA9IHIoZSwgbnVsbCwgaSwgW10pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHUgPSBlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh1LS0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMgPSBvW3VdKSBlW3VdID0gISh0W3VdID0gcykKICAgICAgICAgICAgICAgICAgICAgICAgfSkgOiBmdW5jdGlvbihlLCBpLCBzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdFswXSA9IGUsIHIodCwgbnVsbCwgcywgbiksICFuLnBvcCgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBoYXM6IE4oZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG50KGUsIHQpLmxlbmd0aCA+IDAKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5zOiBOKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodC50ZXh0Q29udGVudCB8fCB0LmlubmVyVGV4dCB8fCBzKHQpKS5pbmRleE9mKGUpID4gLTEKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuZGlzYWJsZWQgPT09ICExCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5kaXNhYmxlZCA9PT0gITAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ID09PSAiaW5wdXQiICYmICEhZS5jaGVja2VkIHx8IHQgPT09ICJvcHRpb24iICYmICEhZS5zZWxlY3RlZAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUucGFyZW50Tm9kZSAmJiBlLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleCwgZS5zZWxlY3RlZCA9PT0gITAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHBhcmVudDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWkucHNldWRvcy5lbXB0eShlKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5ub2RlTmFtZSA+ICJAIiB8fCAodCA9IGUubm9kZVR5cGUpID09PSAzIHx8IHQgPT09IDQpIHJldHVybiAhMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBlLm5leHRTaWJsaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEwCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBoZWFkZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFgudGVzdChlLm5vZGVOYW1lKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCwgbjsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodCA9IGUudHlwZSkgPT09ICJ0ZXh0IiAmJiAoKG4gPSBlLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IG4udG9Mb3dlckNhc2UoKSA9PT0gdCkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJhZGlvOiBydCgicmFkaW8iKSwKICAgICAgICAgICAgICAgICAgICBjaGVja2JveDogcnQoImNoZWNrYm94IiksCiAgICAgICAgICAgICAgICAgICAgZmlsZTogcnQoImZpbGUiKSwKICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogcnQoInBhc3N3b3JkIiksCiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IHJ0KCJpbWFnZSIpLAogICAgICAgICAgICAgICAgICAgIHN1Ym1pdDogaXQoInN1Ym1pdCIpLAogICAgICAgICAgICAgICAgICAgIHJlc2V0OiBpdCgicmVzZXQiKSwKICAgICAgICAgICAgICAgICAgICBidXR0b246IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ID09PSAiaW5wdXQiICYmIGUudHlwZSA9PT0gImJ1dHRvbiIgfHwgdCA9PT0gImJ1dHRvbiIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGlucHV0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBWLnRlc3QoZS5ub2RlTmFtZSkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ID0gZS5vd25lckRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZSA9PT0gdC5hY3RpdmVFbGVtZW50ICYmICghdC5oYXNGb2N1cyB8fCB0Lmhhc0ZvY3VzKCkpICYmICEhKGUudHlwZSB8fCBlLmhyZWYgfHwgfmUudGFiSW5kZXgpCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUgPT09IGUub3duZXJEb2N1bWVudC5hY3RpdmVFbGVtZW50CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBmaXJzdDogc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMF0KICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBsYXN0OiBzdChmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbdCAtIDFdCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgZXE6IHN0KGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtuIDwgMCA/IG4gKyB0IDogbl0KICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBldmVuOiBzdChmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgdDsgbiArPSAyKSBlLnB1c2gobik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgb2RkOiBzdChmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gPSAxOyBuIDwgdDsgbiArPSAyKSBlLnB1c2gobik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgbHQ6IHN0KGZ1bmN0aW9uKGUsIHQsIG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgciA9IG4gPCAwID8gbiArIHQgOiBuOyAtLXIgPj0gMDspIGUucHVzaChyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBndDogc3QoZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciByID0gbiA8IDAgPyBuICsgdCA6IG47ICsrciA8IHQ7KSBlLnB1c2gocik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZiA9IHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPyBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZSA9PT0gdCA/IChsID0gITAsIDApIDogKCFlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICF0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA6IGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24odCkgJiA0KSA/IC0xIDogMQogICAgICAgICAgICB9IDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgaWYgKGUgPT09IHQpIHJldHVybiBsID0gITAsIDA7CiAgICAgICAgICAgICAgICBpZiAoZS5zb3VyY2VJbmRleCAmJiB0LnNvdXJjZUluZGV4KSByZXR1cm4gZS5zb3VyY2VJbmRleCAtIHQuc291cmNlSW5kZXg7CiAgICAgICAgICAgICAgICB2YXIgbiwgciwgaSA9IFtdLAogICAgICAgICAgICAgICAgICAgIHMgPSBbXSwKICAgICAgICAgICAgICAgICAgICBvID0gZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgIHUgPSB0LnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgYSA9IG87CiAgICAgICAgICAgICAgICBpZiAobyA9PT0gdSkgcmV0dXJuIG90KGUsIHQpOwogICAgICAgICAgICAgICAgaWYgKCFvKSByZXR1cm4gLTE7CiAgICAgICAgICAgICAgICBpZiAoIXUpIHJldHVybiAxOwogICAgICAgICAgICAgICAgd2hpbGUgKGEpIGkudW5zaGlmdChhKSwgYSA9IGEucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGEgPSB1OwogICAgICAgICAgICAgICAgd2hpbGUgKGEpIHMudW5zaGlmdChhKSwgYSA9IGEucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIG4gPSBpLmxlbmd0aCwgciA9IHMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yICh2YXIgZiA9IDA7IGYgPCBuICYmIGYgPCByOyBmKyspCiAgICAgICAgICAgICAgICAgICAgaWYgKGlbZl0gIT09IHNbZl0pIHJldHVybiBvdChpW2ZdLCBzW2ZdKTsKICAgICAgICAgICAgICAgIHJldHVybiBmID09PSBuID8gb3QoZSwgc1tmXSwgLTEpIDogb3QoaVtmXSwgdCwgMSkKICAgICAgICAgICAgfSwgWzAsIDBdLnNvcnQoZiksIGggPSAhbCwgbnQudW5pcXVlU29ydCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHZhciB0LCBuID0gW10sCiAgICAgICAgICAgICAgICAgICAgciA9IDEsCiAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBsID0gaCwgZS5zb3J0KGYpOwogICAgICAgICAgICAgICAgaWYgKGwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgdCA9IGVbcl07IHIrKykgdCA9PT0gZVtyIC0gMV0gJiYgKGkgPSBuLnB1c2gocikpOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pIGUuc3BsaWNlKG5baV0sIDEpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZQogICAgICAgICAgICB9LCBudC5lcnJvciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIGUpCiAgICAgICAgICAgIH0sIGEgPSBudC5jb21waWxlID0gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIG4sIHIgPSBbXSwKICAgICAgICAgICAgICAgICAgICBpID0gW10sCiAgICAgICAgICAgICAgICAgICAgcyA9IEFbZF1bZSArICIgIl07CiAgICAgICAgICAgICAgICBpZiAoIXMpIHsKICAgICAgICAgICAgICAgICAgICB0IHx8ICh0ID0gdXQoZSkpLCBuID0gdC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG4tLSkgcyA9IGh0KHRbbl0pLCBzW2RdID8gci5wdXNoKHMpIDogaS5wdXNoKHMpOwogICAgICAgICAgICAgICAgICAgIHMgPSBBKGUsIHB0KGksIHIpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHMKICAgICAgICAgICAgfSwgZy5xdWVyeVNlbGVjdG9yQWxsICYmIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGUsIHQgPSB2dCwKICAgICAgICAgICAgICAgICAgICBuID0gLyd8XFwvZywKICAgICAgICAgICAgICAgICAgICByID0gL1w9W1x4MjBcdFxyXG5cZl0qKFteJyJcXV0qKVtceDIwXHRcclxuXGZdKlxdL2csCiAgICAgICAgICAgICAgICAgICAgaSA9IFsiOmZvY3VzIl0sCiAgICAgICAgICAgICAgICAgICAgcyA9IFsiOmFjdGl2ZSJdLAogICAgICAgICAgICAgICAgICAgIHUgPSB5Lm1hdGNoZXNTZWxlY3RvciB8fCB5Lm1vek1hdGNoZXNTZWxlY3RvciB8fCB5LndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fCB5Lm9NYXRjaGVzU2VsZWN0b3IgfHwgeS5tc01hdGNoZXNTZWxlY3RvcjsKICAgICAgICAgICAgICAgIEsoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIGUuaW5uZXJIVE1MID0gIjxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0nJz48L29wdGlvbj48L3NlbGVjdD4iLCBlLnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggfHwgaS5wdXNoKCJcXFsiICsgTyArICIqKD86Y2hlY2tlZHxkaXNhYmxlZHxpc21hcHxtdWx0aXBsZXxyZWFkb25seXxzZWxlY3RlZHx2YWx1ZSkiKSwgZS5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCB8fCBpLnB1c2goIjpjaGVja2VkIikKICAgICAgICAgICAgICAgIH0pLCBLKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBlLmlubmVySFRNTCA9ICI8cCB0ZXN0PScnPjwvcD4iLCBlLnF1ZXJ5U2VsZWN0b3JBbGwoIlt0ZXN0Xj0nJ10iKS5sZW5ndGggJiYgaS5wdXNoKCJbKl4kXT0iICsgTyArICIqKD86XCJcInwnJykiKSwgZS5pbm5lckhUTUwgPSAiPGlucHV0IHR5cGU9J2hpZGRlbicvPiIsIGUucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggfHwgaS5wdXNoKCI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiKQogICAgICAgICAgICAgICAgfSksIGkgPSBuZXcgUmVnRXhwKGkuam9pbigifCIpKSwgdnQgPSBmdW5jdGlvbihlLCByLCBzLCBvLCB1KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvICYmICF1ICYmICFpLnRlc3QoZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGEsIGYsIGwgPSAhMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IHIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwID0gci5ub2RlVHlwZSA9PT0gOSAmJiBlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoci5ub2RlVHlwZSA9PT0gMSAmJiByLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhID0gdXQoZSksIChsID0gci5nZXRBdHRyaWJ1dGUoImlkIikpID8gYyA9IGwucmVwbGFjZShuLCAiXFwkJiIpIDogci5zZXRBdHRyaWJ1dGUoImlkIiwgYyksIGMgPSAiW2lkPSciICsgYyArICInXSAiLCBmID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZi0tKSBhW2ZdID0gYyArIGFbZl0uam9pbigiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoID0gei50ZXN0KGUpICYmIHIucGFyZW50Tm9kZSB8fCByLCBwID0gYS5qb2luKCIsIikKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocCkgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBTLmFwcGx5KHMsIHguY2FsbChoLnF1ZXJ5U2VsZWN0b3JBbGwocCksIDApKSwgcwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoICh2KSB7fSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwgfHwgci5yZW1vdmVBdHRyaWJ1dGUoImlkIikKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdChlLCByLCBzLCBvLCB1KQogICAgICAgICAgICAgICAgfSwgdSAmJiAoSyhmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgZSA9IHUuY2FsbCh0LCAiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdS5jYWxsKHQsICJbdGVzdCE9JyddOnNpenpsZSIpLCBzLnB1c2goIiE9IiwgSCkKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChuKSB7fQogICAgICAgICAgICAgICAgfSksIHMgPSBuZXcgUmVnRXhwKHMuam9pbigifCIpKSwgbnQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24odCwgbikgewogICAgICAgICAgICAgICAgICAgIG4gPSBuLnJlcGxhY2UociwgIj0nJDEnXSIpOwogICAgICAgICAgICAgICAgICAgIGlmICghbyh0KSAmJiAhcy50ZXN0KG4pICYmICFpLnRlc3QobikpIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0gdS5jYWxsKHQsIG4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYSB8fCBlIHx8IHQuZG9jdW1lbnQgJiYgdC5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEpIHJldHVybiBhCiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZikge30KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnQobiwgbnVsbCwgbnVsbCwgW3RdKS5sZW5ndGggPiAwCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KCksIGkucHNldWRvcy5udGggPSBpLnBzZXVkb3MuZXEsIGkuZmlsdGVycyA9IG10LnByb3RvdHlwZSA9IGkucHNldWRvcywgaS5zZXRGaWx0ZXJzID0gbmV3IG10LCBudC5hdHRyID0gdi5hdHRyLCB2LmZpbmQgPSBudCwgdi5leHByID0gbnQuc2VsZWN0b3JzLCB2LmV4cHJbIjoiXSA9IHYuZXhwci5wc2V1ZG9zLCB2LnVuaXF1ZSA9IG50LnVuaXF1ZVNvcnQsIHYudGV4dCA9IG50LmdldFRleHQsIHYuaXNYTUxEb2MgPSBudC5pc1hNTCwgdi5jb250YWlucyA9IG50LmNvbnRhaW5zCiAgICAgICAgfShlKTsKICAgIHZhciBudCA9IC9VbnRpbCQvLAogICAgICAgIHJ0ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAgICAgaXQgPSAvXi5bXjojXFtcLixdKiQvLAogICAgICAgIHN0ID0gdi5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKICAgICAgICBvdCA9IHsKICAgICAgICAgICAgY2hpbGRyZW46ICEwLAogICAgICAgICAgICBjb250ZW50czogITAsCiAgICAgICAgICAgIG5leHQ6ICEwLAogICAgICAgICAgICBwcmV2OiAhMAogICAgICAgIH07CiAgICB2LmZuLmV4dGVuZCh7CiAgICAgICAgZmluZDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgdCwgbiwgciwgaSwgcywgbywgdSA9IHRoaXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZSAhPSAic3RyaW5nIikgcmV0dXJuIHYoZSkuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm9yICh0ID0gMCwgbiA9IHUubGVuZ3RoOyB0IDwgbjsgdCsrKQogICAgICAgICAgICAgICAgICAgIGlmICh2LmNvbnRhaW5zKHVbdF0sIHRoaXMpKSByZXR1cm4gITAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8gPSB0aGlzLnB1c2hTdGFjaygiIiwgImZpbmQiLCBlKTsKICAgICAgICAgICAgZm9yICh0ID0gMCwgbiA9IHRoaXMubGVuZ3RoOyB0IDwgbjsgdCsrKSB7CiAgICAgICAgICAgICAgICByID0gby5sZW5ndGgsIHYuZmluZChlLCB0aGlzW3RdLCBvKTsKICAgICAgICAgICAgICAgIGlmICh0ID4gMCkKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSByOyBpIDwgby5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChzID0gMDsgcyA8IHI7IHMrKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvW3NdID09PSBvW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgby5zcGxpY2UoaS0tLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvCiAgICAgICAgfSwKICAgICAgICBoYXM6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIHQsIG4gPSB2KGUsIHRoaXMpLAogICAgICAgICAgICAgICAgciA9IG4ubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmb3IgKHQgPSAwOyB0IDwgcjsgdCsrKQogICAgICAgICAgICAgICAgICAgIGlmICh2LmNvbnRhaW5zKHRoaXMsIG5bdF0pKSByZXR1cm4gITAKICAgICAgICAgICAgfSkKICAgICAgICB9LAogICAgICAgIG5vdDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soZnQodGhpcywgZSwgITEpLCAibm90IiwgZSkKICAgICAgICB9LAogICAgICAgIGZpbHRlcjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soZnQodGhpcywgZSwgITApLCAiZmlsdGVyIiwgZSkKICAgICAgICB9LAogICAgICAgIGlzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiAhIWUgJiYgKHR5cGVvZiBlID09ICJzdHJpbmciID8gc3QudGVzdChlKSA/IHYoZSwgdGhpcy5jb250ZXh0KS5pbmRleCh0aGlzWzBdKSA+PSAwIDogdi5maWx0ZXIoZSwgdGhpcykubGVuZ3RoID4gMCA6IHRoaXMuZmlsdGVyKGUpLmxlbmd0aCA+IDApCiAgICAgICAgfSwKICAgICAgICBjbG9zZXN0OiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuLCByID0gMCwKICAgICAgICAgICAgICAgIGkgPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgICAgIHMgPSBbXSwKICAgICAgICAgICAgICAgIG8gPSBzdC50ZXN0KGUpIHx8IHR5cGVvZiBlICE9ICJzdHJpbmciID8gdihlLCB0IHx8IHRoaXMuY29udGV4dCkgOiAwOwogICAgICAgICAgICBmb3IgKDsgciA8IGk7IHIrKykgewogICAgICAgICAgICAgICAgbiA9IHRoaXNbcl07CiAgICAgICAgICAgICAgICB3aGlsZSAobiAmJiBuLm93bmVyRG9jdW1lbnQgJiYgbiAhPT0gdCAmJiBuLm5vZGVUeXBlICE9PSAxMSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvID8gby5pbmRleChuKSA+IC0xIDogdi5maW5kLm1hdGNoZXNTZWxlY3RvcihuLCBlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzLnB1c2gobik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG4gPSBuLnBhcmVudE5vZGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcyA9IHMubGVuZ3RoID4gMSA/IHYudW5pcXVlKHMpIDogcywgdGhpcy5wdXNoU3RhY2socywgImNsb3Nlc3QiLCBlKQogICAgICAgIH0sCiAgICAgICAgaW5kZXg6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGUgPyB0eXBlb2YgZSA9PSAic3RyaW5nIiA/IHYuaW5BcnJheSh0aGlzWzBdLCB2KGUpKSA6IHYuaW5BcnJheShlLmpxdWVyeSA/IGVbMF0gOiBlLCB0aGlzKSA6IHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlID8gdGhpcy5wcmV2QWxsKCkubGVuZ3RoIDogLTEKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB2YXIgbiA9IHR5cGVvZiBlID09ICJzdHJpbmciID8gdihlLCB0KSA6IHYubWFrZUFycmF5KGUgJiYgZS5ub2RlVHlwZSA/IFtlXSA6IGUpLAogICAgICAgICAgICAgICAgciA9IHYubWVyZ2UodGhpcy5nZXQoKSwgbik7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh1dChuWzBdKSB8fCB1dChyWzBdKSA/IHIgOiB2LnVuaXF1ZShyKSkKICAgICAgICB9LAogICAgICAgIGFkZEJhY2s6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKGUgPT0gbnVsbCA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoZSkpCiAgICAgICAgfQogICAgfSksIHYuZm4uYW5kU2VsZiA9IHYuZm4uYWRkQmFjaywgdi5lYWNoKHsKICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIHQgPSBlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHJldHVybiB0ICYmIHQubm9kZVR5cGUgIT09IDExID8gdCA6IG51bGwKICAgICAgICB9LAogICAgICAgIHBhcmVudHM6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHYuZGlyKGUsICJwYXJlbnROb2RlIikKICAgICAgICB9LAogICAgICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICByZXR1cm4gdi5kaXIoZSwgInBhcmVudE5vZGUiLCBuKQogICAgICAgIH0sCiAgICAgICAgbmV4dDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gYXQoZSwgIm5leHRTaWJsaW5nIikKICAgICAgICB9LAogICAgICAgIHByZXY6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGF0KGUsICJwcmV2aW91c1NpYmxpbmciKQogICAgICAgIH0sCiAgICAgICAgbmV4dEFsbDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gdi5kaXIoZSwgIm5leHRTaWJsaW5nIikKICAgICAgICB9LAogICAgICAgIHByZXZBbGw6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHYuZGlyKGUsICJwcmV2aW91c1NpYmxpbmciKQogICAgICAgIH0sCiAgICAgICAgbmV4dFVudGlsOiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIHJldHVybiB2LmRpcihlLCAibmV4dFNpYmxpbmciLCBuKQogICAgICAgIH0sCiAgICAgICAgcHJldlVudGlsOiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIHJldHVybiB2LmRpcihlLCAicHJldmlvdXNTaWJsaW5nIiwgbikKICAgICAgICB9LAogICAgICAgIHNpYmxpbmdzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB2LnNpYmxpbmcoKGUucGFyZW50Tm9kZSB8fCB7fSkuZmlyc3RDaGlsZCwgZSkKICAgICAgICB9LAogICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB2LnNpYmxpbmcoZS5maXJzdENoaWxkKQogICAgICAgIH0sCiAgICAgICAgY29udGVudHM6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHYubm9kZU5hbWUoZSwgImlmcmFtZSIpID8gZS5jb250ZW50RG9jdW1lbnQgfHwgZS5jb250ZW50V2luZG93LmRvY3VtZW50IDogdi5tZXJnZShbXSwgZS5jaGlsZE5vZGVzKQogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICB2LmZuW2VdID0gZnVuY3Rpb24obiwgcikgewogICAgICAgICAgICB2YXIgaSA9IHYubWFwKHRoaXMsIHQsIG4pOwogICAgICAgICAgICByZXR1cm4gbnQudGVzdChlKSB8fCAociA9IG4pLCByICYmIHR5cGVvZiByID09ICJzdHJpbmciICYmIChpID0gdi5maWx0ZXIociwgaSkpLCBpID0gdGhpcy5sZW5ndGggPiAxICYmICFvdFtlXSA/IHYudW5pcXVlKGkpIDogaSwgdGhpcy5sZW5ndGggPiAxICYmIHJ0LnRlc3QoZSkgJiYgKGkgPSBpLnJldmVyc2UoKSksIHRoaXMucHVzaFN0YWNrKGksIGUsIGwuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSkKICAgICAgICB9CiAgICB9KSwgdi5leHRlbmQoewogICAgICAgIGZpbHRlcjogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICByZXR1cm4gbiAmJiAoZSA9ICI6bm90KCIgKyBlICsgIikiKSwgdC5sZW5ndGggPT09IDEgPyB2LmZpbmQubWF0Y2hlc1NlbGVjdG9yKHRbMF0sIGUpID8gW3RbMF1dIDogW10gOiB2LmZpbmQubWF0Y2hlcyhlLCB0KQogICAgICAgIH0sCiAgICAgICAgZGlyOiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBpID0gW10sCiAgICAgICAgICAgICAgICBzID0gZVtuXTsKICAgICAgICAgICAgd2hpbGUgKHMgJiYgcy5ub2RlVHlwZSAhPT0gOSAmJiAociA9PT0gdCB8fCBzLm5vZGVUeXBlICE9PSAxIHx8ICF2KHMpLmlzKHIpKSkgcy5ub2RlVHlwZSA9PT0gMSAmJiBpLnB1c2gocyksIHMgPSBzW25dOwogICAgICAgICAgICByZXR1cm4gaQogICAgICAgIH0sCiAgICAgICAgc2libGluZzogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB2YXIgbiA9IFtdOwogICAgICAgICAgICBmb3IgKDsgZTsgZSA9IGUubmV4dFNpYmxpbmcpIGUubm9kZVR5cGUgPT09IDEgJiYgZSAhPT0gdCAmJiBuLnB1c2goZSk7CiAgICAgICAgICAgIHJldHVybiBuCiAgICAgICAgfQogICAgfSk7CiAgICB2YXIgY3QgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnxoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCiAgICAgICAgaHQgPSAvIGpRdWVyeVxkKz0iKD86bnVsbHxcZCspIi9nLAogICAgICAgIHB0ID0gL15ccysvLAogICAgICAgIGR0ID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naSwKICAgICAgICB2dCA9IC88KFtcdzpdKykvLAogICAgICAgIG10ID0gLzx0Ym9keS9pLAogICAgICAgIGd0ID0gLzx8JiM/XHcrOy8sCiAgICAgICAgeXQgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAogICAgICAgIGJ0ID0gLzwoPzpzY3JpcHR8b2JqZWN0fGVtYmVkfG9wdGlvbnxzdHlsZSkvaSwKICAgICAgICB3dCA9IG5ldyBSZWdFeHAoIjwoPzoiICsgY3QgKyAiKVtcXHMvPl0iLCAiaSIpLAogICAgICAgIEV0ID0gL14oPzpjaGVja2JveHxyYWRpbykkLywKICAgICAgICBTdCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAogICAgICAgIHh0ID0gL1wvKGphdmF8ZWNtYSlzY3JpcHQvaSwKICAgICAgICBUdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8XC1cLSl8W1xdXC1dezJ9PlxzKiQvZywKICAgICAgICBOdCA9IHsKICAgICAgICAgICAgb3B0aW9uOiBbMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+Il0sCiAgICAgICAgICAgIGxlZ2VuZDogWzEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+Il0sCiAgICAgICAgICAgIHRoZWFkOiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSwKICAgICAgICAgICAgdHI6IFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdLAogICAgICAgICAgICB0ZDogWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0sCiAgICAgICAgICAgIGNvbDogWzIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+Il0sCiAgICAgICAgICAgIGFyZWE6IFsxLCAiPG1hcD4iLCAiPC9tYXA+Il0sCiAgICAgICAgICAgIF9kZWZhdWx0OiBbMCwgIiIsICIiXQogICAgICAgIH0sCiAgICAgICAgQ3QgPSBsdChpKSwKICAgICAgICBrdCA9IEN0LmFwcGVuZENoaWxkKGkuY3JlYXRlRWxlbWVudCgiZGl2IikpOwogICAgTnQub3B0Z3JvdXAgPSBOdC5vcHRpb24sIE50LnRib2R5ID0gTnQudGZvb3QgPSBOdC5jb2xncm91cCA9IE50LmNhcHRpb24gPSBOdC50aGVhZCwgTnQudGggPSBOdC50ZCwgdi5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgfHwgKE50Ll9kZWZhdWx0ID0gWzEsICJYPGRpdj4iLCAiPC9kaXY+Il0pLCB2LmZuLmV4dGVuZCh7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGUgPT09IHQgPyB2LnRleHQodGhpcykgOiB0aGlzLmVtcHR5KCkuYXBwZW5kKCh0aGlzWzBdICYmIHRoaXNbMF0ub3duZXJEb2N1bWVudCB8fCBpKS5jcmVhdGVUZXh0Tm9kZShlKSkKICAgICAgICAgICAgICAgIH0sIG51bGwsIGUsIGFyZ3VtZW50cy5sZW5ndGgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHdyYXBBbGw6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmICh2LmlzRnVuY3Rpb24oZSkpIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHYodGhpcykud3JhcEFsbChlLmNhbGwodGhpcywgdCkpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB2KGUsIHRoaXNbMF0ub3duZXJEb2N1bWVudCkuZXEoMCkuY2xvbmUoITApOwogICAgICAgICAgICAgICAgICAgIHRoaXNbMF0ucGFyZW50Tm9kZSAmJiB0Lmluc2VydEJlZm9yZSh0aGlzWzBdKSwgdC5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGUuZmlyc3RDaGlsZCAmJiBlLmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDEpIGUgPSBlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgICAgICAgICAgICAgfSkuYXBwZW5kKHRoaXMpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcwogICAgICAgICAgICB9LAogICAgICAgICAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2LmlzRnVuY3Rpb24oZSkgPyB0aGlzLmVhY2goZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHYodGhpcykud3JhcElubmVyKGUuY2FsbCh0aGlzLCB0KSkKICAgICAgICAgICAgICAgIH0pIDogdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdih0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IHQuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICBuLmxlbmd0aCA/IG4ud3JhcEFsbChlKSA6IHQuYXBwZW5kKGUpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICB3cmFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHYuaXNGdW5jdGlvbihlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHYodGhpcykud3JhcEFsbCh0ID8gZS5jYWxsKHRoaXMsIG4pIDogZSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVud3JhcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHYubm9kZU5hbWUodGhpcywgImJvZHkiKSB8fCB2KHRoaXMpLnJlcGxhY2VXaXRoKHRoaXMuY2hpbGROb2RlcykKICAgICAgICAgICAgICAgIH0pLmVuZCgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsICEwLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEpICYmIHRoaXMuYXBwZW5kQ2hpbGQoZSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCAhMCwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExKSAmJiB0aGlzLmluc2VydEJlZm9yZShlLCB0aGlzLmZpcnN0Q2hpbGQpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBiZWZvcmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCF1dCh0aGlzWzBdKSkgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCAhMSwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZSwgdGhpcykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IHYuY2xlYW4oYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sodi5tZXJnZShlLCB0aGlzKSwgImJlZm9yZSIsIHRoaXMuc2VsZWN0b3IpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFmdGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghdXQodGhpc1swXSkpIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgITEsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGUsIHRoaXMubmV4dFNpYmxpbmcpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB2LmNsZWFuKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHYubWVyZ2UodGhpcywgZSksICJhZnRlciIsIHRoaXMuc2VsZWN0b3IpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIG4sIHIgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7CiAgICAgICAgICAgICAgICAgICAgKG4gPSB0aGlzW3JdKSAhPSBudWxsOyByKyspCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8IHYuZmlsdGVyKGUsIFtuXSkubGVuZ3RoKSAhdCAmJiBuLm5vZGVUeXBlID09PSAxICYmICh2LmNsZWFuRGF0YShuLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikpLCB2LmNsZWFuRGF0YShbbl0pKSwgbi5wYXJlbnROb2RlICYmIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBlLCB0ID0gMDsKICAgICAgICAgICAgICAgIGZvciAoOwogICAgICAgICAgICAgICAgICAgIChlID0gdGhpc1t0XSkgIT0gbnVsbDsgdCsrKSB7CiAgICAgICAgICAgICAgICAgICAgZS5ub2RlVHlwZSA9PT0gMSAmJiB2LmNsZWFuRGF0YShlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikpOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChlLmZpcnN0Q2hpbGQpIGUucmVtb3ZlQ2hpbGQoZS5maXJzdENoaWxkKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlID0gZSA9PSBudWxsID8gITEgOiBlLCB0ID0gdCA9PSBudWxsID8gZSA6IHQsIHRoaXMubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2LmNsb25lKHRoaXMsIGUsIHQpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBodG1sOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdi5hY2Nlc3ModGhpcywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gdGhpc1swXSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoZSA9PT0gdCkgcmV0dXJuIG4ubm9kZVR5cGUgPT09IDEgPyBuLmlubmVySFRNTC5yZXBsYWNlKGh0LCAiIikgOiB0OwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PSAic3RyaW5nIiAmJiAheXQudGVzdChlKSAmJiAodi5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgfHwgIXd0LnRlc3QoZSkpICYmICh2LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXB0LnRlc3QoZSkpICYmICFOdFsodnQuZXhlYyhlKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGUucmVwbGFjZShkdCwgIjwkMT48LyQyPiIpOwogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IHIgPCBpOyByKyspIG4gPSB0aGlzW3JdIHx8IHt9LCBuLm5vZGVUeXBlID09PSAxICYmICh2LmNsZWFuRGF0YShuLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikpLCBuLmlubmVySFRNTCA9IGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbiA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAocykge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbiAmJiB0aGlzLmVtcHR5KCkuYXBwZW5kKGUpCiAgICAgICAgICAgICAgICB9LCBudWxsLCBlLCBhcmd1bWVudHMubGVuZ3RoKQogICAgICAgICAgICB9LAogICAgICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0KHRoaXNbMF0pID8gdGhpcy5sZW5ndGggPyB0aGlzLnB1c2hTdGFjayh2KHYuaXNGdW5jdGlvbihlKSA/IGUoKSA6IGUpLCAicmVwbGFjZVdpdGgiLCBlKSA6IHRoaXMgOiB2LmlzRnVuY3Rpb24oZSkgPyB0aGlzLmVhY2goZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gdih0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgciA9IG4uaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIG4ucmVwbGFjZVdpdGgoZS5jYWxsKHRoaXMsIHQsIHIpKQogICAgICAgICAgICAgICAgfSkgOiAodHlwZW9mIGUgIT0gInN0cmluZyIgJiYgKGUgPSB2KGUpLmRldGFjaCgpKSwgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5uZXh0U2libGluZywKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB2KHRoaXMpLnJlbW92ZSgpLCB0ID8gdih0KS5iZWZvcmUoZSkgOiB2KG4pLmFwcGVuZChlKQogICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKGUsICEwKQogICAgICAgICAgICB9LAogICAgICAgICAgICBkb21NYW5pcDogZnVuY3Rpb24oZSwgbiwgcikgewogICAgICAgICAgICAgICAgZSA9IFtdLmNvbmNhdC5hcHBseShbXSwgZSk7CiAgICAgICAgICAgICAgICB2YXIgaSwgcywgbywgdSwgYSA9IDAsCiAgICAgICAgICAgICAgICAgICAgZiA9IGVbMF0sCiAgICAgICAgICAgICAgICAgICAgbCA9IFtdLAogICAgICAgICAgICAgICAgICAgIGMgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICghdi5zdXBwb3J0LmNoZWNrQ2xvbmUgJiYgYyA+IDEgJiYgdHlwZW9mIGYgPT0gInN0cmluZyIgJiYgU3QudGVzdChmKSkgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2KHRoaXMpLmRvbU1hbmlwKGUsIG4sIHIpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh2LmlzRnVuY3Rpb24oZikpIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzID0gdih0aGlzKTsKICAgICAgICAgICAgICAgICAgICBlWzBdID0gZi5jYWxsKHRoaXMsIGksIG4gPyBzLmh0bWwoKSA6IHQpLCBzLmRvbU1hbmlwKGUsIG4sIHIpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHYuYnVpbGRGcmFnbWVudChlLCB0aGlzLCBsKSwgbyA9IGkuZnJhZ21lbnQsIHMgPSBvLmZpcnN0Q2hpbGQsIG8uY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgKG8gPSBzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocykgewogICAgICAgICAgICAgICAgICAgICAgICBuID0gbiAmJiB2Lm5vZGVOYW1lKHMsICJ0ciIpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHUgPSBpLmNhY2hlYWJsZSB8fCBjIC0gMTsgYSA8IGM7IGErKykgci5jYWxsKG4gJiYgdi5ub2RlTmFtZSh0aGlzW2FdLCAidGFibGUiKSA/IEx0KHRoaXNbYV0sICJ0Ym9keSIpIDogdGhpc1thXSwgYSA9PT0gdSA/IG8gOiB2LmNsb25lKG8sICEwLCAhMCkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG8gPSBzID0gbnVsbCwgbC5sZW5ndGggJiYgdi5lYWNoKGwsIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5zcmMgPyB2LmFqYXggPyB2LmFqYXgoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB0LnNyYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJzY3JpcHQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmM6ICExLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsOiAhMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aHJvd3MiOiAhMAogICAgICAgICAgICAgICAgICAgICAgICB9KSA6IHYuZXJyb3IoIm5vIGFqYXgiKSA6IHYuZ2xvYmFsRXZhbCgodC50ZXh0IHx8IHQudGV4dENvbnRlbnQgfHwgdC5pbm5lckhUTUwgfHwgIiIpLnJlcGxhY2UoVHQsICIiKSksIHQucGFyZW50Tm9kZSAmJiB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodCkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgICAgICAgfQogICAgICAgIH0pLCB2LmJ1aWxkRnJhZ21lbnQgPSBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBzLCBvLCB1LCBhID0gZVswXTsKICAgICAgICAgICAgcmV0dXJuIG4gPSBuIHx8IGksIG4gPSAhbi5ub2RlVHlwZSAmJiBuWzBdIHx8IG4sIG4gPSBuLm93bmVyRG9jdW1lbnQgfHwgbiwgZS5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGEgPT0gInN0cmluZyIgJiYgYS5sZW5ndGggPCA1MTIgJiYgbiA9PT0gaSAmJiBhLmNoYXJBdCgwKSA9PT0gIjwiICYmICFidC50ZXN0KGEpICYmICh2LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhU3QudGVzdChhKSkgJiYgKHYuc3VwcG9ydC5odG1sNUNsb25lIHx8ICF3dC50ZXN0KGEpKSAmJiAobyA9ICEwLCBzID0gdi5mcmFnbWVudHNbYV0sIHUgPSBzICE9PSB0KSwgcyB8fCAocyA9IG4uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLCB2LmNsZWFuKGUsIG4sIHMsIHIpLCBvICYmICh2LmZyYWdtZW50c1thXSA9IHUgJiYgcykpLCB7CiAgICAgICAgICAgICAgICBmcmFnbWVudDogcywKICAgICAgICAgICAgICAgIGNhY2hlYWJsZTogbwogICAgICAgICAgICB9CiAgICAgICAgfSwgdi5mcmFnbWVudHMgPSB7fSwgdi5lYWNoKHsKICAgICAgICAgICAgYXBwZW5kVG86ICJhcHBlbmQiLAogICAgICAgICAgICBwcmVwZW5kVG86ICJwcmVwZW5kIiwKICAgICAgICAgICAgaW5zZXJ0QmVmb3JlOiAiYmVmb3JlIiwKICAgICAgICAgICAgaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCiAgICAgICAgICAgIHJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKICAgICAgICB9LCBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHYuZm5bZV0gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICB2YXIgciwgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgcyA9IFtdLAogICAgICAgICAgICAgICAgICAgIG8gPSB2KG4pLAogICAgICAgICAgICAgICAgICAgIHUgPSBvLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBhID0gdGhpcy5sZW5ndGggPT09IDEgJiYgdGhpc1swXS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgaWYgKChhID09IG51bGwgfHwgYSAmJiBhLm5vZGVUeXBlID09PSAxMSAmJiBhLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSAmJiB1ID09PSAxKSByZXR1cm4gb1t0XSh0aGlzWzBdKSwgdGhpczsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgdTsgaSsrKSByID0gKGkgPiAwID8gdGhpcy5jbG9uZSghMCkgOiB0aGlzKS5nZXQoKSwgdihvW2ldKVt0XShyKSwgcyA9IHMuY29uY2F0KHIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHMsIGUsIG8uc2VsZWN0b3IpCiAgICAgICAgICAgIH0KICAgICAgICB9KSwgdi5leHRlbmQoewogICAgICAgICAgICBjbG9uZTogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICAgICAgdmFyIHIsIGksIHMsIG87CiAgICAgICAgICAgICAgICB2LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCB2LmlzWE1MRG9jKGUpIHx8ICF3dC50ZXN0KCI8IiArIGUubm9kZU5hbWUgKyAiPiIpID8gbyA9IGUuY2xvbmVOb2RlKCEwKSA6IChrdC5pbm5lckhUTUwgPSBlLm91dGVySFRNTCwga3QucmVtb3ZlQ2hpbGQobyA9IGt0LmZpcnN0Q2hpbGQpKTsKICAgICAgICAgICAgICAgIGlmICgoIXYuc3VwcG9ydC5ub0Nsb25lRXZlbnQgfHwgIXYuc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCkgJiYgKGUubm9kZVR5cGUgPT09IDEgfHwgZS5ub2RlVHlwZSA9PT0gMTEpICYmICF2LmlzWE1MRG9jKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgT3QoZSwgbyksIHIgPSBNdChlKSwgaSA9IE10KG8pOwogICAgICAgICAgICAgICAgICAgIGZvciAocyA9IDA7IHJbc107ICsrcykgaVtzXSAmJiBPdChyW3NdLCBpW3NdKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgICAgICAgICBBdChlLCBvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobikgewogICAgICAgICAgICAgICAgICAgICAgICByID0gTXQoZSksIGkgPSBNdChvKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChzID0gMDsgcltzXTsgKytzKSBBdChyW3NdLCBpW3NdKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByID0gaSA9IG51bGwsIG8KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYW46IGZ1bmN0aW9uKGUsIHQsIG4sIHIpIHsKICAgICAgICAgICAgICAgIHZhciBzLCBvLCB1LCBhLCBmLCBsLCBjLCBoLCBwLCBkLCBtLCBnLCB5ID0gdCA9PT0gaSAmJiBDdCwKICAgICAgICAgICAgICAgICAgICBiID0gW107CiAgICAgICAgICAgICAgICBpZiAoIXQgfHwgdHlwZW9mIHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCA9PSAidW5kZWZpbmVkIikgdCA9IGk7CiAgICAgICAgICAgICAgICBmb3IgKHMgPSAwOwogICAgICAgICAgICAgICAgICAgICh1ID0gZVtzXSkgIT0gbnVsbDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZW9mIHUgPT0gIm51bWJlciIgJiYgKHUgKz0gIiIpOwogICAgICAgICAgICAgICAgICAgIGlmICghdSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB1ID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWd0LnRlc3QodSkpIHUgPSB0LmNyZWF0ZVRleHROb2RlKHUpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSB5IHx8IGx0KHQpLCBjID0gdC5jcmVhdGVFbGVtZW50KCJkaXYiKSwgeS5hcHBlbmRDaGlsZChjKSwgdSA9IHUucmVwbGFjZShkdCwgIjwkMT48LyQyPiIpLCBhID0gKHZ0LmV4ZWModSkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCksIGYgPSBOdFthXSB8fCBOdC5fZGVmYXVsdCwgbCA9IGZbMF0sIGMuaW5uZXJIVE1MID0gZlsxXSArIHUgKyBmWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGwtLSkgYyA9IGMubGFzdENoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2LnN1cHBvcnQudGJvZHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoID0gbXQudGVzdCh1KSwgcCA9IGEgPT09ICJ0YWJsZSIgJiYgIWggPyBjLmZpcnN0Q2hpbGQgJiYgYy5maXJzdENoaWxkLmNoaWxkTm9kZXMgOiBmWzFdID09PSAiPHRhYmxlPiIgJiYgIWggPyBjLmNoaWxkTm9kZXMgOiBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG8gPSBwLmxlbmd0aCAtIDE7IG8gPj0gMDsgLS1vKSB2Lm5vZGVOYW1lKHBbb10sICJ0Ym9keSIpICYmICFwW29dLmNoaWxkTm9kZXMubGVuZ3RoICYmIHBbb10ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwW29dKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSF2LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgJiYgcHQudGVzdCh1KSAmJiBjLmluc2VydEJlZm9yZSh0LmNyZWF0ZVRleHROb2RlKHB0LmV4ZWModSlbMF0pLCBjLmZpcnN0Q2hpbGQpLCB1ID0gYy5jaGlsZE5vZGVzLCBjLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYykKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHUubm9kZVR5cGUgPyBiLnB1c2godSkgOiB2Lm1lcmdlKGIsIHUpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjICYmICh1ID0gYyA9IHkgPSBudWxsKTsKICAgICAgICAgICAgICAgIGlmICghdi5zdXBwb3J0LmFwcGVuZENoZWNrZWQpCiAgICAgICAgICAgICAgICAgICAgZm9yIChzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgKHUgPSBiW3NdKSAhPSBudWxsOyBzKyspIHYubm9kZU5hbWUodSwgImlucHV0IikgPyBfdCh1KSA6IHR5cGVvZiB1LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9ICJ1bmRlZmluZWQiICYmIHYuZ3JlcCh1LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpLCBfdCk7CiAgICAgICAgICAgICAgICBpZiAobikgewogICAgICAgICAgICAgICAgICAgIG0gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS50eXBlIHx8IHh0LnRlc3QoZS50eXBlKSkgcmV0dXJuIHIgPyByLnB1c2goZS5wYXJlbnROb2RlID8gZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGUpIDogZSkgOiBuLmFwcGVuZENoaWxkKGUpCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAodSA9IGJbc10pICE9IG51bGw7IHMrKykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2Lm5vZGVOYW1lKHUsICJzY3JpcHQiKSB8fCAhbSh1KSkgbi5hcHBlbmRDaGlsZCh1KSwgdHlwZW9mIHUuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT0gInVuZGVmaW5lZCIgJiYgKGcgPSB2LmdyZXAodi5tZXJnZShbXSwgdS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IikpLCBtKSwgYi5zcGxpY2UuYXBwbHkoYiwgW3MgKyAxLCAwXS5jb25jYXQoZykpLCBzICs9IGcubGVuZ3RoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYW5EYXRhOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICB2YXIgbiwgciwgaSwgcywgbyA9IDAsCiAgICAgICAgICAgICAgICAgICAgdSA9IHYuZXhwYW5kbywKICAgICAgICAgICAgICAgICAgICBhID0gdi5jYWNoZSwKICAgICAgICAgICAgICAgICAgICBmID0gdi5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8sCiAgICAgICAgICAgICAgICAgICAgbCA9IHYuZXZlbnQuc3BlY2lhbDsKICAgICAgICAgICAgICAgIGZvciAoOwogICAgICAgICAgICAgICAgICAgIChpID0gZVtvXSkgIT0gbnVsbDsgbysrKQogICAgICAgICAgICAgICAgICAgIGlmICh0IHx8IHYuYWNjZXB0RGF0YShpKSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gaVt1XSwgbiA9IHIgJiYgYVtyXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuLmV2ZW50cykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHMgaW4gbi5ldmVudHMpIGxbc10gPyB2LmV2ZW50LnJlbW92ZShpLCBzKSA6IHYucmVtb3ZlRXZlbnQoaSwgcywgbi5oYW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYVtyXSAmJiAoZGVsZXRlIGFbcl0sIGYgPyBkZWxldGUgaVt1XSA6IGkucmVtb3ZlQXR0cmlidXRlID8gaS5yZW1vdmVBdHRyaWJ1dGUodSkgOiBpW3VdID0gbnVsbCwgdi5kZWxldGVkSWRzLnB1c2gocikpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGUsIHQ7CiAgICAgICAgICAgIHYudWFNYXRjaCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGUgPSBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICB2YXIgdCA9IC8oY2hyb21lKVsgXC9dKFtcdy5dKykvLmV4ZWMoZSkgfHwgLyh3ZWJraXQpWyBcL10oW1x3Ll0rKS8uZXhlYyhlKSB8fCAvKG9wZXJhKSg/Oi4qdmVyc2lvbnwpWyBcL10oW1x3Ll0rKS8uZXhlYyhlKSB8fCAvKG1zaWUpIChbXHcuXSspLy5leGVjKGUpIHx8IGUuaW5kZXhPZigiY29tcGF0aWJsZSIpIDwgMCAmJiAvKG1vemlsbGEpKD86Lio/IHJ2OihbXHcuXSspfCkvLmV4ZWMoZSkgfHwgW107CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGJyb3dzZXI6IHRbMV0gfHwgIiIsCiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogdFsyXSB8fCAiMCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZSA9IHYudWFNYXRjaChvLnVzZXJBZ2VudCksIHQgPSB7fSwgZS5icm93c2VyICYmICh0W2UuYnJvd3Nlcl0gPSAhMCwgdC52ZXJzaW9uID0gZS52ZXJzaW9uKSwgdC5jaHJvbWUgPyB0LndlYmtpdCA9ICEwIDogdC53ZWJraXQgJiYgKHQuc2FmYXJpID0gITApLCB2LmJyb3dzZXIgPSB0LCB2LnN1YiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZSh0LCBuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBlLmZuLmluaXQodCwgbikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHYuZXh0ZW5kKCEwLCBlLCB0aGlzKSwgZS5zdXBlcmNsYXNzID0gdGhpcywgZS5mbiA9IGUucHJvdG90eXBlID0gdGhpcygpLCBlLmZuLmNvbnN0cnVjdG9yID0gZSwgZS5zdWIgPSB0aGlzLnN1YiwgZS5mbi5pbml0ID0gZnVuY3Rpb24ociwgaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpICYmIGkgaW5zdGFuY2VvZiB2ICYmICEoaSBpbnN0YW5jZW9mIGUpICYmIChpID0gZShpKSksIHYuZm4uaW5pdC5jYWxsKHRoaXMsIHIsIGksIHQpCiAgICAgICAgICAgICAgICB9LCBlLmZuLmluaXQucHJvdG90eXBlID0gZS5mbjsKICAgICAgICAgICAgICAgIHZhciB0ID0gZShpKTsKICAgICAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgICAgIH0KICAgICAgICB9KCk7CiAgICB2YXIgRHQsIFB0LCBIdCwgQnQgPSAvYWxwaGFcKFteKV0qXCkvaSwKICAgICAgICBqdCA9IC9vcGFjaXR5PShbXildKikvLAogICAgICAgIEZ0ID0gL14odG9wfHJpZ2h0fGJvdHRvbXxsZWZ0KSQvLAogICAgICAgIEl0ID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLAogICAgICAgIHF0ID0gL15tYXJnaW4vLAogICAgICAgIFJ0ID0gbmV3IFJlZ0V4cCgiXigiICsgbSArICIpKC4qKSQiLCAiaSIpLAogICAgICAgIFV0ID0gbmV3IFJlZ0V4cCgiXigiICsgbSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIpLAogICAgICAgIHp0ID0gbmV3IFJlZ0V4cCgiXihbLStdKT0oIiArIG0gKyAiKSIsICJpIiksCiAgICAgICAgV3QgPSB7CiAgICAgICAgICAgIEJPRFk6ICJibG9jayIKICAgICAgICB9LAogICAgICAgIFh0ID0gewogICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgICAgICB9LAogICAgICAgIFZ0ID0gewogICAgICAgICAgICBsZXR0ZXJTcGFjaW5nOiAwLAogICAgICAgICAgICBmb250V2VpZ2h0OiA0MDAKICAgICAgICB9LAogICAgICAgICR0ID0gWyJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiXSwKICAgICAgICBKdCA9IFsiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIl0sCiAgICAgICAgS3QgPSB2LmZuLnRvZ2dsZTsKICAgIHYuZm4uZXh0ZW5kKHsKICAgICAgICBjc3M6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgcmV0dXJuIHYuYWNjZXNzKHRoaXMsIGZ1bmN0aW9uKGUsIG4sIHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiByICE9PSB0ID8gdi5zdHlsZShlLCBuLCByKSA6IHYuY3NzKGUsIG4pCiAgICAgICAgICAgIH0sIGUsIG4sIGFyZ3VtZW50cy5sZW5ndGggPiAxKQogICAgICAgIH0sCiAgICAgICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBZdCh0aGlzLCAhMCkKICAgICAgICB9LAogICAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWXQodGhpcykKICAgICAgICB9LAogICAgICAgIHRvZ2dsZTogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB2YXIgbiA9IHR5cGVvZiBlID09ICJib29sZWFuIjsKICAgICAgICAgICAgcmV0dXJuIHYuaXNGdW5jdGlvbihlKSAmJiB2LmlzRnVuY3Rpb24odCkgPyBLdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgKG4gPyBlIDogR3QodGhpcykpID8gdih0aGlzKS5zaG93KCk6IHYodGhpcykuaGlkZSgpCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfSksIHYuZXh0ZW5kKHsKICAgICAgICBjc3NIb29rczogewogICAgICAgICAgICBvcGFjaXR5OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IER0KGUsICJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuID09PSAiIiA/ICIxIiA6IG4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNzc051bWJlcjogewogICAgICAgICAgICBmaWxsT3BhY2l0eTogITAsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6ICEwLAogICAgICAgICAgICBsaW5lSGVpZ2h0OiAhMCwKICAgICAgICAgICAgb3BhY2l0eTogITAsCiAgICAgICAgICAgIG9ycGhhbnM6ICEwLAogICAgICAgICAgICB3aWRvd3M6ICEwLAogICAgICAgICAgICB6SW5kZXg6ICEwLAogICAgICAgICAgICB6b29tOiAhMAogICAgICAgIH0sCiAgICAgICAgY3NzUHJvcHM6IHsKICAgICAgICAgICAgImZsb2F0Ijogdi5zdXBwb3J0LmNzc0Zsb2F0ID8gImNzc0Zsb2F0IiA6ICJzdHlsZUZsb2F0IgogICAgICAgIH0sCiAgICAgICAgc3R5bGU6IGZ1bmN0aW9uKGUsIG4sIHIsIGkpIHsKICAgICAgICAgICAgaWYgKCFlIHx8IGUubm9kZVR5cGUgPT09IDMgfHwgZS5ub2RlVHlwZSA9PT0gOCB8fCAhZS5zdHlsZSkgcmV0dXJuOwogICAgICAgICAgICB2YXIgcywgbywgdSwgYSA9IHYuY2FtZWxDYXNlKG4pLAogICAgICAgICAgICAgICAgZiA9IGUuc3R5bGU7CiAgICAgICAgICAgIG4gPSB2LmNzc1Byb3BzW2FdIHx8ICh2LmNzc1Byb3BzW2FdID0gUXQoZiwgYSkpLCB1ID0gdi5jc3NIb29rc1tuXSB8fCB2LmNzc0hvb2tzW2FdOwogICAgICAgICAgICBpZiAociA9PT0gdCkgcmV0dXJuIHUgJiYgImdldCIgaW4gdSAmJiAocyA9IHUuZ2V0KGUsICExLCBpKSkgIT09IHQgPyBzIDogZltuXTsKICAgICAgICAgICAgbyA9IHR5cGVvZiByLCBvID09PSAic3RyaW5nIiAmJiAocyA9IHp0LmV4ZWMocikpICYmIChyID0gKHNbMV0gKyAxKSAqIHNbMl0gKyBwYXJzZUZsb2F0KHYuY3NzKGUsIG4pKSwgbyA9ICJudW1iZXIiKTsKICAgICAgICAgICAgaWYgKHIgPT0gbnVsbCB8fCBvID09PSAibnVtYmVyIiAmJiBpc05hTihyKSkgcmV0dXJuOwogICAgICAgICAgICBvID09PSAibnVtYmVyIiAmJiAhdi5jc3NOdW1iZXJbYV0gJiYgKHIgKz0gInB4Iik7CiAgICAgICAgICAgIGlmICghdSB8fCAhKCJzZXQiIGluIHUpIHx8IChyID0gdS5zZXQoZSwgciwgaSkpICE9PSB0KSB0cnkgewogICAgICAgICAgICAgICAgZltuXSA9IHIKICAgICAgICAgICAgfSBjYXRjaCAobCkge30KICAgICAgICB9LAogICAgICAgIGNzczogZnVuY3Rpb24oZSwgbiwgciwgaSkgewogICAgICAgICAgICB2YXIgcywgbywgdSwgYSA9IHYuY2FtZWxDYXNlKG4pOwogICAgICAgICAgICByZXR1cm4gbiA9IHYuY3NzUHJvcHNbYV0gfHwgKHYuY3NzUHJvcHNbYV0gPSBRdChlLnN0eWxlLCBhKSksIHUgPSB2LmNzc0hvb2tzW25dIHx8IHYuY3NzSG9va3NbYV0sIHUgJiYgImdldCIgaW4gdSAmJiAocyA9IHUuZ2V0KGUsICEwLCBpKSksIHMgPT09IHQgJiYgKHMgPSBEdChlLCBuKSksIHMgPT09ICJub3JtYWwiICYmIG4gaW4gVnQgJiYgKHMgPSBWdFtuXSksIHIgfHwgaSAhPT0gdCA/IChvID0gcGFyc2VGbG9hdChzKSwgciB8fCB2LmlzTnVtZXJpYyhvKSA/IG8gfHwgMCA6IHMpIDogcwogICAgICAgIH0sCiAgICAgICAgc3dhcDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICB2YXIgciwgaSwgcyA9IHt9OwogICAgICAgICAgICBmb3IgKGkgaW4gdCkgc1tpXSA9IGUuc3R5bGVbaV0sIGUuc3R5bGVbaV0gPSB0W2ldOwogICAgICAgICAgICByID0gbi5jYWxsKGUpOwogICAgICAgICAgICBmb3IgKGkgaW4gdCkgZS5zdHlsZVtpXSA9IHNbaV07CiAgICAgICAgICAgIHJldHVybiByCiAgICAgICAgfQogICAgfSksIGUuZ2V0Q29tcHV0ZWRTdHlsZSA/IER0ID0gZnVuY3Rpb24odCwgbikgewogICAgICAgIHZhciByLCBpLCBzLCBvLCB1ID0gZS5nZXRDb21wdXRlZFN0eWxlKHQsIG51bGwpLAogICAgICAgICAgICBhID0gdC5zdHlsZTsKICAgICAgICByZXR1cm4gdSAmJiAociA9IHUuZ2V0UHJvcGVydHlWYWx1ZShuKSB8fCB1W25dLCByID09PSAiIiAmJiAhdi5jb250YWlucyh0Lm93bmVyRG9jdW1lbnQsIHQpICYmIChyID0gdi5zdHlsZSh0LCBuKSksIFV0LnRlc3QocikgJiYgcXQudGVzdChuKSAmJiAoaSA9IGEud2lkdGgsIHMgPSBhLm1pbldpZHRoLCBvID0gYS5tYXhXaWR0aCwgYS5taW5XaWR0aCA9IGEubWF4V2lkdGggPSBhLndpZHRoID0gciwgciA9IHUud2lkdGgsIGEud2lkdGggPSBpLCBhLm1pbldpZHRoID0gcywgYS5tYXhXaWR0aCA9IG8pKSwgcgogICAgfSA6IGkuZG9jdW1lbnRFbGVtZW50LmN1cnJlbnRTdHlsZSAmJiAoRHQgPSBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgdmFyIG4sIHIsIGkgPSBlLmN1cnJlbnRTdHlsZSAmJiBlLmN1cnJlbnRTdHlsZVt0XSwKICAgICAgICAgICAgcyA9IGUuc3R5bGU7CiAgICAgICAgcmV0dXJuIGkgPT0gbnVsbCAmJiBzICYmIHNbdF0gJiYgKGkgPSBzW3RdKSwgVXQudGVzdChpKSAmJiAhRnQudGVzdCh0KSAmJiAobiA9IHMubGVmdCwgciA9IGUucnVudGltZVN0eWxlICYmIGUucnVudGltZVN0eWxlLmxlZnQsIHIgJiYgKGUucnVudGltZVN0eWxlLmxlZnQgPSBlLmN1cnJlbnRTdHlsZS5sZWZ0KSwgcy5sZWZ0ID0gdCA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogaSwgaSA9IHMucGl4ZWxMZWZ0ICsgInB4Iiwgcy5sZWZ0ID0gbiwgciAmJiAoZS5ydW50aW1lU3R5bGUubGVmdCA9IHIpKSwgaSA9PT0gIiIgPyAiYXV0byIgOiBpCiAgICB9KSwgdi5lYWNoKFsiaGVpZ2h0IiwgIndpZHRoIl0sIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICB2LmNzc0hvb2tzW3RdID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGUsIG4sIHIpIHsKICAgICAgICAgICAgICAgIGlmIChuKSByZXR1cm4gZS5vZmZzZXRXaWR0aCA9PT0gMCAmJiBJdC50ZXN0KER0KGUsICJkaXNwbGF5IikpID8gdi5zd2FwKGUsIFh0LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG4oZSwgdCwgcikKICAgICAgICAgICAgICAgIH0pIDogdG4oZSwgdCwgcikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWnQoZSwgbiwgciA/IGVuKGUsIHQsIHIsIHYuc3VwcG9ydC5ib3hTaXppbmcgJiYgdi5jc3MoZSwgImJveFNpemluZyIpID09PSAiYm9yZGVyLWJveCIpIDogMCkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLCB2LnN1cHBvcnQub3BhY2l0eSB8fCAodi5jc3NIb29rcy5vcGFjaXR5ID0gewogICAgICAgIGdldDogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICByZXR1cm4ganQudGVzdCgodCAmJiBlLmN1cnJlbnRTdHlsZSA/IGUuY3VycmVudFN0eWxlLmZpbHRlciA6IGUuc3R5bGUuZmlsdGVyKSB8fCAiIikgPyAuMDEgKiBwYXJzZUZsb2F0KFJlZ0V4cC4kMSkgKyAiIiA6IHQgPyAiMSIgOiAiIgogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHZhciBuID0gZS5zdHlsZSwKICAgICAgICAgICAgICAgIHIgPSBlLmN1cnJlbnRTdHlsZSwKICAgICAgICAgICAgICAgIGkgPSB2LmlzTnVtZXJpYyh0KSA/ICJhbHBoYShvcGFjaXR5PSIgKyB0ICogMTAwICsgIikiIDogIiIsCiAgICAgICAgICAgICAgICBzID0gciAmJiByLmZpbHRlciB8fCBuLmZpbHRlciB8fCAiIjsKICAgICAgICAgICAgbi56b29tID0gMTsKICAgICAgICAgICAgaWYgKHQgPj0gMSAmJiB2LnRyaW0ocy5yZXBsYWNlKEJ0LCAiIikpID09PSAiIiAmJiBuLnJlbW92ZUF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgbi5yZW1vdmVBdHRyaWJ1dGUoImZpbHRlciIpOwogICAgICAgICAgICAgICAgaWYgKHIgJiYgIXIuZmlsdGVyKSByZXR1cm4KICAgICAgICAgICAgfQogICAgICAgICAgICBuLmZpbHRlciA9IEJ0LnRlc3QocykgPyBzLnJlcGxhY2UoQnQsIGkpIDogcyArICIgIiArIGkKICAgICAgICB9CiAgICB9KSwgdihmdW5jdGlvbigpIHsKICAgICAgICB2LnN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCB8fCAodi5jc3NIb29rcy5tYXJnaW5SaWdodCA9IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdi5zd2FwKGUsIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWJsb2NrIgogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQpIHJldHVybiBEdChlLCAibWFyZ2luUmlnaHQiKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0pLCAhdi5zdXBwb3J0LnBpeGVsUG9zaXRpb24gJiYgdi5mbi5wb3NpdGlvbiAmJiB2LmVhY2goWyJ0b3AiLCAibGVmdCJdLCBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgICAgIHYuY3NzSG9va3NbdF0gPSB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgciA9IER0KGUsIHQpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVXQudGVzdChyKSA/IHYoZSkucG9zaXRpb24oKVt0XSArICJweCIgOiByCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSkKICAgIH0pLCB2LmV4cHIgJiYgdi5leHByLmZpbHRlcnMgJiYgKHYuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICByZXR1cm4gZS5vZmZzZXRXaWR0aCA9PT0gMCAmJiBlLm9mZnNldEhlaWdodCA9PT0gMCB8fCAhdi5zdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cyAmJiAoZS5zdHlsZSAmJiBlLnN0eWxlLmRpc3BsYXkgfHwgRHQoZSwgImRpc3BsYXkiKSkgPT09ICJub25lIgogICAgfSwgdi5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICByZXR1cm4gIXYuZXhwci5maWx0ZXJzLmhpZGRlbihlKQogICAgfSksIHYuZWFjaCh7CiAgICAgICAgbWFyZ2luOiAiIiwKICAgICAgICBwYWRkaW5nOiAiIiwKICAgICAgICBib3JkZXI6ICJXaWR0aCIKICAgIH0sIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICB2LmNzc0hvb2tzW2UgKyB0XSA9IHsKICAgICAgICAgICAgZXhwYW5kOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICB2YXIgciwgaSA9IHR5cGVvZiBuID09ICJzdHJpbmciID8gbi5zcGxpdCgiICIpIDogW25dLAogICAgICAgICAgICAgICAgICAgIHMgPSB7fTsKICAgICAgICAgICAgICAgIGZvciAociA9IDA7IHIgPCA0OyByKyspIHNbZSArICR0W3JdICsgdF0gPSBpW3JdIHx8IGlbciAtIDJdIHx8IGlbMF07CiAgICAgICAgICAgICAgICByZXR1cm4gcwogICAgICAgICAgICB9CiAgICAgICAgfSwgcXQudGVzdChlKSB8fCAodi5jc3NIb29rc1tlICsgdF0uc2V0ID0gWnQpCiAgICB9KTsKICAgIHZhciBybiA9IC8lMjAvZywKICAgICAgICBzbiA9IC9cW1xdJC8sCiAgICAgICAgb24gPSAvXHI/XG4vZywKICAgICAgICB1biA9IC9eKD86Y29sb3J8ZGF0ZXxkYXRldGltZXxkYXRldGltZS1sb2NhbHxlbWFpbHxoaWRkZW58bW9udGh8bnVtYmVyfHBhc3N3b3JkfHJhbmdlfHNlYXJjaHx0ZWx8dGV4dHx0aW1lfHVybHx3ZWVrKSQvaSwKICAgICAgICBhbiA9IC9eKD86c2VsZWN0fHRleHRhcmVhKS9pOwogICAgdi5mbi5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB2LnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSkKICAgICAgICB9LAogICAgICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudHMgPyB2Lm1ha2VBcnJheSh0aGlzLmVsZW1lbnRzKSA6IHRoaXMKICAgICAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSAmJiAhdGhpcy5kaXNhYmxlZCAmJiAodGhpcy5jaGVja2VkIHx8IGFuLnRlc3QodGhpcy5ub2RlTmFtZSkgfHwgdW4udGVzdCh0aGlzLnR5cGUpKQogICAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdmFyIG4gPSB2KHRoaXMpLnZhbCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIG4gPT0gbnVsbCA/IG51bGwgOiB2LmlzQXJyYXkobikgPyB2Lm1hcChuLCBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdC5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZS5yZXBsYWNlKG9uLCAiXHJcbiIpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkgOiB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogdC5uYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuLnJlcGxhY2Uob24sICJcclxuIikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkuZ2V0KCkKICAgICAgICB9CiAgICB9KSwgdi5wYXJhbSA9IGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICB2YXIgciwgaSA9IFtdLAogICAgICAgICAgICBzID0gZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICAgICAgdCA9IHYuaXNGdW5jdGlvbih0KSA/IHQoKSA6IHQgPT0gbnVsbCA/ICIiIDogdCwgaVtpLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoZSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodCkKICAgICAgICAgICAgfTsKICAgICAgICBuID09PSB0ICYmIChuID0gdi5hamF4U2V0dGluZ3MgJiYgdi5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwpOwogICAgICAgIGlmICh2LmlzQXJyYXkoZSkgfHwgZS5qcXVlcnkgJiYgIXYuaXNQbGFpbk9iamVjdChlKSkgdi5lYWNoKGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzKHRoaXMubmFtZSwgdGhpcy52YWx1ZSkKICAgICAgICB9KTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGZvciAociBpbiBlKSBmbihyLCBlW3JdLCBuLCBzKTsKICAgICAgICByZXR1cm4gaS5qb2luKCImIikucmVwbGFjZShybiwgIisiKQogICAgfTsKICAgIHZhciBsbiwgY24sIGhuID0gLyMuKiQvLAogICAgICAgIHBuID0gL14oLio/KTpbIFx0XSooW15cclxuXSopXHI/JC9tZywKICAgICAgICBkbiA9IC9eKD86YWJvdXR8YXBwfGFwcFwtc3RvcmFnZXwuK1wtZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCiAgICAgICAgdm4gPSAvXig/OkdFVHxIRUFEKSQvLAogICAgICAgIG1uID0gL15cL1wvLywKICAgICAgICBnbiA9IC9cPy8sCiAgICAgICAgeW4gPSAvPHNjcmlwdFxiW148XSooPzooPyE8XC9zY3JpcHQ+KTxbXjxdKikqPFwvc2NyaXB0Pi9naSwKICAgICAgICBibiA9IC8oWz8mXSlfPVteJl0qLywKICAgICAgICB3biA9IC9eKFtcd1wrXC5cLV0rOikoPzpcL1wvKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKICAgICAgICBFbiA9IHYuZm4ubG9hZCwKICAgICAgICBTbiA9IHt9LAogICAgICAgIHhuID0ge30sCiAgICAgICAgVG4gPSBbIiovIl0gKyBbIioiXTsKICAgIHRyeSB7CiAgICAgICAgY24gPSBzLmhyZWYKICAgIH0gY2F0Y2ggKE5uKSB7CiAgICAgICAgY24gPSBpLmNyZWF0ZUVsZW1lbnQoImEiKSwgY24uaHJlZiA9ICIiLCBjbiA9IGNuLmhyZWYKICAgIH0KICAgIGxuID0gd24uZXhlYyhjbi50b0xvd2VyQ2FzZSgpKSB8fCBbXSwgdi5mbi5sb2FkID0gZnVuY3Rpb24oZSwgbiwgcikgewogICAgICAgIGlmICh0eXBlb2YgZSAhPSAic3RyaW5nIiAmJiBFbikgcmV0dXJuIEVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKCF0aGlzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CiAgICAgICAgdmFyIGksIHMsIG8sIHUgPSB0aGlzLAogICAgICAgICAgICBhID0gZS5pbmRleE9mKCIgIik7CiAgICAgICAgcmV0dXJuIGEgPj0gMCAmJiAoaSA9IGUuc2xpY2UoYSwgZS5sZW5ndGgpLCBlID0gZS5zbGljZSgwLCBhKSksIHYuaXNGdW5jdGlvbihuKSA/IChyID0gbiwgbiA9IHQpIDogbiAmJiB0eXBlb2YgbiA9PSAib2JqZWN0IiAmJiAocyA9ICJQT1NUIiksIHYuYWpheCh7CiAgICAgICAgICAgIHVybDogZSwKICAgICAgICAgICAgdHlwZTogcywKICAgICAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICAgICAgZGF0YTogbiwKICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHIgJiYgdS5lYWNoKHIsIG8gfHwgW2UucmVzcG9uc2VUZXh0LCB0LCBlXSkKICAgICAgICAgICAgfQogICAgICAgIH0pLmRvbmUoZnVuY3Rpb24oZSkgewogICAgICAgICAgICBvID0gYXJndW1lbnRzLCB1Lmh0bWwoaSA/IHYoIjxkaXY+IikuYXBwZW5kKGUucmVwbGFjZSh5biwgIiIpKS5maW5kKGkpIDogZSkKICAgICAgICB9KSwgdGhpcwogICAgfSwgdi5lYWNoKCJhamF4U3RhcnQgYWpheFN0b3AgYWpheENvbXBsZXRlIGFqYXhFcnJvciBhamF4U3VjY2VzcyBhamF4U2VuZCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oZSwgdCkgewogICAgICAgIHYuZm5bdF0gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKHQsIGUpCiAgICAgICAgfQogICAgfSksIHYuZWFjaChbImdldCIsICJwb3N0Il0sIGZ1bmN0aW9uKGUsIG4pIHsKICAgICAgICB2W25dID0gZnVuY3Rpb24oZSwgciwgaSwgcykgewogICAgICAgICAgICByZXR1cm4gdi5pc0Z1bmN0aW9uKHIpICYmIChzID0gcyB8fCBpLCBpID0gciwgciA9IHQpLCB2LmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogbiwKICAgICAgICAgICAgICAgIHVybDogZSwKICAgICAgICAgICAgICAgIGRhdGE6IHIsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBpLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6IHMKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9KSwgdi5leHRlbmQoewogICAgICAgIGdldFNjcmlwdDogZnVuY3Rpb24oZSwgbikgewogICAgICAgICAgICByZXR1cm4gdi5nZXQoZSwgdCwgbiwgInNjcmlwdCIpCiAgICAgICAgfSwKICAgICAgICBnZXRKU09OOiBmdW5jdGlvbihlLCB0LCBuKSB7CiAgICAgICAgICAgIHJldHVybiB2LmdldChlLCB0LCBuLCAianNvbiIpCiAgICAgICAgfSwKICAgICAgICBhamF4U2V0dXA6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuIHQgPyBMbihlLCB2LmFqYXhTZXR0aW5ncykgOiAodCA9IGUsIGUgPSB2LmFqYXhTZXR0aW5ncyksIExuKGUsIHQpLCBlCiAgICAgICAgfSwKICAgICAgICBhamF4U2V0dGluZ3M6IHsKICAgICAgICAgICAgdXJsOiBjbiwKICAgICAgICAgICAgaXNMb2NhbDogZG4udGVzdChsblsxXSksCiAgICAgICAgICAgIGdsb2JhbDogITAsCiAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCiAgICAgICAgICAgIHByb2Nlc3NEYXRhOiAhMCwKICAgICAgICAgICAgYXN5bmM6ICEwLAogICAgICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgICAgICB4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKICAgICAgICAgICAgICAgIGh0bWw6ICJ0ZXh0L2h0bWwiLAogICAgICAgICAgICAgICAgdGV4dDogInRleHQvcGxhaW4iLAogICAgICAgICAgICAgICAganNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIsCiAgICAgICAgICAgICAgICAiKiI6IFRuCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgICAgICAgICB4bWw6IC94bWwvLAogICAgICAgICAgICAgICAgaHRtbDogL2h0bWwvLAogICAgICAgICAgICAgICAganNvbjogL2pzb24vCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlc3BvbnNlRmllbGRzOiB7CiAgICAgICAgICAgICAgICB4bWw6ICJyZXNwb25zZVhNTCIsCiAgICAgICAgICAgICAgICB0ZXh0OiAicmVzcG9uc2VUZXh0IgogICAgICAgICAgICB9LAogICAgICAgICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgICAgICAgICAiKiB0ZXh0IjogZS5TdHJpbmcsCiAgICAgICAgICAgICAgICAidGV4dCBodG1sIjogITAsCiAgICAgICAgICAgICAgICAidGV4dCBqc29uIjogdi5wYXJzZUpTT04sCiAgICAgICAgICAgICAgICAidGV4dCB4bWwiOiB2LnBhcnNlWE1MCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZsYXRPcHRpb25zOiB7CiAgICAgICAgICAgICAgICBjb250ZXh0OiAhMCwKICAgICAgICAgICAgICAgIHVybDogITAKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWpheFByZWZpbHRlcjogQ24oU24pLAogICAgICAgIGFqYXhUcmFuc3BvcnQ6IENuKHhuKSwKICAgICAgICBhamF4OiBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIFQoZSwgbiwgcywgYSkgewogICAgICAgICAgICAgICAgdmFyIGwsIHksIGIsIHcsIFMsIFQgPSBuOwogICAgICAgICAgICAgICAgaWYgKEUgPT09IDIpIHJldHVybjsKICAgICAgICAgICAgICAgIEUgPSAyLCB1ICYmIGNsZWFyVGltZW91dCh1KSwgbyA9IHQsIGkgPSBhIHx8ICIiLCB4LnJlYWR5U3RhdGUgPSBlID4gMCA/IDQgOiAwLCBzICYmICh3ID0gQW4oYywgeCwgcykpOwogICAgICAgICAgICAgICAgaWYgKGUgPj0gMjAwICYmIGUgPCAzMDAgfHwgZSA9PT0gMzA0KSBjLmlmTW9kaWZpZWQgJiYgKFMgPSB4LmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIiksIFMgJiYgKHYubGFzdE1vZGlmaWVkW3JdID0gUyksIFMgPSB4LmdldFJlc3BvbnNlSGVhZGVyKCJFdGFnIiksIFMgJiYgKHYuZXRhZ1tyXSA9IFMpKSwgZSA9PT0gMzA0ID8gKFQgPSAibm90bW9kaWZpZWQiLCBsID0gITApIDogKGwgPSBPbihjLCB3KSwgVCA9IGwuc3RhdGUsIHkgPSBsLmRhdGEsIGIgPSBsLmVycm9yLCBsID0gIWIpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYiA9IFQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFUIHx8IGUpIFQgPSAiZXJyb3IiLCBlIDwgMCAmJiAoZSA9IDApCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB4LnN0YXR1cyA9IGUsIHguc3RhdHVzVGV4dCA9IChuIHx8IFQpICsgIiIsIGwgPyBkLnJlc29sdmVXaXRoKGgsIFt5LCBULCB4XSkgOiBkLnJlamVjdFdpdGgoaCwgW3gsIFQsIGJdKSwgeC5zdGF0dXNDb2RlKGcpLCBnID0gdCwgZiAmJiBwLnRyaWdnZXIoImFqYXgiICsgKGwgPyAiU3VjY2VzcyIgOiAiRXJyb3IiKSwgW3gsIGMsIGwgPyB5IDogYl0pLCBtLmZpcmVXaXRoKGgsIFt4LCBUXSksIGYgJiYgKHAudHJpZ2dlcigiYWpheENvbXBsZXRlIiwgW3gsIGNdKSwgLS12LmFjdGl2ZSB8fCB2LmV2ZW50LnRyaWdnZXIoImFqYXhTdG9wIikpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZW9mIGUgPT0gIm9iamVjdCIgJiYgKG4gPSBlLCBlID0gdCksIG4gPSBuIHx8IHt9OwogICAgICAgICAgICB2YXIgciwgaSwgcywgbywgdSwgYSwgZiwgbCwgYyA9IHYuYWpheFNldHVwKHt9LCBuKSwKICAgICAgICAgICAgICAgIGggPSBjLmNvbnRleHQgfHwgYywKICAgICAgICAgICAgICAgIHAgPSBoICE9PSBjICYmIChoLm5vZGVUeXBlIHx8IGggaW5zdGFuY2VvZiB2KSA/IHYoaCkgOiB2LmV2ZW50LAogICAgICAgICAgICAgICAgZCA9IHYuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICAgIG0gPSB2LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgICAgICAgICAgIGcgPSBjLnN0YXR1c0NvZGUgfHwge30sCiAgICAgICAgICAgICAgICBiID0ge30sCiAgICAgICAgICAgICAgICB3ID0ge30sCiAgICAgICAgICAgICAgICBFID0gMCwKICAgICAgICAgICAgICAgIFMgPSAiY2FuY2VsZWQiLAogICAgICAgICAgICAgICAgeCA9IHsKICAgICAgICAgICAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgICAgICAgICAgIHNldFJlcXVlc3RIZWFkZXI6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFFKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSB3W25dID0gd1tuXSB8fCBlLCBiW2VdID0gdAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRSA9PT0gMiA/IGkgOiBudWxsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEUgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobiA9IHBuLmV4ZWMoaSkpIHNbblsxXS50b0xvd2VyQ2FzZSgpXSA9IG5bMl0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBzW2UudG9Mb3dlckNhc2UoKV0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbiA9PT0gdCA/IG51bGwgOiBuCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFIHx8IChjLm1pbWVUeXBlID0gZSksIHRoaXMKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGFib3J0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlID0gZSB8fCBTLCBvICYmIG8uYWJvcnQoZSksIFQoMCwgZSksIHRoaXMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBkLnByb21pc2UoeCksIHguc3VjY2VzcyA9IHguZG9uZSwgeC5lcnJvciA9IHguZmFpbCwgeC5jb21wbGV0ZSA9IG0uYWRkLCB4LnN0YXR1c0NvZGUgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0OwogICAgICAgICAgICAgICAgICAgIGlmIChFIDwgMikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh0IGluIGUpIGdbdF0gPSBbZ1t0XSwgZVt0XV07CiAgICAgICAgICAgICAgICAgICAgZWxzZSB0ID0gZVt4LnN0YXR1c10sIHguYWx3YXlzKHQpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcwogICAgICAgICAgICB9LCBjLnVybCA9ICgoZSB8fCBjLnVybCkgKyAiIikucmVwbGFjZShobiwgIiIpLnJlcGxhY2UobW4sIGxuWzFdICsgIi8vIiksIGMuZGF0YVR5cGVzID0gdi50cmltKGMuZGF0YVR5cGUgfHwgIioiKS50b0xvd2VyQ2FzZSgpLnNwbGl0KHkpLCBjLmNyb3NzRG9tYWluID09IG51bGwgJiYgKGEgPSB3bi5leGVjKGMudXJsLnRvTG93ZXJDYXNlKCkpLCBjLmNyb3NzRG9tYWluID0gISghYSB8fCBhWzFdID09PSBsblsxXSAmJiBhWzJdID09PSBsblsyXSAmJiAoYVszXSB8fCAoYVsxXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzKSkgPT0gKGxuWzNdIHx8IChsblsxXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzKSkpKSwgYy5kYXRhICYmIGMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIGMuZGF0YSAhPSAic3RyaW5nIiAmJiAoYy5kYXRhID0gdi5wYXJhbShjLmRhdGEsIGMudHJhZGl0aW9uYWwpKSwga24oU24sIGMsIG4sIHgpOwogICAgICAgICAgICBpZiAoRSA9PT0gMikgcmV0dXJuIHg7CiAgICAgICAgICAgIGYgPSBjLmdsb2JhbCwgYy50eXBlID0gYy50eXBlLnRvVXBwZXJDYXNlKCksIGMuaGFzQ29udGVudCA9ICF2bi50ZXN0KGMudHlwZSksIGYgJiYgdi5hY3RpdmUrKyA9PT0gMCAmJiB2LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwogICAgICAgICAgICBpZiAoIWMuaGFzQ29udGVudCkgewogICAgICAgICAgICAgICAgYy5kYXRhICYmIChjLnVybCArPSAoZ24udGVzdChjLnVybCkgPyAiJiIgOiAiPyIpICsgYy5kYXRhLCBkZWxldGUgYy5kYXRhKSwgciA9IGMudXJsOwogICAgICAgICAgICAgICAgaWYgKGMuY2FjaGUgPT09ICExKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIE4gPSB2Lm5vdygpLAogICAgICAgICAgICAgICAgICAgICAgICBDID0gYy51cmwucmVwbGFjZShibiwgIiQxXz0iICsgTik7CiAgICAgICAgICAgICAgICAgICAgYy51cmwgPSBDICsgKEMgPT09IGMudXJsID8gKGduLnRlc3QoYy51cmwpID8gIiYiIDogIj8iKSArICJfPSIgKyBOIDogIiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0oYy5kYXRhICYmIGMuaGFzQ29udGVudCAmJiBjLmNvbnRlbnRUeXBlICE9PSAhMSB8fCBuLmNvbnRlbnRUeXBlKSAmJiB4LnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsIGMuY29udGVudFR5cGUpLCBjLmlmTW9kaWZpZWQgJiYgKHIgPSByIHx8IGMudXJsLCB2Lmxhc3RNb2RpZmllZFtyXSAmJiB4LnNldFJlcXVlc3RIZWFkZXIoIklmLU1vZGlmaWVkLVNpbmNlIiwgdi5sYXN0TW9kaWZpZWRbcl0pLCB2LmV0YWdbcl0gJiYgeC5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Ob25lLU1hdGNoIiwgdi5ldGFnW3JdKSksIHguc2V0UmVxdWVzdEhlYWRlcigiQWNjZXB0IiwgYy5kYXRhVHlwZXNbMF0gJiYgYy5hY2NlcHRzW2MuZGF0YVR5cGVzWzBdXSA/IGMuYWNjZXB0c1tjLmRhdGFUeXBlc1swXV0gKyAoYy5kYXRhVHlwZXNbMF0gIT09ICIqIiA/ICIsICIgKyBUbiArICI7IHE9MC4wMSIgOiAiIikgOiBjLmFjY2VwdHNbIioiXSk7CiAgICAgICAgICAgIGZvciAobCBpbiBjLmhlYWRlcnMpIHguc2V0UmVxdWVzdEhlYWRlcihsLCBjLmhlYWRlcnNbbF0pOwogICAgICAgICAgICBpZiAoIWMuYmVmb3JlU2VuZCB8fCBjLmJlZm9yZVNlbmQuY2FsbChoLCB4LCBjKSAhPT0gITEgJiYgRSAhPT0gMikgewogICAgICAgICAgICAgICAgUyA9ICJhYm9ydCI7CiAgICAgICAgICAgICAgICBmb3IgKGwgaW4gewogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiAxLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogMSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IDEKICAgICAgICAgICAgICAgICAgICB9KSB4W2xdKGNbbF0pOwogICAgICAgICAgICAgICAgbyA9IGtuKHhuLCBjLCBuLCB4KTsKICAgICAgICAgICAgICAgIGlmICghbykgVCgtMSwgIk5vIFRyYW5zcG9ydCIpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeC5yZWFkeVN0YXRlID0gMSwgZiAmJiBwLnRyaWdnZXIoImFqYXhTZW5kIiwgW3gsIGNdKSwgYy5hc3luYyAmJiBjLnRpbWVvdXQgPiAwICYmICh1ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeC5hYm9ydCgidGltZW91dCIpCiAgICAgICAgICAgICAgICAgICAgfSwgYy50aW1lb3V0KSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgRSA9IDEsIG8uc2VuZChiLCBUKQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoRSA8IDIpKSB0aHJvdyBrOwogICAgICAgICAgICAgICAgICAgICAgICBUKC0xLCBrKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB4CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHguYWJvcnQoKQogICAgICAgIH0sCiAgICAgICAgYWN0aXZlOiAwLAogICAgICAgIGxhc3RNb2RpZmllZDoge30sCiAgICAgICAgZXRhZzoge30KICAgIH0pOwogICAgdmFyIE1uID0gW10sCiAgICAgICAgX24gPSAvXD8vLAogICAgICAgIERuID0gLyg9KVw/KD89JnwkKXxcP1w/LywKICAgICAgICBQbiA9IHYubm93KCk7CiAgICB2LmFqYXhTZXR1cCh7CiAgICAgICAganNvbnA6ICJjYWxsYmFjayIsCiAgICAgICAganNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBlID0gTW4ucG9wKCkgfHwgdi5leHBhbmRvICsgIl8iICsgUG4rKzsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbZV0gPSAhMCwgZQogICAgICAgIH0KICAgIH0pLCB2LmFqYXhQcmVmaWx0ZXIoImpzb24ganNvbnAiLCBmdW5jdGlvbihuLCByLCBpKSB7CiAgICAgICAgdmFyIHMsIG8sIHUsIGEgPSBuLmRhdGEsCiAgICAgICAgICAgIGYgPSBuLnVybCwKICAgICAgICAgICAgbCA9IG4uanNvbnAgIT09ICExLAogICAgICAgICAgICBjID0gbCAmJiBEbi50ZXN0KGYpLAogICAgICAgICAgICBoID0gbCAmJiAhYyAmJiB0eXBlb2YgYSA9PSAic3RyaW5nIiAmJiAhKG4uY29udGVudFR5cGUgfHwgIiIpLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpICYmIERuLnRlc3QoYSk7CiAgICAgICAgaWYgKG4uZGF0YVR5cGVzWzBdID09PSAianNvbnAiIHx8IGMgfHwgaCkgcmV0dXJuIHMgPSBuLmpzb25wQ2FsbGJhY2sgPSB2LmlzRnVuY3Rpb24obi5qc29ucENhbGxiYWNrKSA/IG4uanNvbnBDYWxsYmFjaygpIDogbi5qc29ucENhbGxiYWNrLCBvID0gZVtzXSwgYyA/IG4udXJsID0gZi5yZXBsYWNlKERuLCAiJDEiICsgcykgOiBoID8gbi5kYXRhID0gYS5yZXBsYWNlKERuLCAiJDEiICsgcykgOiBsICYmIChuLnVybCArPSAoX24udGVzdChmKSA/ICImIiA6ICI/IikgKyBuLmpzb25wICsgIj0iICsgcyksIG4uY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdSB8fCB2LmVycm9yKHMgKyAiIHdhcyBub3QgY2FsbGVkIiksIHVbMF0KICAgICAgICB9LCBuLmRhdGFUeXBlc1swXSA9ICJqc29uIiwgZVtzXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1ID0gYXJndW1lbnRzCiAgICAgICAgfSwgaS5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVbc10gPSBvLCBuW3NdICYmIChuLmpzb25wQ2FsbGJhY2sgPSByLmpzb25wQ2FsbGJhY2ssIE1uLnB1c2gocykpLCB1ICYmIHYuaXNGdW5jdGlvbihvKSAmJiBvKHVbMF0pLCB1ID0gbyA9IHQKICAgICAgICB9KSwgInNjcmlwdCIKICAgIH0pLCB2LmFqYXhTZXR1cCh7CiAgICAgICAgYWNjZXB0czogewogICAgICAgICAgICBzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCIKICAgICAgICB9LAogICAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogL2phdmFzY3JpcHR8ZWNtYXNjcmlwdC8KICAgICAgICB9LAogICAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAgICAgInRleHQgc2NyaXB0IjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHYuZ2xvYmFsRXZhbChlKSwgZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksIHYuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24oZSkgewogICAgICAgIGUuY2FjaGUgPT09IHQgJiYgKGUuY2FjaGUgPSAhMSksIGUuY3Jvc3NEb21haW4gJiYgKGUudHlwZSA9ICJHRVQiLCBlLmdsb2JhbCA9ICExKQogICAgfSksIHYuYWpheFRyYW5zcG9ydCgic2NyaXB0IiwgZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlLmNyb3NzRG9tYWluKSB7CiAgICAgICAgICAgIHZhciBuLCByID0gaS5oZWFkIHx8IGkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSB8fCBpLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHNlbmQ6IGZ1bmN0aW9uKHMsIG8pIHsKICAgICAgICAgICAgICAgICAgICBuID0gaS5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKSwgbi5hc3luYyA9ICJhc3luYyIsIGUuc2NyaXB0Q2hhcnNldCAmJiAobi5jaGFyc2V0ID0gZS5zY3JpcHRDaGFyc2V0KSwgbi5zcmMgPSBlLnVybCwgbi5vbmxvYWQgPSBuLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGUsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgfHwgIW4ucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KG4ucmVhZHlTdGF0ZSkpIG4ub25sb2FkID0gbi5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsLCByICYmIG4ucGFyZW50Tm9kZSAmJiByLnJlbW92ZUNoaWxkKG4pLCBuID0gdCwgaSB8fCBvKDIwMCwgInN1Y2Nlc3MiKQogICAgICAgICAgICAgICAgICAgIH0sIHIuaW5zZXJ0QmVmb3JlKG4sIHIuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgbiAmJiBuLm9ubG9hZCgwLCAxKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CiAgICB2YXIgSG4sIEJuID0gZS5BY3RpdmVYT2JqZWN0ID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvciAodmFyIGUgaW4gSG4pIEhuW2VdKDAsIDEpCiAgICAgICAgfSA6ICExLAogICAgICAgIGpuID0gMDsKICAgIHYuYWpheFNldHRpbmdzLnhociA9IGUuQWN0aXZlWE9iamVjdCA/IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuaXNMb2NhbCAmJiBGbigpIHx8IEluKCkKICAgICAgICB9IDogRm4sCiAgICAgICAgZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2LmV4dGVuZCh2LnN1cHBvcnQsIHsKICAgICAgICAgICAgICAgIGFqYXg6ICEhZSwKICAgICAgICAgICAgICAgIGNvcnM6ICEhZSAmJiAid2l0aENyZWRlbnRpYWxzIiBpbiBlCiAgICAgICAgICAgIH0pCiAgICAgICAgfSh2LmFqYXhTZXR0aW5ncy54aHIoKSksIHYuc3VwcG9ydC5hamF4ICYmIHYuYWpheFRyYW5zcG9ydChmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIGlmICghbi5jcm9zc0RvbWFpbiB8fCB2LnN1cHBvcnQuY29ycykgewogICAgICAgICAgICAgICAgdmFyIHI7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHNlbmQ6IGZ1bmN0aW9uKGksIHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG8sIHUsIGEgPSBuLnhocigpOwogICAgICAgICAgICAgICAgICAgICAgICBuLnVzZXJuYW1lID8gYS5vcGVuKG4udHlwZSwgbi51cmwsIG4uYXN5bmMsIG4udXNlcm5hbWUsIG4ucGFzc3dvcmQpIDogYS5vcGVuKG4udHlwZSwgbi51cmwsIG4uYXN5bmMpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobi54aHJGaWVsZHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHUgaW4gbi54aHJGaWVsZHMpIGFbdV0gPSBuLnhockZpZWxkc1t1XTsKICAgICAgICAgICAgICAgICAgICAgICAgbi5taW1lVHlwZSAmJiBhLm92ZXJyaWRlTWltZVR5cGUgJiYgYS5vdmVycmlkZU1pbWVUeXBlKG4ubWltZVR5cGUpLCAhbi5jcm9zc0RvbWFpbiAmJiAhaVsiWC1SZXF1ZXN0ZWQtV2l0aCJdICYmIChpWyJYLVJlcXVlc3RlZC1XaXRoIl0gPSAiWE1MSHR0cFJlcXVlc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodSBpbiBpKSBhLnNldFJlcXVlc3RIZWFkZXIodSwgaVt1XSkKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZikge30KICAgICAgICAgICAgICAgICAgICAgICAgYS5zZW5kKG4uaGFzQ29udGVudCAmJiBuLmRhdGEgfHwgbnVsbCksIHIgPSBmdW5jdGlvbihlLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdSwgZiwgbCwgYywgaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHIgJiYgKGkgfHwgYS5yZWFkeVN0YXRlID09PSA0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gdCwgbyAmJiAoYS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB2Lm5vb3AsIEJuICYmIGRlbGV0ZSBIbltvXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpKSBhLnJlYWR5U3RhdGUgIT09IDQgJiYgYS5hYm9ydCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHUgPSBhLnN0YXR1cywgbCA9IGEuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCksIGMgPSB7fSwgaCA9IGEucmVzcG9uc2VYTUwsIGggJiYgaC5kb2N1bWVudEVsZW1lbnQgJiYgKGMueG1sID0gaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMudGV4dCA9IGEucmVzcG9uc2VUZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChwKSB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmID0gYS5zdGF0dXNUZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IXUgJiYgbi5pc0xvY2FsICYmICFuLmNyb3NzRG9tYWluID8gdSA9IGMudGV4dCA/IDIwMCA6IDQwNCA6IHUgPT09IDEyMjMgJiYgKHUgPSAyMDQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSB8fCBzKC0xLCBkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYyAmJiBzKHUsIGYsIGMsIGwpCiAgICAgICAgICAgICAgICAgICAgICAgIH0sIG4uYXN5bmMgPyBhLnJlYWR5U3RhdGUgPT09IDQgPyBzZXRUaW1lb3V0KHIsIDApIDogKG8gPSArK2puLCBCbiAmJiAoSG4gfHwgKEhuID0ge30sIHYoZSkudW5sb2FkKEJuKSksIEhuW29dID0gciksIGEub25yZWFkeXN0YXRlY2hhbmdlID0gcikgOiByKCkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgciAmJiByKDAsIDEpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB2YXIgcW4sIFJuLCBVbiA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKICAgICAgICB6biA9IG5ldyBSZWdFeHAoIl4oPzooWy0rXSk9fCkoIiArIG0gKyAiKShbYS16JV0qKSQiLCAiaSIpLAogICAgICAgIFduID0gL3F1ZXVlSG9va3MkLywKICAgICAgICBYbiA9IFtHbl0sCiAgICAgICAgVm4gPSB7CiAgICAgICAgICAgICIqIjogW2Z1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgICAgIHZhciBuLCByLCBpID0gdGhpcy5jcmVhdGVUd2VlbihlLCB0KSwKICAgICAgICAgICAgICAgICAgICBzID0gem4uZXhlYyh0KSwKICAgICAgICAgICAgICAgICAgICBvID0gaS5jdXIoKSwKICAgICAgICAgICAgICAgICAgICB1ID0gK28gfHwgMCwKICAgICAgICAgICAgICAgICAgICBhID0gMSwKICAgICAgICAgICAgICAgICAgICBmID0gMjA7CiAgICAgICAgICAgICAgICBpZiAocykgewogICAgICAgICAgICAgICAgICAgIG4gPSArc1syXSwgciA9IHNbM10gfHwgKHYuY3NzTnVtYmVyW2VdID8gIiIgOiAicHgiKTsKICAgICAgICAgICAgICAgICAgICBpZiAociAhPT0gInB4IiAmJiB1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHUgPSB2LmNzcyhpLmVsZW0sIGUsICEwKSB8fCBuIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvIGEgPSBhIHx8ICIuNSIsIHUgLz0gYSwgdi5zdHlsZShpLmVsZW0sIGUsIHUgKyByKTsgd2hpbGUgKGEgIT09IChhID0gaS5jdXIoKSAvIG8pICYmIGEgIT09IDEgJiYgLS1mKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpLnVuaXQgPSByLCBpLnN0YXJ0ID0gdSwgaS5lbmQgPSBzWzFdID8gdSArIChzWzFdICsgMSkgKiBuIDogbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGkKICAgICAgICAgICAgfV0KICAgICAgICB9OwogICAgdi5BbmltYXRpb24gPSB2LmV4dGVuZChLbiwgewogICAgICAgIHR3ZWVuZXI6IGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICAgICAgdi5pc0Z1bmN0aW9uKGUpID8gKHQgPSBlLCBlID0gWyIqIl0pIDogZSA9IGUuc3BsaXQoIiAiKTsKICAgICAgICAgICAgdmFyIG4sIHIgPSAwLAogICAgICAgICAgICAgICAgaSA9IGUubGVuZ3RoOwogICAgICAgICAgICBmb3IgKDsgciA8IGk7IHIrKykgbiA9IGVbcl0sIFZuW25dID0gVm5bbl0gfHwgW10sIFZuW25dLnVuc2hpZnQodCkKICAgICAgICB9LAogICAgICAgIHByZWZpbHRlcjogZnVuY3Rpb24oZSwgdCkgewogICAgICAgICAgICB0ID8gWG4udW5zaGlmdChlKSA6IFhuLnB1c2goZSkKICAgICAgICB9CiAgICB9KSwgdi5Ud2VlbiA9IFluLCBZbi5wcm90b3R5cGUgPSB7CiAgICAgICAgY29uc3RydWN0b3I6IFluLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKGUsIHQsIG4sIHIsIGksIHMpIHsKICAgICAgICAgICAgdGhpcy5lbGVtID0gZSwgdGhpcy5wcm9wID0gbiwgdGhpcy5lYXNpbmcgPSBpIHx8ICJzd2luZyIsIHRoaXMub3B0aW9ucyA9IHQsIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCksIHRoaXMuZW5kID0gciwgdGhpcy51bml0ID0gcyB8fCAodi5jc3NOdW1iZXJbbl0gPyAiIiA6ICJweCIpCiAgICAgICAgfSwKICAgICAgICBjdXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZSA9IFluLnByb3BIb29rc1t0aGlzLnByb3BdOwogICAgICAgICAgICByZXR1cm4gZSAmJiBlLmdldCA/IGUuZ2V0KHRoaXMpIDogWW4ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCh0aGlzKQogICAgICAgIH0sCiAgICAgICAgcnVuOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0LCBuID0gWW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZHVyYXRpb24gPyB0aGlzLnBvcyA9IHQgPSB2LmVhc2luZ1t0aGlzLmVhc2luZ10oZSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogZSwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKSA6IHRoaXMucG9zID0gdCA9IGUsIHRoaXMubm93ID0gKHRoaXMuZW5kIC0gdGhpcy5zdGFydCkgKiB0ICsgdGhpcy5zdGFydCwgdGhpcy5vcHRpb25zLnN0ZXAgJiYgdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCh0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzKSwgbiAmJiBuLnNldCA/IG4uc2V0KHRoaXMpIDogWW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKSwgdGhpcwogICAgICAgIH0KICAgIH0sIFluLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IFluLnByb3RvdHlwZSwgWW4ucHJvcEhvb2tzID0gewogICAgICAgIF9kZWZhdWx0OiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gZS5lbGVtW2UucHJvcF0gPT0gbnVsbCB8fCAhIWUuZWxlbS5zdHlsZSAmJiBlLmVsZW0uc3R5bGVbZS5wcm9wXSAhPSBudWxsID8gKHQgPSB2LmNzcyhlLmVsZW0sIGUucHJvcCwgITEsICIiKSwgIXQgfHwgdCA9PT0gImF1dG8iID8gMCA6IHQpIDogZS5lbGVtW2UucHJvcF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2LmZ4LnN0ZXBbZS5wcm9wXSA/IHYuZnguc3RlcFtlLnByb3BdKGUpIDogZS5lbGVtLnN0eWxlICYmIChlLmVsZW0uc3R5bGVbdi5jc3NQcm9wc1tlLnByb3BdXSAhPSBudWxsIHx8IHYuY3NzSG9va3NbZS5wcm9wXSkgPyB2LnN0eWxlKGUuZWxlbSwgZS5wcm9wLCBlLm5vdyArIGUudW5pdCkgOiBlLmVsZW1bZS5wcm9wXSA9IGUubm93CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBZbi5wcm9wSG9va3Muc2Nyb2xsVG9wID0gWW4ucHJvcEhvb2tzLnNjcm9sbExlZnQgPSB7CiAgICAgICAgc2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGUuZWxlbS5ub2RlVHlwZSAmJiBlLmVsZW0ucGFyZW50Tm9kZSAmJiAoZS5lbGVtW2UucHJvcF0gPSBlLm5vdykKICAgICAgICB9CiAgICB9LCB2LmVhY2goWyJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIl0sIGZ1bmN0aW9uKGUsIHQpIHsKICAgICAgICB2YXIgbiA9IHYuZm5bdF07CiAgICAgICAgdi5mblt0XSA9IGZ1bmN0aW9uKHIsIGksIHMpIHsKICAgICAgICAgICAgcmV0dXJuIHIgPT0gbnVsbCB8fCB0eXBlb2YgciA9PSAiYm9vbGVhbiIgfHwgIWUgJiYgdi5pc0Z1bmN0aW9uKHIpICYmIHYuaXNGdW5jdGlvbihpKSA/IG4uYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXMuYW5pbWF0ZShabih0LCAhMCksIHIsIGksIHMpCiAgICAgICAgfQogICAgfSksIHYuZm4uZXh0ZW5kKHsKICAgICAgICBmYWRlVG86IGZ1bmN0aW9uKGUsIHQsIG4sIHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKEd0KS5jc3MoIm9wYWNpdHkiLCAwKS5zaG93KCkuZW5kKCkuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICBvcGFjaXR5OiB0CiAgICAgICAgICAgIH0sIGUsIG4sIHIpCiAgICAgICAgfSwKICAgICAgICBhbmltYXRlOiBmdW5jdGlvbihlLCB0LCBuLCByKSB7CiAgICAgICAgICAgIHZhciBpID0gdi5pc0VtcHR5T2JqZWN0KGUpLAogICAgICAgICAgICAgICAgcyA9IHYuc3BlZWQodCwgbiwgciksCiAgICAgICAgICAgICAgICBvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBLbih0aGlzLCB2LmV4dGVuZCh7fSwgZSksIHMpOwogICAgICAgICAgICAgICAgICAgIGkgJiYgdC5zdG9wKCEwKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGkgfHwgcy5xdWV1ZSA9PT0gITEgPyB0aGlzLmVhY2gobykgOiB0aGlzLnF1ZXVlKHMucXVldWUsIG8pCiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbihlLCBuLCByKSB7CiAgICAgICAgICAgIHZhciBpID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBlLnN0b3A7CiAgICAgICAgICAgICAgICBkZWxldGUgZS5zdG9wLCB0KHIpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgZSAhPSAic3RyaW5nIiAmJiAociA9IG4sIG4gPSBlLCBlID0gdCksIG4gJiYgZSAhPT0gITEgJiYgdGhpcy5xdWV1ZShlIHx8ICJmeCIsIFtdKSwgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSAhMCwKICAgICAgICAgICAgICAgICAgICBuID0gZSAhPSBudWxsICYmIGUgKyAicXVldWVIb29rcyIsCiAgICAgICAgICAgICAgICAgICAgcyA9IHYudGltZXJzLAogICAgICAgICAgICAgICAgICAgIG8gPSB2Ll9kYXRhKHRoaXMpOwogICAgICAgICAgICAgICAgaWYgKG4pIG9bbl0gJiYgb1tuXS5zdG9wICYmIGkob1tuXSk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgZm9yIChuIGluIG8pIG9bbl0gJiYgb1tuXS5zdG9wICYmIFduLnRlc3QobikgJiYgaShvW25dKTsKICAgICAgICAgICAgICAgIGZvciAobiA9IHMubGVuZ3RoOyBuLS07KSBzW25dLmVsZW0gPT09IHRoaXMgJiYgKGUgPT0gbnVsbCB8fCBzW25dLnF1ZXVlID09PSBlKSAmJiAoc1tuXS5hbmltLnN0b3AociksIHQgPSAhMSwgcy5zcGxpY2UobiwgMSkpOwogICAgICAgICAgICAgICAgKHQgfHwgIXIpICYmIHYuZGVxdWV1ZSh0aGlzLCBlKQogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0pLCB2LmVhY2goewogICAgICAgIHNsaWRlRG93bjogWm4oInNob3ciKSwKICAgICAgICBzbGlkZVVwOiBabigiaGlkZSIpLAogICAgICAgIHNsaWRlVG9nZ2xlOiBabigidG9nZ2xlIiksCiAgICAgICAgZmFkZUluOiB7CiAgICAgICAgICAgIG9wYWNpdHk6ICJzaG93IgogICAgICAgIH0sCiAgICAgICAgZmFkZU91dDogewogICAgICAgICAgICBvcGFjaXR5OiAiaGlkZSIKICAgICAgICB9LAogICAgICAgIGZhZGVUb2dnbGU6IHsKICAgICAgICAgICAgb3BhY2l0eTogInRvZ2dsZSIKICAgICAgICB9CiAgICB9LCBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgdi5mbltlXSA9IGZ1bmN0aW9uKGUsIG4sIHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZSh0LCBlLCBuLCByKQogICAgICAgIH0KICAgIH0pLCB2LnNwZWVkID0gZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgIHZhciByID0gZSAmJiB0eXBlb2YgZSA9PSAib2JqZWN0IiA/IHYuZXh0ZW5kKHt9LCBlKSA6IHsKICAgICAgICAgICAgY29tcGxldGU6IG4gfHwgIW4gJiYgdCB8fCB2LmlzRnVuY3Rpb24oZSkgJiYgZSwKICAgICAgICAgICAgZHVyYXRpb246IGUsCiAgICAgICAgICAgIGVhc2luZzogbiAmJiB0IHx8IHQgJiYgIXYuaXNGdW5jdGlvbih0KSAmJiB0CiAgICAgICAgfTsKICAgICAgICByLmR1cmF0aW9uID0gdi5meC5vZmYgPyAwIDogdHlwZW9mIHIuZHVyYXRpb24gPT0gIm51bWJlciIgPyByLmR1cmF0aW9uIDogci5kdXJhdGlvbiBpbiB2LmZ4LnNwZWVkcyA/IHYuZnguc3BlZWRzW3IuZHVyYXRpb25dIDogdi5meC5zcGVlZHMuX2RlZmF1bHQ7CiAgICAgICAgaWYgKHIucXVldWUgPT0gbnVsbCB8fCByLnF1ZXVlID09PSAhMCkgci5xdWV1ZSA9ICJmeCI7CiAgICAgICAgcmV0dXJuIHIub2xkID0gci5jb21wbGV0ZSwgci5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2LmlzRnVuY3Rpb24oci5vbGQpICYmIHIub2xkLmNhbGwodGhpcyksIHIucXVldWUgJiYgdi5kZXF1ZXVlKHRoaXMsIHIucXVldWUpCiAgICAgICAgfSwgcgogICAgfSwgdi5lYXNpbmcgPSB7CiAgICAgICAgbGluZWFyOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHJldHVybiBlCiAgICAgICAgfSwKICAgICAgICBzd2luZzogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gLjUgLSBNYXRoLmNvcyhlICogTWF0aC5QSSkgLyAyCiAgICAgICAgfQogICAgfSwgdi50aW1lcnMgPSBbXSwgdi5meCA9IFluLnByb3RvdHlwZS5pbml0LCB2LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZSwgbiA9IHYudGltZXJzLAogICAgICAgICAgICByID0gMDsKICAgICAgICBxbiA9IHYubm93KCk7CiAgICAgICAgZm9yICg7IHIgPCBuLmxlbmd0aDsgcisrKSBlID0gbltyXSwgIWUoKSAmJiBuW3JdID09PSBlICYmIG4uc3BsaWNlKHItLSwgMSk7CiAgICAgICAgbi5sZW5ndGggfHwgdi5meC5zdG9wKCksIHFuID0gdAogICAgfSwgdi5meC50aW1lciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBlKCkgJiYgdi50aW1lcnMucHVzaChlKSAmJiAhUm4gJiYgKFJuID0gc2V0SW50ZXJ2YWwodi5meC50aWNrLCB2LmZ4LmludGVydmFsKSkKICAgIH0sIHYuZnguaW50ZXJ2YWwgPSAxMywgdi5meC5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJJbnRlcnZhbChSbiksIFJuID0gbnVsbAogICAgfSwgdi5meC5zcGVlZHMgPSB7CiAgICAgICAgc2xvdzogNjAwLAogICAgICAgIGZhc3Q6IDIwMCwKICAgICAgICBfZGVmYXVsdDogNDAwCiAgICB9LCB2LmZ4LnN0ZXAgPSB7fSwgdi5leHByICYmIHYuZXhwci5maWx0ZXJzICYmICh2LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICByZXR1cm4gdi5ncmVwKHYudGltZXJzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgIHJldHVybiBlID09PSB0LmVsZW0KICAgICAgICB9KS5sZW5ndGgKICAgIH0pOwogICAgdmFyIGVyID0gL14oPzpib2R5fGh0bWwpJC9pOwogICAgdi5mbi5vZmZzZXQgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBlID09PSB0ID8gdGhpcyA6IHRoaXMuZWFjaChmdW5jdGlvbih0KSB7CiAgICAgICAgICAgIHYub2Zmc2V0LnNldE9mZnNldCh0aGlzLCBlLCB0KQogICAgICAgIH0pOwogICAgICAgIHZhciBuLCByLCBpLCBzLCBvLCB1LCBhLCBmID0gewogICAgICAgICAgICAgICAgdG9wOiAwLAogICAgICAgICAgICAgICAgbGVmdDogMAogICAgICAgICAgICB9LAogICAgICAgICAgICBsID0gdGhpc1swXSwKICAgICAgICAgICAgYyA9IGwgJiYgbC5vd25lckRvY3VtZW50OwogICAgICAgIGlmICghYykgcmV0dXJuOwogICAgICAgIHJldHVybiAociA9IGMuYm9keSkgPT09IGwgPyB2Lm9mZnNldC5ib2R5T2Zmc2V0KGwpIDogKG4gPSBjLmRvY3VtZW50RWxlbWVudCwgdi5jb250YWlucyhuLCBsKSA/ICh0eXBlb2YgbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT0gInVuZGVmaW5lZCIgJiYgKGYgPSBsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKSwgaSA9IHRyKGMpLCBzID0gbi5jbGllbnRUb3AgfHwgci5jbGllbnRUb3AgfHwgMCwgbyA9IG4uY2xpZW50TGVmdCB8fCByLmNsaWVudExlZnQgfHwgMCwgdSA9IGkucGFnZVlPZmZzZXQgfHwgbi5zY3JvbGxUb3AsIGEgPSBpLnBhZ2VYT2Zmc2V0IHx8IG4uc2Nyb2xsTGVmdCwgewogICAgICAgICAgICB0b3A6IGYudG9wICsgdSAtIHMsCiAgICAgICAgICAgIGxlZnQ6IGYubGVmdCArIGEgLSBvCiAgICAgICAgfSkgOiBmKQogICAgfSwgdi5vZmZzZXQgPSB7CiAgICAgICAgYm9keU9mZnNldDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgdCA9IGUub2Zmc2V0VG9wLAogICAgICAgICAgICAgICAgbiA9IGUub2Zmc2V0TGVmdDsKICAgICAgICAgICAgcmV0dXJuIHYuc3VwcG9ydC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCAmJiAodCArPSBwYXJzZUZsb2F0KHYuY3NzKGUsICJtYXJnaW5Ub3AiKSkgfHwgMCwgbiArPSBwYXJzZUZsb2F0KHYuY3NzKGUsICJtYXJnaW5MZWZ0IikpIHx8IDApLCB7CiAgICAgICAgICAgICAgICB0b3A6IHQsCiAgICAgICAgICAgICAgICBsZWZ0OiBuCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHNldE9mZnNldDogZnVuY3Rpb24oZSwgdCwgbikgewogICAgICAgICAgICB2YXIgciA9IHYuY3NzKGUsICJwb3NpdGlvbiIpOwogICAgICAgICAgICByID09PSAic3RhdGljIiAmJiAoZS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSIpOwogICAgICAgICAgICB2YXIgaSA9IHYoZSksCiAgICAgICAgICAgICAgICBzID0gaS5vZmZzZXQoKSwKICAgICAgICAgICAgICAgIG8gPSB2LmNzcyhlLCAidG9wIiksCiAgICAgICAgICAgICAgICB1ID0gdi5jc3MoZSwgImxlZnQiKSwKICAgICAgICAgICAgICAgIGEgPSAociA9PT0gImFic29sdXRlIiB8fCByID09PSAiZml4ZWQiKSAmJiB2LmluQXJyYXkoImF1dG8iLCBbbywgdV0pID4gLTEsCiAgICAgICAgICAgICAgICBmID0ge30sCiAgICAgICAgICAgICAgICBsID0ge30sCiAgICAgICAgICAgICAgICBjLCBoOwogICAgICAgICAgICBhID8gKGwgPSBpLnBvc2l0aW9uKCksIGMgPSBsLnRvcCwgaCA9IGwubGVmdCkgOiAoYyA9IHBhcnNlRmxvYXQobykgfHwgMCwgaCA9IHBhcnNlRmxvYXQodSkgfHwgMCksIHYuaXNGdW5jdGlvbih0KSAmJiAodCA9IHQuY2FsbChlLCBuLCBzKSksIHQudG9wICE9IG51bGwgJiYgKGYudG9wID0gdC50b3AgLSBzLnRvcCArIGMpLCB0LmxlZnQgIT0gbnVsbCAmJiAoZi5sZWZ0ID0gdC5sZWZ0IC0gcy5sZWZ0ICsgaCksICJ1c2luZyIgaW4gdCA/IHQudXNpbmcuY2FsbChlLCBmKSA6IGkuY3NzKGYpCiAgICAgICAgfQogICAgfSwgdi5mbi5leHRlbmQoewogICAgICAgIHBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzWzBdKSByZXR1cm47CiAgICAgICAgICAgIHZhciBlID0gdGhpc1swXSwKICAgICAgICAgICAgICAgIHQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAogICAgICAgICAgICAgICAgbiA9IHRoaXMub2Zmc2V0KCksCiAgICAgICAgICAgICAgICByID0gZXIudGVzdCh0WzBdLm5vZGVOYW1lKSA/IHsKICAgICAgICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgICAgICAgbGVmdDogMAogICAgICAgICAgICAgICAgfSA6IHQub2Zmc2V0KCk7CiAgICAgICAgICAgIHJldHVybiBuLnRvcCAtPSBwYXJzZUZsb2F0KHYuY3NzKGUsICJtYXJnaW5Ub3AiKSkgfHwgMCwgbi5sZWZ0IC09IHBhcnNlRmxvYXQodi5jc3MoZSwgIm1hcmdpbkxlZnQiKSkgfHwgMCwgci50b3AgKz0gcGFyc2VGbG9hdCh2LmNzcyh0WzBdLCAiYm9yZGVyVG9wV2lkdGgiKSkgfHwgMCwgci5sZWZ0ICs9IHBhcnNlRmxvYXQodi5jc3ModFswXSwgImJvcmRlckxlZnRXaWR0aCIpKSB8fCAwLCB7CiAgICAgICAgICAgICAgICB0b3A6IG4udG9wIC0gci50b3AsCiAgICAgICAgICAgICAgICBsZWZ0OiBuLmxlZnQgLSByLmxlZnQKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBpLmJvZHk7CiAgICAgICAgICAgICAgICB3aGlsZSAoZSAmJiAhZXIudGVzdChlLm5vZGVOYW1lKSAmJiB2LmNzcyhlLCAicG9zaXRpb24iKSA9PT0gInN0YXRpYyIpIGUgPSBlLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgICAgIHJldHVybiBlIHx8IGkuYm9keQogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0pLCB2LmVhY2goewogICAgICAgIHNjcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsCiAgICAgICAgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiCiAgICB9LCBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgdmFyIHIgPSAvWS8udGVzdChuKTsKICAgICAgICB2LmZuW2VdID0gZnVuY3Rpb24oaSkgewogICAgICAgICAgICByZXR1cm4gdi5hY2Nlc3ModGhpcywgZnVuY3Rpb24oZSwgaSwgcykgewogICAgICAgICAgICAgICAgdmFyIG8gPSB0cihlKTsKICAgICAgICAgICAgICAgIGlmIChzID09PSB0KSByZXR1cm4gbyA/IG4gaW4gbyA/IG9bbl0gOiBvLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFtpXSA6IGVbaV07CiAgICAgICAgICAgICAgICBvID8gby5zY3JvbGxUbyhyID8gdihvKS5zY3JvbGxMZWZ0KCkgOiBzLCByID8gcyA6IHYobykuc2Nyb2xsVG9wKCkpIDogZVtpXSA9IHMKICAgICAgICAgICAgfSwgZSwgaSwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCkKICAgICAgICB9CiAgICB9KSwgdi5lYWNoKHsKICAgICAgICBIZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgIFdpZHRoOiAid2lkdGgiCiAgICB9LCBmdW5jdGlvbihlLCBuKSB7CiAgICAgICAgdi5lYWNoKHsKICAgICAgICAgICAgcGFkZGluZzogImlubmVyIiArIGUsCiAgICAgICAgICAgIGNvbnRlbnQ6IG4sCiAgICAgICAgICAgICIiOiAib3V0ZXIiICsgZQogICAgICAgIH0sIGZ1bmN0aW9uKHIsIGkpIHsKICAgICAgICAgICAgdi5mbltpXSA9IGZ1bmN0aW9uKGksIHMpIHsKICAgICAgICAgICAgICAgIHZhciBvID0gYXJndW1lbnRzLmxlbmd0aCAmJiAociB8fCB0eXBlb2YgaSAhPSAiYm9vbGVhbiIpLAogICAgICAgICAgICAgICAgICAgIHUgPSByIHx8IChpID09PSAhMCB8fCBzID09PSAhMCA/ICJtYXJnaW4iIDogImJvcmRlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHYuYWNjZXNzKHRoaXMsIGZ1bmN0aW9uKG4sIHIsIGkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgczsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdi5pc1dpbmRvdyhuKSA/IG4uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgZV0gOiBuLm5vZGVUeXBlID09PSA5ID8gKHMgPSBuLmRvY3VtZW50RWxlbWVudCwgTWF0aC5tYXgobi5ib2R5WyJzY3JvbGwiICsgZV0sIHNbInNjcm9sbCIgKyBlXSwgbi5ib2R5WyJvZmZzZXQiICsgZV0sIHNbIm9mZnNldCIgKyBlXSwgc1siY2xpZW50IiArIGVdKSkgOiBpID09PSB0ID8gdi5jc3MobiwgciwgaSwgdSkgOiB2LnN0eWxlKG4sIHIsIGksIHUpCiAgICAgICAgICAgICAgICB9LCBuLCBvID8gaSA6IHQsIG8sIG51bGwpCiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgfSksIGUualF1ZXJ5ID0gZS4kID0gdiwgdHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgJiYgZGVmaW5lLmFtZC5halF1ZXJ5ICYmIGRlZmluZSgianF1ZXJ5IiwgW10sIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB2CiAgICB9KQp9KSh3aW5kb3cpOw=="/>
                <L7p:ResponseContentType stringValue="text/javascript; charset=UTF-8"/>
            </L7p:HardcodedResponse>
        </wsp:All>
    </wsp:Policy>
</exp:Export>
